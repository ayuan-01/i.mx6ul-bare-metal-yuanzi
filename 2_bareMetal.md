# Cè¯­è¨€çŸ¥è¯†ç‚¹ï¼Œè¾¹å­¦è¾¹è®°

#### å‡½æ•°æŒ‡é’ˆ

- å‡½æ•°æŒ‡é’ˆæ˜¯æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆã€‚å®ƒå…è®¸åŠ¨æ€åœ°è°ƒç”¨å‡½æ•°ï¼Œå³åœ¨è¿è¡Œä¸­å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚

  ```C
  typedef void (*system_irq_handler_t)(unsigned int gicciar, void *param);
  ```

  è¿™æ¡è¯­å¥å°†ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹å®šä¹‰ä¸º `system_irq_handler_t`ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªè¿”å›ç±»å‹ä¸º `void` çš„å‡½æ•°ã€‚

  **åªè¦æ»¡è¶³è¾“å…¥å‚æ•°ç±»å‹ï¼Œè¿”å›å‚æ•°ç±»å‹ä¸å‡½æ•°æŒ‡é’ˆå®šä¹‰ç›¸åŒ¹é…ï¼Œéƒ½å¯ä»¥è¢«å‡½æ•°æŒ‡é’ˆæŒ‡å‘ã€‚**

  ç¤ºä¾‹ï¼š

  ```c
  /* å®šä¹‰å‡½æ•° */
  #include <stdio.h>
  
  // å®šä¹‰ç¬¦åˆ system_irq_handler_t ç±»å‹çš„å‡½æ•°
  void my_irq_handler(unsigned int gicciar, void *param) {
      printf("IRQ Handler called with gicciar: %u, param: %p\n", gicciar, param);
  }
  
  ```

  ```C
  // å®šä¹‰å‡½æ•°æŒ‡é’ˆç±»å‹
  typedef void (*system_irq_handler_t)(unsigned int gicciar, void *param);
  ```

  ```C
  // å£°æ˜å’Œä½¿ç”¨å‡½æ•°æŒ‡é’ˆ
  int main() {
      // å£°æ˜ä¸€ä¸ª system_irq_handler_t ç±»å‹çš„å‡½æ•°æŒ‡é’ˆ
      system_irq_handler_t handler;
  
      // å°†å‡½æ•°æŒ‡é’ˆæŒ‡å‘ my_irq_handler å‡½æ•°
      handler = my_irq_handler;
  
      // è°ƒç”¨å‡½æ•°æŒ‡é’ˆ
      handler(123, (void *)0xDEADBEEF);
  
      return 0;
  }
  ```

#### å†…è”å‡½æ•°

åœ¨Cè¯­è¨€ä¸­ï¼Œ`inline`å…³é”®å­—ç”¨äºå»ºè®®ç¼–è¯‘å™¨å°†å‡½æ•°çš„ä»£ç ç›´æ¥æ’å…¥åˆ°è°ƒç”¨ç‚¹ï¼Œè€Œä¸æ˜¯é€šè¿‡å¸¸è§„çš„å‡½æ•°è°ƒç”¨æœºåˆ¶æ¥è°ƒç”¨ã€‚è¿™æ ·å¯ä»¥å‡å°‘å‡½æ•°è°ƒç”¨çš„å¼€é”€ï¼Œæ¯”å¦‚é¿å…äº†è°ƒç”¨å’Œè¿”å›æ—¶çš„æ ˆæ“ä½œï¼Œä»¥åŠå¯èƒ½çš„è·³è½¬æŒ‡ä»¤ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚

`inline` è¯¦ç»†è§£é‡Š

- **å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€**ï¼šé€šå¸¸ï¼Œå‡½æ•°è°ƒç”¨æ¶‰åŠå°†å‚æ•°å‹æ ˆã€è·³è½¬åˆ°å‡½æ•°ä»£ç ã€æ‰§è¡Œä»£ç ã€è¿”å›å¹¶æ¸…ç†æ ˆã€‚`inline`å‡½æ•°é€šè¿‡å°†å‡½æ•°ä»£ç ç›´æ¥æ’å…¥åˆ°è°ƒç”¨ç‚¹ï¼Œé¿å…äº†è¿™äº›å¼€é”€ã€‚
- **ç¼–è¯‘å™¨ä¼˜åŒ–å»ºè®®**ï¼š`inline` åªæ˜¯ä¸€ä¸ªå»ºè®®ï¼Œç¼–è¯‘å™¨å¯ä»¥é€‰æ‹©å¿½ç•¥å®ƒã€‚å¦‚æœå‡½æ•°ä½“è¿‡å¤§ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå¿½ç•¥ `inline` æç¤ºï¼Œå› ä¸ºå†…è”è¾ƒå¤§çš„å‡½æ•°å¯èƒ½ä¼šå¢åŠ ç¨‹åºçš„ä»£ç é‡ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
- **æ³¨æ„äº‹é¡¹**ï¼š
  - é€’å½’å‡½æ•°ä¸èƒ½è¢«å†…è”ï¼Œå› ä¸ºç¼–è¯‘å™¨æ— æ³•ç¡®å®šé€’å½’çš„ç»“æŸæ¡ä»¶ã€‚
  - è¿‡å¤šä½¿ç”¨ `inline` å¯èƒ½å¯¼è‡´ä»£ç è†¨èƒ€ï¼Œåè€Œé™ä½æ€§èƒ½ã€‚

#### while

```
i = 5;
while(i--) {}
```

`i` çš„å€¼ä¼šæ˜¯ 4, 3, 2, 1, 0ã€‚è§£é‡Šå¦‚ä¸‹ï¼š

- `i--` æ˜¯ä¸€ä¸ªåç¼€é€’å‡æ“ä½œç¬¦ã€‚å®ƒä¼šåœ¨æ¯æ¬¡è¿­ä»£æ—¶é¦–å…ˆä½¿ç”¨ `i` çš„å½“å‰å€¼ï¼Œç„¶åå°† `i` å‡ 1ã€‚
- å½“ `i` çš„å€¼ä¸º 5 æ—¶ï¼Œ`i--` ä¼šå…ˆå°† `i` çš„å€¼ 5 ç”¨äºåˆ¤æ–­å¾ªç¯æ¡ä»¶ï¼Œç„¶åå°† `i` å‡ 1 å˜æˆ 4ã€‚
- å¾ªç¯ä¼šç»§ç»­æ‰§è¡Œç›´åˆ° `i` çš„å€¼å˜æˆ 0ã€‚åœ¨ `i` ä¸º 0 æ—¶ï¼Œ`i--` ä¼šå°† `i` ç”¨äºåˆ¤æ–­æ¡ä»¶ï¼ˆ0ï¼‰åå†å°† `i` å‡ 1ã€‚æ­¤æ—¶ `i` å˜æˆ -1ï¼Œä½†å¾ªç¯å·²ç»ç»“æŸï¼Œå› ä¸ºåˆ¤æ–­æ¡ä»¶ `i--` åœ¨æ¯æ¬¡è¿­ä»£åä¼šä½¿ç”¨ `i` çš„å€¼ã€‚

æ‰€ä»¥ï¼Œ`i` çš„å€¼åœ¨å¾ªç¯ç»“æŸæ—¶æ˜¯ `-1`ï¼Œä½†å¾ªç¯è¿‡ç¨‹ä¸­ `i` çš„å€¼ä¸º 5, 4, 3, 2, 1, 0ã€‚

# æ­£ç‚¹åŸå­Makefileæ–‡ä»¶è¯¦è§£

```makefile
CROSS_COMPILE 	?= arm-linux-gnueabihf-		# å˜é‡ï¼Œäº¤å‰ç¼–è¯‘å·¥å…·é“¾çš„å‰ç¼€
TARGET 			?= i2c						# ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶çš„åç§°
CC				:= $(CROSS_COMPILE)gcc		# å®šä¹‰gccç¼–è¯‘å™¨
LD				:= $(CROSS_COMPILE)ld		# é“¾æ¥å™¨
OBJCOPY			:= $(CROSS_COMPILE)objcopy	# ç”Ÿæˆelfå¯æ‰§è¡Œæ–‡ä»¶
OBJDUMP			:= $(CROSS_COMPILE)objdump	# åæ±‡ç¼–

# LIBPATHï¼šé“¾æ¥å™¨çš„åº“è·¯å¾„å’Œåº“æ–‡ä»¶ã€‚åœ¨è¿™é‡ŒæŒ‡å®šäº†åº“è·¯å¾„å’Œ -lgcc é€‰é¡¹ã€‚
# å‘Šè¯‰é“¾æ¥å™¨åœ¨é“¾æ¥é˜¶æ®µéœ€è¦ä½¿ç”¨å“ªäº›åº“å’Œå“ªäº›åº“æ–‡ä»¶
# -lgcc -læ˜¯é“¾æ¥å™¨é€‰é¡¹çš„æ ‡å¿—ï¼Œè¡¨ç¤ºé“¾æ¥ä¸€ä¸ªåº“ gccæ˜¯è¦é“¾æ¥åº“çš„åç§°ï¼Œå®ƒé€šå¸¸æ˜¯GCCç¼–è¯‘å™¨è‡ªå¸¦çš„è¿è¡Œæ—¶åº“
# -L æ˜¯é“¾æ¥å™¨é€‰é¡¹çš„æ ‡å¿—ï¼Œè¡¨ç¤ºæŒ‡å®šä¸€ä¸ªåº“æ–‡ä»¶æœç´¢è·¯å¾„
# -lgccï¼šå‘Šè¯‰é“¾æ¥å™¨é“¾æ¥ GCC çš„è¿è¡Œæ—¶åº“ï¼ˆlibgccï¼‰ï¼Œè¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå®ƒæä¾›äº†ä¸€äº›åŸºæœ¬çš„æ”¯æŒåŠŸèƒ½ã€‚
# -L /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/lib/gcc/arm-linux-gnueabihf/4.9.4ï¼šæŒ‡å®šäº†ä¸€ä¸ªåº“æœç´¢è·¯å¾„ï¼Œé“¾æ¥å™¨ä¼šåœ¨è¿™ä¸ªè·¯å¾„ä¸‹æŸ¥æ‰¾ libgcc åŠå…¶ä»–åº“æ–‡ä»¶ã€‚
LIBPATH			:= -lgcc -L /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/lib/gcc/arm-linux-gnueabihf/4.9.4

# å¤´æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„
INCUDIRS		:= 	imx6u 		\
					bsp/clk		\
					bsp/delay	\
					bsp/led		\
					bsp/beep	\
					bsp/key		\
					bsp/gpio	\
					bsp/int		\
					bsp/exit	\
					bsp/epit	\
					bsp/keyfilter\
					bsp/uart	\
					bsp/lcd		\
					bsp/rtc		\
					bsp/ap3216c	\
					bsp/i2c		\
					stdio/include

# æºæ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„
SRCDIRS			:=	project		\
					bsp/clk		\
					bsp/delay	\
					bsp/led		\
					bsp/beep	\
					bsp/key		\
					bsp/gpio	\
					bsp/int		\
					bsp/exit	\
					bsp/epit	\
					bsp/keyfilter\
					bsp/uart	\
					bsp/lcd		\
					bsp/rtc		\
					bsp/ap3216c	\
					bsp/i2c		\
					stdio/lib
# è¿™ä¸ªå‡½æ•°ç”¨äºæ›¿æ¢å­—ç¬¦ä¸²ä¸­çš„æ¨¡å¼ï¼Œ%ï¼Œè¡¨ç¤ºåŒ¹é… INCUDIRS ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ã€‚å³å°†INCUDIRSä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ å‰éƒ½åŠ ä¸Š-I
# -Içš„ä½œç”¨-Ié€‰é¡¹åœ¨ç¼–è¯‘å™¨ä¸­ç”¨äºæŒ‡å®šå¤´æ–‡ä»¶çš„æœç´¢è·¯å¾„ã€‚å®ƒå‘Šè¯‰ç¼–è¯‘å™¨åœ¨å“ªé‡ŒæŸ¥æ‰¾ #include æŒ‡ä»¤ä¸­æŒ‡å®šçš„å¤´æ–‡ä»¶ã€‚
INCLUDE			:= $(patsubst %, -I %, $(INCUDIRS))

# æŸ¥æ‰¾æ‰€æœ‰æ±‡ç¼–æ–‡ä»¶å’ŒCæ–‡ä»¶ï¼ˆæ–‡ä»¶è·¯å¾„ï¼‰
# $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.S))
# foreachå‡½æ•°éå†åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ å¹¶ æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼ˆwildcardå‡½æ•°æ“ä½œï¼‰
# æŸ¥æ‰¾SRCDIRSä¸­æ¯ä¸ªè·¯å¾„å¹¶ä¸”å¤åˆ¶ç»™dir
# wildcardå‡½æ•°ç”¨äºåŒ¹é…ç¬¦åˆæŒ‡å®šæ¨¡å¼çš„æ–‡ä»¶ï¼Œæ‰¾åˆ°æ¯ä¸ªdirè·¯å¾„ä¸­çš„.Sæ–‡ä»¶

# å·¥ä½œæµç¨‹
# éå† $(SRCDIRS) å˜é‡ä¸­çš„æ¯ä¸€ä¸ªç›®å½•:
# $(foreach dir, $(SRCDIRS), ...) ä¼šä¾æ¬¡å°† $(SRCDIRS) ä¸­çš„æ¯ä¸ªç›®å½•èµ‹å€¼ç»™ dirã€‚

# å¯¹äºæ¯ä¸ªç›®å½•ï¼Œä½¿ç”¨ wildcard æŸ¥æ‰¾æ±‡ç¼–æºæ–‡ä»¶:
# $(wildcard $(dir)/*.S) æŸ¥æ‰¾å½“å‰ç›®å½• $(dir) ä¸‹æ‰€æœ‰æ‰©å±•åä¸º .S çš„æ–‡ä»¶ã€‚

# å°†æ‰€æœ‰æ‰¾åˆ°çš„æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªåˆ—è¡¨:
# foreach å‡½æ•°å°†æ¯æ¬¡ wildcard æ‰¾åˆ°çš„æ–‡ä»¶åˆ—è¡¨åˆå¹¶æˆä¸€ä¸ªå¤§çš„æ–‡ä»¶åˆ—è¡¨ï¼Œæœ€ç»ˆèµ‹å€¼ç»™ SFILES å˜é‡ã€‚
SFILES			:= $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.S))
CFILES			:= $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.c))

# è·å–æºæ–‡ä»¶çš„æ–‡ä»¶åï¼ˆä¸åŒ…æ‹¬è·¯å¾„ï¼‰
SFILENDIR		:= $(notdir $(SFILES))
CFILENDIR		:= $(notdir $(CFILES))

# å¯¹åº”çš„ç›®æ ‡æ–‡ä»¶ï¼ˆ.oï¼‰ï¼Œæ”¾åœ¨obj/ä¸‹
SOBJS			:= $(patsubst %, obj/%, $(SFILENDIR:.S=.o))
COBJS			:= $(patsubst %, obj/%, $(CFILENDIR:.c=.o))

# æ‰€æœ‰ç›®æ ‡æ–‡ä»¶åˆ—è¡¨
OBJS 			:= $(SOBJS)$(COBJS)

# æŒ‡å®šmakeæŸ¥æ‰¾æºæ–‡ä»¶çš„è·¯å¾„
VPATH			:= $(SRCDIRS)

# æ„å»ºè§„åˆ™
$(TARGET).bin: $(OBJS)
	$(LD) -Timx6u.lds -o $(TARGET).elf $^ $(LIBPATH)
	$(OBJCOPY) -O binary -S $(TARGET).elf $@
	$(OBJDUMP) -D -m arm $(TARGET).elf > $(TARGET).dis

$(COBJS): obj/%.o : %.c
	$(CC) $(INCLUDE) -Wa,-mimplicit-it=thumb -fno-builtin -c -Wall -nostdlib -O2 -o $@ $<
$(SOBJS): obj/%.o : %.S
	$(CC) $(INCLUDE) -fno-builtin -c -Wall -nostdlib -O2 -o $@ $<

.PHONY:clean
clean:
	rm -rf $(OBJS) $(TARGET).elf $(TARGET).bin $(TARGET).dis load.imx
	rm -rf *.elf *.bin *.dis load.imx

```



# å¯åŠ¨æµç¨‹

#### æ±‡ç¼–å¯åŠ¨ç¨‹åº

- è®¾ç½®ä¸­æ–­å‘é‡è¡¨

- å®šä¹‰ä¸­æ–­æœåŠ¡ç¨‹åº
  - å¤ä½ä¸­æ–­æœåŠ¡ç¨‹åº
    - å…³é—­å…¨å±€ä¸­æ–­(cpsid i)ã€‚
    - ä½¿ç”¨CP15åå¤„ç†å™¨ç®¡ç†STCLRå¯„å­˜å™¨ï¼Œå…³é—­ICacheï¼ŒDCacheï¼ŒMMUã€‚
    - **æ¸…é™¤BSSæ®µã€‚**é“¾æ¥è„šæœ¬(.lds)ä¸­è®¾ç½®BSSæ®µçš„èµ·å§‹å’Œç»ˆæ­¢åœ°å€ï¼Œä½¿ç”¨å¾ªç¯æ¸…é™¤è¿™ä¸ªåœ°å€èŒƒå›´å†…çš„æ‰€æœ‰å†…å®¹ã€‚
    - åˆ†åˆ«è®¾ç½®å¤„ç†å™¨çš„9ç§å·¥ä½œæ¨¡å¼å¹¶å®šä¹‰å¯¹åº”çš„SPæŒ‡é’ˆã€‚æŸ¥çœ‹å„ç§å·¥ä½œæ¨¡å¼ä¸‹16ä¸ªå¯„å­˜å™¨çš„å…±ç”¨æ¨¡å¼ã€‚æœ€åè®¾ç½®CPUå·¥ä½œæ¨¡å¼ä¸º**SVCæ¨¡å¼**
    - æ‰“å¼€IRQä¸­æ–­(cpsie i)ã€‚
    - è·³è½¬åˆ°mainå‡½æ•°ã€‚
    
  - ç¼–å†™IRQä¸­æ–­æœåŠ¡å‡½æ•°
  
    - 1. ä¿æŠ¤ç°åœºã€‚è§¦å‘ä¸­æ–­çš„æœºåˆ¶é¦–å…ˆä¼šä¿å­˜(push)ä¸€äº›å¯„å­˜å™¨ï¼Œä¸€äº›ä¸ä¼šè‡ªåŠ¨ä¿å­˜çš„å¯„å­˜å™¨(r0-r3, r12)éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ä¿å­˜ï¼Œ`push {lr}` ç”¨äºä¿å­˜å‡½æ•°è°ƒç”¨è¿”å›åœ°å€ã€‚
  
         ```csv
         mrs r0, spsr	// ä¿å­˜spsr
         push {r0}
         ```

      2. è¯»å–GICC_IARå¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨ä¿å­˜ç€å½“å‰å‘ç”Ÿä¸­æ–­çš„ä¸­æ–­å·ï¼Œé€šè¿‡è¿™ä¸ªä¸­æ–­å·æ¥å†³å®šæ¥è°ƒç”¨å“ªä¸ªä¸­æ–­æœåŠ¡å‡½æ•°ã€‚
  
      3. è¿›å…¥svcæ¨¡å¼ï¼Œpush {lr}ï¼Œè·³è½¬æ‰§è¡Œsystem_irqhandlerã€‚
  
      4. æ‰§è¡Œå®Œåpop {lr}ã€‚å›åˆ°irqæ¨¡å¼ã€‚
  
      5. ä¸­æ–­æ‰§è¡Œå®Œæˆï¼Œå†™GICC_EOIRå¯„å­˜å™¨ã€‚å¤„ç†å®Œå…·ä½“ä¸­æ–­åï¼Œéœ€è¦å°†å¯¹åº”çš„ä¸­æ–­IDå€¼å†™å…¥åˆ°GICC_EOIRä¸­ é€šçŸ¥GICå½“å‰å¤„ç†ä¸­æ–­å·²ç»å¤„ç†å®Œæ¯•ï¼Œå…è®¸GICåˆ†é…ä¸‹ä¸€ä¸ªä¸­æ–­ã€‚
  
      6. æ¢å¤ç°åœºã€‚
  
         ```csv
         pop {r0-r3, r12}
         subs pc, lr, #4
         /* pc = lr-4æ˜¯å› ä¸ºarmçš„æŒ‡ä»¤æ˜¯ä¸‰çº§æµæ°´çº¿ç»“æ„ï¼Œå‡å¦‚åœ¨æ‰§è¡Œ0x2000æŒ‡ä»¤æ—¶è§¦å‘ä¸­æ–­ï¼Œpcæ­¤æ—¶æ˜¯  * æŒ‡å‘0x2008çš„ï¼Œå¦‚æœä¸­æ–­ç»“æŸåè¿”å›åˆ°0x2008å¼€å§‹æ‰§è¡Œé‚£ä¹ˆå°†ä¼šæ¼æ‰ä¸€ä¸ªæŒ‡ä»¤ï¼Œè¿™ä¸ªåæœä¼šå¾ˆä¸¥é‡ */
         ```
  
  
  - Cè¯­è¨€ä¸­ç¼–å†™ä¸­æ–­ç›¸å…³å‡½æ•°ã€‚
  
    - ä¸­æ–­åˆå§‹åŒ–å‡½æ•°ã€‚
  
    - å®šä¹‰ä¸­æ–­å¤„ç†å‡½æ•°(å‡½æ•°æŒ‡é’ˆ)ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼ŒåŒ…æ‹¬iarï¼Œparamã€‚åˆ›å»ºåŒ…æ‹¬å‡½æ•°æŒ‡é’ˆå’Œå‚æ•°çš„ä¸­æ–­å¤„ç†ç»“æ„ä½“ã€‚
  
      ```C
      typedef struct _sys_irq_handler
      {
          system_irq_handler_t irqHandler;            /* ä¸­æ–­å¤„ç†å‡½æ•° */
          void *userParam;                            /* ä¸­æ–­å¤„ç†å‡½æ•°çš„å‚æ•° */
      }sys_irq_handle_t;
      ```
  
    - å®šä¹‰ä¸­æ–­å¤„ç†å‡½æ•°è¡¨(å­˜æ”¾ä¸­æ–­å¤„ç†å‡½æ•°ç»“æ„ä½“ç±»å‹çš„æ•°ç»„)ã€‚
  
      ```c
      static sys_irq_handle_t irqTable[NUMBER_OF_INT_VECTORS];            /* 160ä¸ª */
      ```
  
      ç›¸å½“äºç»™äº†160ä¸ªä¸­æ–­å¤„ç†å‡½æ•°ã€‚å¯¹åº”ç€ç›¸åº”çš„ä¸­æ–­å·ã€‚
  
    - åˆå§‹åŒ–ä¸­æ–­å¤„ç†å‡½æ•°è¡¨ã€‚
  
      ```c
      void system_irq_init(void)
      {
          unsigned int i = 0;
          irqNesting = 0;
          for (i = 0; i < NUMBER_OF_INT_VECTORS; i++)
          {
              irqTable[i].irqHandler = default_irqHandler;
              irqTable[i].userParam  = NULL;
          } 
      }
      ```
  
    - æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°
  
      ```c
      void system_register_irqhandler(IRQn_Type irq, system_irq_handler_t handler, void *userparam)
      {
          irqTable[irq].irqHandler = handler;
          irqTable[irq].userParam  = userparam;
      }
      ```
  
    - å…·ä½“çš„ä¸­æ–­å¤„ç†å‡½æ•°
  
      ```c
      void system_irqhandler(unsigned int gicciar)
      {
          /* æ£€æŸ¥ä¸­æ–­ID */
          uint32_t intNum = gicciar & 0x3ff;
          if(intNum >= NUMBER_OF_INT_VECTORS)
          {
              return;
          }
          irqNesting++;
          /* æ ¹æ®ä¸­æ–­IDå·ï¼Œè¯»å–ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œç„¶åæ‰§è¡Œ */
          irqTable[intNum].irqHandler(intNum, irqTable[intNum].userParam);
          irqNesting--;
      }
      ```
  
      

#### é“¾æ¥è„šæœ¬

##### é“¾æ¥è„šæœ¬å…·ä½“è§£é‡Š

è¿™ä¸ªä»£ç æ®µæ˜¯ä¸€ä¸ªGNU LDï¼ˆLinker Scriptï¼‰è„šæœ¬ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•å°†ç¨‹åºçš„ä¸åŒéƒ¨åˆ†å¸ƒå±€åˆ°å†…å­˜ä¸­ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªè„šæœ¬å®šä¹‰äº†å„ä¸ªæ®µï¼ˆsectionsï¼‰åœ¨å†…å­˜ä¸­çš„ä½ç½®å’Œå¯¹é½æ–¹å¼ã€‚

1. **èµ·å§‹åœ°å€è®¾ç½®**:

   ```ld
   . = 0X87800000;
   ```

   è¿™è¡Œä»£ç å°†é“¾æ¥å™¨çš„å½“å‰ä½ç½®ï¼ˆå³å†…å­˜åœ°å€ï¼‰è®¾ç½®ä¸º`0x87800000`ã€‚è¿™æ„å‘³ç€æ¥ä¸‹æ¥çš„æ‰€æœ‰æ®µéƒ½ä¼šä»è¿™ä¸ªåœ°å€å¼€å§‹æ”¾ç½®ã€‚

2. **.textæ®µ**:

   ```ld
   .text : 
   {
       obj/start.o
       *(.text)
   }
   ```

   `.text`æ®µé€šå¸¸åŒ…å«ç¨‹åºçš„ä»£ç éƒ¨åˆ†ã€‚è¿™é‡ŒæŒ‡å®šäº†`obj/start.o`æ–‡ä»¶ä¸­çš„å†…å®¹é¦–å…ˆæ”¾å…¥`.text`æ®µï¼Œç„¶åå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶ä¸­çš„`.text`æ®µå†…å®¹ä¾æ¬¡æ”¾å…¥ã€‚

3. **.rodataæ®µ**:

   ```ld
   .rodata ALIGN(4) : {*(.rodata*)}
   ```

   `.rodata`æ®µç”¨äºå­˜å‚¨åªè¯»æ•°æ®ã€‚è¿™é‡Œå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶ä¸­çš„`.rodata`æ®µå†…å®¹æ”¾å…¥ï¼Œå¹¶ä¸”å°†å…¶å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œã€‚

4. **.dataæ®µ**:

   ```ld
   .data ALIGN(4) : {*(.data)}
   ```

   `.data`æ®µç”¨äºå­˜å‚¨å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚è¿™é‡Œå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶ä¸­çš„`.data`æ®µå†…å®¹æ”¾å…¥ï¼Œå¹¶ä¸”å°†å…¶å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œã€‚

5. **å¯¹é½æŒ‡é’ˆ**:

   ```ld
   . = ALIGN(4);
   ```

   è¿™è¡Œä»£ç å°†å½“å‰ä½ç½®å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œã€‚

6. **__bss_startç¬¦å·**:

   ```ld
   __bss_start = .;
   ```

   å®šä¹‰ä¸€ä¸ªç¬¦å·`__bss_start`ï¼Œå…¶å€¼ä¸ºå½“å‰ä½ç½®ï¼ˆå³`bss`æ®µçš„èµ·å§‹åœ°å€ï¼‰ã€‚

7. **.bssæ®µ**:

   ```ld
   .bss ALIGN(4) : {*(.bss) *(common)}
   ```

   `.bss`æ®µç”¨äºå­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚è¿™é‡Œå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶ä¸­çš„`.bss`æ®µå’Œ`common`æ®µå†…å®¹æ”¾å…¥ï¼Œå¹¶ä¸”å°†å…¶å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œã€‚

8. **__bss_endç¬¦å·**:

   ```ld
   __bss_end = .;
   ```

   å®šä¹‰ä¸€ä¸ªç¬¦å·`__bss_end`ï¼Œå…¶å€¼ä¸ºå½“å‰ä½ç½®ï¼ˆå³`bss`æ®µçš„ç»“æŸåœ°å€ï¼‰ã€‚

#### CP15åå¤„ç†å™¨å¯„å­˜å™¨

CP15å¯„å­˜å™¨æ˜¯ARMæ¶æ„ä¸­çš„åå¤„ç†å™¨15å¯„å­˜å™¨ï¼Œä¸»è¦ç”¨äºé…ç½®å’Œç®¡ç†ç³»ç»Ÿæ§åˆ¶ã€å†…å­˜ç®¡ç†ã€è°ƒè¯•ç­‰åŠŸèƒ½ã€‚CP15å¯„å­˜å™¨åœ¨ARMå¤„ç†å™¨ä¸­æ‰®æ¼”ç€å…³é”®è§’è‰²ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦åŠŸèƒ½å’Œä½œç”¨ï¼š

1. **ç³»ç»Ÿæ§åˆ¶**ï¼š
   - æ§åˆ¶å¯„å­˜å™¨ï¼ˆå¦‚SCTLRï¼‰ï¼šç”¨äºé…ç½®å¤„ç†å™¨çš„è¿è¡Œæ¨¡å¼å’Œç‰¹æ€§ï¼Œä¾‹å¦‚å¯ç”¨æˆ–ç¦ç”¨ç¼“å­˜ã€MMUã€å¼‚å¸¸å¤„ç†ç­‰ã€‚
2. **å†…å­˜ç®¡ç†**ï¼š
   - TLBï¼ˆTranslation Lookaside Bufferï¼‰æ§åˆ¶ï¼šç®¡ç†TLBçš„åˆ·æ–°ã€æ— æ•ˆåŒ–ç­‰æ“ä½œã€‚
   - é¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ï¼šå­˜å‚¨é¡µè¡¨çš„åŸºåœ°å€ï¼Œç”¨äºåœ°å€è½¬æ¢ã€‚
3. **ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†**ï¼š
   - ä¸­æ–­æ§åˆ¶å¯„å­˜å™¨ï¼šé…ç½®ä¸­æ–­çš„ä¼˜å…ˆçº§ã€ä½¿èƒ½çŠ¶æ€ç­‰ã€‚
   - *å¼‚å¸¸å‘é‡è¡¨åŸºåœ°å€å¯„å­˜å™¨ï¼šæŒ‡å®šå¼‚å¸¸å‘é‡è¡¨çš„åœ°å€*ã€‚
4. **æ€§èƒ½ç›‘æ§**ï¼š
   - æ€§èƒ½ç›‘æ§å¯„å­˜å™¨ï¼šç”¨äºæ€§èƒ½è®¡æ•°ã€äº‹ä»¶ç›‘æ§ï¼Œå¸®åŠ©å¼€å‘äººå‘˜ä¼˜åŒ–ä»£ç æ€§èƒ½ã€‚
5. **è°ƒè¯•å’Œè·Ÿè¸ª**ï¼š
   - è°ƒè¯•æ§åˆ¶å¯„å­˜å™¨ï¼šé…ç½®è°ƒè¯•åŠŸèƒ½ã€æ–­ç‚¹ã€è§‚å¯Ÿç‚¹ç­‰ã€‚
   - è·Ÿè¸ªæ§åˆ¶å¯„å­˜å™¨ï¼šé…ç½®è·Ÿè¸ªåŠŸèƒ½ï¼Œç”¨äºç¨‹åºæ‰§è¡Œæµçš„è®°å½•å’Œåˆ†æã€‚
6. **ç”µæºç®¡ç†**ï¼š
   - ç”µæºæ§åˆ¶å¯„å­˜å™¨ï¼šé…ç½®ä½åŠŸè€—æ¨¡å¼ã€èŠ‚èƒ½ç‰¹æ€§ç­‰ã€‚

CP15å¯„å­˜å™¨åœ¨ARMå¤„ç†å™¨çš„è¿è¡Œå’Œç®¡ç†ä¸­å‘æŒ¥ç€é‡è¦ä½œç”¨ï¼Œä½¿ç³»ç»Ÿèƒ½å¤Ÿçµæ´»ã€é«˜æ•ˆåœ°è¿›è¡Œé…ç½®å’Œæ§åˆ¶ã€‚



#### SCTLRå¯„å­˜å™¨

SCTLRï¼ˆSystem Control Registerï¼‰æ˜¯ARMæ¶æ„ä¸­çš„ä¸€ä¸ªé‡è¦å¯„å­˜å™¨ï¼Œä½äºCP15åå¤„ç†å™¨ä¸­ã€‚å®ƒç”¨äºæ§åˆ¶å¤„ç†å™¨çš„å„ç§ç³»ç»Ÿçº§ç‰¹æ€§å’Œæ“ä½œæ¨¡å¼ã€‚SCTLRçš„ä½œç”¨éå¸¸å¹¿æ³›ï¼Œä¸‹é¢æ˜¯å…¶ä¸»è¦åŠŸèƒ½å’Œæ§åˆ¶ä½ï¼š

1. **MMUå¯ç”¨**ï¼š
   - Mä½ï¼šæ§åˆ¶MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰çš„å¯ç”¨å’Œç¦ç”¨ã€‚
     - 0ï¼šç¦ç”¨MMU
     - 1ï¼šå¯ç”¨MMU
2. **å¯¹é½æ£€æŸ¥**ï¼š
   - Aä½ï¼šæ§åˆ¶æœªå¯¹é½æ•°æ®è®¿é—®çš„æ£€æŸ¥ã€‚
     - 0ï¼šç¦ç”¨å¯¹é½æ£€æŸ¥
     - 1ï¼šå¯ç”¨å¯¹é½æ£€æŸ¥
3. **æ•°æ®ç¼“å­˜å¯ç”¨**ï¼š
   - Cä½ï¼šæ§åˆ¶æ•°æ®ç¼“å­˜çš„å¯ç”¨å’Œç¦ç”¨ã€‚
     - 0ï¼šç¦ç”¨æ•°æ®ç¼“å­˜
     - 1ï¼šå¯ç”¨æ•°æ®ç¼“å­˜
4. **æŒ‡ä»¤ç¼“å­˜å¯ç”¨**ï¼š
   - Iä½ï¼šæ§åˆ¶æŒ‡ä»¤ç¼“å­˜çš„å¯ç”¨å’Œç¦ç”¨ã€‚
     - 0ï¼šç¦ç”¨æŒ‡ä»¤ç¼“å­˜
     - 1ï¼šå¯ç”¨æŒ‡ä»¤ç¼“å­˜
5. **ç³»ç»Ÿä¿æŠ¤**ï¼š
   - Sä½ï¼šé…ç½®ç³»ç»Ÿä¿æŠ¤ï¼Œä½¿ç³»ç»ŸåŒºå’Œç”¨æˆ·åŒºçš„è®¿é—®æƒé™ä¸åŒã€‚
     - 0ï¼šç¦ç”¨ç³»ç»Ÿä¿æŠ¤
     - 1ï¼šå¯ç”¨ç³»ç»Ÿä¿æŠ¤
6. **å†™ç¼“å†²åŒº**ï¼š
   - Bä½ï¼šæ§åˆ¶å†™ç¼“å†²åŒºçš„å¯ç”¨å’Œç¦ç”¨ã€‚
     - 0ï¼šç¦ç”¨å†™ç¼“å†²åŒº
     - 1ï¼šå¯ç”¨å†™ç¼“å†²åŒº
7. **å°ç«¯æ¨¡å¼/å¤§ç«¯æ¨¡å¼**ï¼š
   - Eä½ï¼šé…ç½®å¤„ç†å™¨çš„å­—èŠ‚åºæ¨¡å¼ã€‚
     - 0ï¼šå°ç«¯æ¨¡å¼
     - 1ï¼šå¤§ç«¯æ¨¡å¼
8. **å¯¹ç§°å¤šå¤„ç†æ”¯æŒ**ï¼š
   - SMPä½ï¼šå¯ç”¨æˆ–ç¦ç”¨å¯¹ç§°å¤šå¤„ç†ï¼ˆSMPï¼‰æ”¯æŒã€‚
     - 0ï¼šç¦ç”¨SMP
     - 1ï¼šå¯ç”¨SMP
9. **æŒ‡ä»¤é¢„å–**ï¼š
   - Zä½ï¼šæ§åˆ¶æŒ‡ä»¤é¢„å–ã€‚
     - 0ï¼šç¦ç”¨é¢„å–
     - 1ï¼šå¯ç”¨é¢„å–
10. **åˆ†æ”¯é¢„æµ‹**ï¼š
    - Pä½ï¼šæ§åˆ¶åˆ†æ”¯é¢„æµ‹åŠŸèƒ½ã€‚
      - 0ï¼šç¦ç”¨åˆ†æ”¯é¢„æµ‹
      - 1ï¼šå¯ç”¨åˆ†æ”¯é¢„æµ‹

SCTLRå¯„å­˜å™¨ä¸­çš„è¿™äº›æ§åˆ¶ä½ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®éœ€æ±‚é…ç½®å¤„ç†å™¨çš„è¿è¡Œæ¨¡å¼å’Œç‰¹æ€§ï¼Œä»è€Œä¼˜åŒ–æ€§èƒ½å’Œå®‰å…¨æ€§ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ“ä½œç³»ç»Ÿæˆ–å›ºä»¶ä¼šè®¾ç½®è¿™äº›ä½ï¼Œä»¥ç¡®ä¿å¤„ç†å™¨ä»¥é¢„æœŸçš„æ–¹å¼è¿è¡Œã€‚



#### ä¸­æ–­åç§»åœ°å€å’Œç¨‹åºå…¥å£åœ°å€

1. ä¸­æ–­å‘é‡è¡¨å’Œç¨‹åºèµ·å§‹åœ°å€é€šå¸¸ä¸ä¼šè®¾ç½®ç›¸åŒçš„å€¼ï¼Œè¿™ä¼šå¯¼è‡´ä¸¤è€…ä¹‹é—´çš„å†²çªã€‚ç„¶è€Œï¼Œåœ¨æŸäº›ç‰¹å®šæƒ…å†µä¸‹ç‰¹åˆ«æ˜¯åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œå¯ä»¥é€šè¿‡ç‰¹æ®Šçš„é…ç½®å’Œä½¿ç”¨ä¸åŒæ–¹æ³•æ¥å®ç°è¿™ç§è®¾ç½®ã€‚
2. ä¸­æ–­å‘é‡è¡¨åœ¨_start:ä¸­è®¾ç½®ã€‚

# GPIOä¸­æ–­ç¨‹åº

- æ±‡ç¼–æ–‡ä»¶

  - åœ¨æ±‡ç¼–å¯åŠ¨ç¨‹åºä¸­é…ç½®å¥½ä¸­æ–­å‘é‡è¡¨å’Œä¸­æ–­æœåŠ¡å‡½æ•°IRQ_Hanlderã€‚

- BSP_INT(ä¸­æ–­é…ç½®æ–‡ä»¶)

  - åˆ›å»ºä¸­æ–­å‡½æ•°æŒ‡é’ˆç±»å‹ã€‚
  - åˆ›å»ºä¸­æ–­å‡½æ•°ç»“æ„ä½“ï¼ŒåŒ…æ‹¬ä¸­æ–­æœåŠ¡å‡½æ•°å’Œä¸­æ–­æœåŠ¡å‡½æ•°å‚æ•°ã€‚
  - åˆ›å»ºå˜é‡è®°å½•ä¸­æ–­åµŒå¥—æ•°é‡ã€‚
  - åˆ›å»ºä¸­æ–­å¤„ç†å‡½æ•°è¡¨ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚
  - åˆ›å»ºåˆå§‹åŒ–ä¸­æ–­å‡½æ•°è¡¨å‡½æ•°ï¼Œä¸­æ–­æ•°é‡æ¸…é›¶ã€‚
  - ä¸­æ–­åˆå§‹åŒ–å‡½æ•°(åˆå§‹åŒ–GICï¼Œåˆå§‹åŒ–ä¸­æ–­å‡½æ•°è¡¨ï¼Œè®¾ç½®ä¸­æ–­å‘é‡åç§»)ã€‚
  - ä¸­æ–­å¤„ç†æ³¨å†Œå‡½æ•°ã€‚
  - ç³»ç»Ÿä¸­æ–­å¤„ç†å‡½æ•°(IRQè·³è½¬)ï¼Œæ£€æŸ¥ä¸­æ–­å¤„ç†å‡½æ•°IDå·ï¼Œä¸­æ–­æ•°åŠ ä¸€ï¼Œè¿è¡Œä¸­æ–­irqTable[intNum]ã€‚

- BSP_GPIOä¸­æ–­æ–‡ä»¶é…ç½®

  - å®šä¹‰æšä¸¾æ•°æ®ä¸­æ–­å‡ºå‘ç±»å‹gpio_interrupt_mode_tã€‚
  - GPIOé…ç½®ç»“æ„ä½“ä¸­åŠ ä¸Šä¸­æ–­ç±»å‹ã€‚
  - GPIOä¸­æ–­é…ç½®å‡½æ•°ï¼Œè¾“å…¥å‚æ•°GPIO*ï¼Œpinï¼Œgpio_interrupt_mode_tã€‚
    - å®šä¹‰icræŒ‡é’ˆã€‚å¹¶`icrShift = pin;`
    - SELç½®1æ—¶è®¾ç½®ICRå¯„å­˜å™¨æ— æ•ˆï¼Œæ‰€ä»¥ç»™æ­¤å¯„å­˜å™¨æ¸…é›¶ã€‚
    - ä½16ä½`icr = &(base->ICR1);`é«˜16ä½`icrShift -= 16;`
    - åˆ¤æ–­ä¸­æ–­å‡ºå‘ç±»å‹ï¼Œè®¾ç½®ICRå¯„å­˜å™¨ã€‚
  - GPIOåˆå§‹åŒ–å‡½æ•°ä¸­åŠ å…¥GPIOä¸­æ–­é…ç½®å‡½æ•°ã€‚
  - å®šä¹‰å‡½æ•°ï¼šä½¿èƒ½GPIOä¸­æ–­ï¼Œç¦æ­¢GPIOä¸­æ–­ï¼Œæ¸…é™¤ä¸­æ–­æ ‡å¿—ä½(è¯¥å‡½æ•°ä½œç”¨ä½é€€å‡ºä¸­æ–­)

- BSP_EXITå¤–éƒ¨ä¸­æ–­é…ç½®æ–‡ä»¶

  - å¤–éƒ¨ä¸­æ–­åˆå§‹åŒ–å‡½æ•°

    - å®šä¹‰gpioé…ç½®ç»“æ„ä½“

    - å¼•è„šå¤ç”¨ï¼Œç”µæ°”å±æ€§ä¸Šæ‹‰è¾“å…¥ã€‚

    - GPIOåˆå§‹åŒ–ã€‚

    - GICä½¿èƒ½ä¸­æ–­ã€‚

    - æ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ã€‚

    - gpioä¸­æ–­ä½¿èƒ½ã€‚

      ```c
      GIC_EnableIRQ(GPIO1_Combined_16_31_IRQn);
      system_register_irqhandler(GPIO1_Combined_16_31_IRQn, gpio1_io18_irqhandler, NULL);
      /* ä½¿èƒ½ä¸­æ–­ä¹‹å‰éœ€è¦å…ˆæ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œå¦åˆ™ä½¿èƒ½åæ¥ä¸­æ–­å¯èƒ½ä¼šå‡ºé—®é¢˜ */
      gpio_enableint(GPIO1, 18);
      ```

  - ä¸­æ–­æœåŠ¡å‡½æ•°ã€‚

# EPITä¸­æ–­

- ä¸­æ–­åˆå§‹åŒ–å‡½æ•°

  - è¾“å…¥å‚æ•°ä¸ºåˆ†é¢‘å€¼å’Œè½½å…¥å€¼ã€‚

    ```c
    void epit1_int(unsigned int frac, unsigned int value)
    ```

  - åˆ¤æ–­åˆ†é¢‘æ•°æ˜¯å¦å¤§äº4095ã€‚

  - é…ç½®EPITä¸­æ–­å¯„å­˜å™¨ã€‚

    ```c
    /* é…ç½®EPITçš„CRå¯„å­˜å™¨ */
    EPIT1->CR = 0;
    /**
      * bit1=1ï¼Œè®¡æ•°å™¨ä»loadå€¼æˆ–è€…0xffffffffå¼€å§‹è®¡æ•°
      * bit2=1ä½¿èƒ½æ¯”è¾ƒä¸­æ–­
      * bit3=1ä»å¯„å­˜å™¨è®°å½•çš„å€¼é‡æ–°è®¡æ•°
      * bit4-15åˆ†é…å€¼frac
      * bit24=1è®¾ç½®å®šæ—¶å™¨æ—¶é’Ÿæº
      */
    EPIT1->CR = (1 << 1) | (1 << 2) | (1 << 3) | (frac << 4) | (1 << 24);
    EPIT1->LR = value;
    EPIT1->CMPR =0;
    ```

  - GICä½¿èƒ½

  - æ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°

  - å¼€å¯ä¸­æ–­

    ```c
    /* åˆå§‹åŒ–ä¸­æ–­ */
    GIC_EnableIRQ(EPIT1_IRQn);
    system_register_irqhandler(EPIT1_IRQn, epit1_irqhandler, NULL);   
    /* æ‰“å¼€EPIT1 */ 
    EPIT1->CR |= (1 << 0);
    ```

- EPIT1ä¸­æ–­æœåŠ¡å‡½æ•°

  ```c
  void epit1_irqhandler(unsigned int gicciar, void *param)
  {
      static unsigned char state = 0;
      state = !state;
      if (EPIT1->SR & (1 << 0))   /* ä¸­æ–­å‘ç”Ÿäº† */
      {
          led_switch(LED0, state);
      }
      /* æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ */
      EPIT1->SR |= (1 << 0);
  }
  ```

# å®šæ—¶å™¨æŒ‰é”®æ¶ˆæŠ–

- å¤–éƒ¨ä¸­æ–­åˆå§‹åŒ–

  ```c
  void keyfilter_init(void)
  {
      gpio_pin_config_t key_config;
      IOMUXC_SetPinMux(IOMUXC_UART1_CTS_B_GPIO1_IO18, 0);                 //è®¾ç½®å¼•è„šå¤ç”¨ï¼ŒGPIO1_18
      IOMUXC_SetPinConfig(IOMUXC_UART1_CTS_B_GPIO1_IO18, 0xf080);         //è®¾ç½®å¼•è„šç”µæ°”å±æ€§ è®¾ç½®ä¸ºä¸Šæ‹‰è¾“å…¥
  
      /* GPIOåˆå§‹åŒ– */
      key_config.direction = kGPIO_DigitalInput;
      key_config.interruptMode = kGPIO_IntFallingEdge;
      key_config.outputLogic = 1;
      gpio_init(GPIO1, 18, &key_config);      //è®¾ç½®å¼•è„šä¸ºè¾“å…¥
  
      GIC_EnableIRQ(GPIO1_Combined_16_31_IRQn);
      system_register_irqhandler(GPIO1_Combined_16_31_IRQn, gpio1_16_32_irqhandler, NULL);
      /* ä½¿èƒ½ä¸­æ–­ä¹‹å‰éœ€è¦å…ˆæ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œå¦åˆ™ä½¿èƒ½åæ¥ä¸­æ–­å¯èƒ½ä¼šå‡ºé—®é¢˜ */
      gpio_enableint(GPIO1, 18);
      filtertimer_init(66000000/100); //å®šæ—¶å™¨åˆå§‹åŒ–æ”¾åœ¨å¤–éƒ¨ä¸­æ–­åˆå§‹åŒ–å‡½æ•°ä¸­
  }
  ```

  

- å®šæ—¶å™¨ä¸­æ–­åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–å®šæ—¶å™¨,ä½†ä¸ä½¿èƒ½ï¼Œè¦åœ¨æŒ‰é”®ä¸‹é™æ²¿ä¸­æ–­è§¦å‘ä¹‹ååœ¨æŒ‰é”®çš„ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­å¼€å¯ï¼Œå¼€å§‹è®¡æ•°ï¼Œè®¡æ•°æ»¡è¶³å®šä¹‰çš„æ—¶é—´è§¦å‘å®šæ—¶å™¨ä¸­æ–­ã€‚

  ```c
  void filtertimer_init(unsigned int value)
  {
      EPIT1->CR = 0;
      EPIT1->CR = (1 << 1) | (1 << 2) | (1 << 3) | (1 << 24);
      EPIT1->LR = value;
      EPIT1->CMPR =0;
      
      /* åˆå§‹åŒ–ä¸­æ–­ */
      GIC_EnableIRQ(EPIT1_IRQn);
      system_register_irqhandler(EPIT1_IRQn, filtertimer_irqhandler, NULL);   
  }
  ```

- å¤–éƒ¨ä¸­æ–­æœåŠ¡å‡½æ•°

  ```c
  void gpio1_16_32_irqhandler(unsigned int gicciar, void *param)
  {
      /* å¼€å¯å®šæ—¶å™¨ */
      filtertimer_restart(66000000/100);
      /* æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ */
      gpio_clearintflags(GPIO1, 18);
  }
  ```

- å®šæ—¶å™¨ä¸­æ–­æœåŠ¡å‡½æ•°

  ```c
  void filtertimer_irqhandler(unsigned int gicciar, void *param)
  {
      static unsigned char state = OFF;
      
      if(EPIT1->SR & (1 << 0))
      {
          /* å…³é—­å®šæ—¶å™¨ */
          filtertimer_stop();
          if (gpio_pinread(GPIO1, 18) == 0)
          {
              state = !state;
              beep_switch(state);
          }
      }
      /* æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ */
      EPIT1->SR |= (1 << 0);
  }
  ```

- å…³é—­EPIT1å®šæ—¶å™¨

  ```C
  /* å…³é—­EPIT1å®šæ—¶å™¨ */
  void filtertimer_stop(void)
  {
      EPIT1->CR &= ~(1 << 0);
  }
  ```

  

- å¼€å¯EPIT1å®šæ—¶å™¨

  ```c
  /* å¼€å¯EPIT1å®šæ—¶å™¨ */
  void filtertimer_restart(unsigned int value)
  {
      EPIT1->CR &= ~(1 << 0);
      EPIT1->LR = value;
      EPIT1->CR |= ( 1<< 0);
  }
  ```

# GPTå®šæ—¶å™¨å®ç°é«˜ç²¾åº¦å»¶æ—¶

#### å®éªŒä¸€ï¼šè¿›å…¥GPTä¸­æ–­å®ç°LEDé—ªçƒ

- å»¶æ—¶åˆå§‹åŒ–å‡½æ•°

  - åˆå§‹åŒ–ç›¸å…³å¯„å­˜å™¨

    CRå¯„å­˜å™¨ï¼Œå…ˆå…¨éƒ¨æ¸…é›¶ï¼Œè½¯ä»¶å¤ä½ï¼Œè®¾ç½®åˆå§‹å€¼ï¼Œæ—¶é’Ÿæºï¼Œè®¾ç½®æ¨¡å¼ä¸ºrestartæ¨¡å¼å³æ¯”è¾ƒä¸­æ–­åé‡æ–°è®¡æ—¶ã€‚è®¾ç½®åˆ†é¢‘å€¼ï¼Œä½¿å®šæ—¶å™¨é¢‘ç‡ä¸º1Mã€‚è®¾ç½®OCR[0]ä¸º1000000/2å³500msè¿›å…¥ä¸€æ¬¡æ¯”è¾ƒä¸­æ–­ã€‚

  - æ‰“å¼€é€šé“1æ¯”è¾ƒä¸­æ–­ï¼ŒGICä½¿èƒ½ï¼Œæ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œæ‰“å¼€GPT1

  ```c
  /* å»¶æ—¶åˆå§‹åŒ–å‡½æ•° */
  void delay_init(void)
  {
      GPT1->CR = 0;
  
      /* è½¯å¤ä½ï¼Œç½®1å¤ä½ï¼Œç­‰å¾…è‡ªåŠ¨æ¸…é›¶ */
      GPT1->CR = (1 << 15);
      while ((GPT1->CR >> 15) & 0x01);
  
      /**
       * bit1: 1ï¼šåˆå§‹å€¼ä¸º0
       * bit6-8: 1ï¼šæ—¶é’Ÿæºé€‰æ‹©ipg_clk = 66MHz
       * bit9: 0ï¼šrestartæ¨¡å¼
       */
      GPT1->CR |= (1 << 1) | (1 << 6);
  
      /* åˆ†é¢‘è®¾ç½®,0-11ä½è®¾ç½®åˆ†é¢‘å€¼ */
      GPT1->PR = 65;      // 66åˆ†é¢‘
      /* é…ç½®è¾“å‡ºæ¯”è¾ƒé€šé“ */
      GPT1->OCR[0] = 1000000/2;    /* è®¾ç½®ä¸­æ–­å‘¨æœŸä¸º500ms */
  
      /* æ‰“å¼€é€šé“1æ¯”è¾ƒä¸­æ–­ */
      GPT1->IR = 1 << 0;
  
      GIC_EnableIRQ(GPT1_IRQn);
      system_register_irqhandler(GPT1_IRQn, gpt1_irqhandler, NULL);
      GPT1->CR |= (1 << 0);   /* æ‰“å¼€GPT1 */
  }
  
  void gpt1_irqhandler(unsigned int gicciar, void *param)
  {
      static unsigned char state  = 0;
  
      /* åˆ¤æ–­æ˜¯å“ªä¸ªä¸­æ–­ */
      if (GPT1->SR & (1 << 0))
      {
          state = !state;
          led_switch(LED0, state);
      }
  
      /* æ¸…é™¤ä¸­æ–­çŠ¶æ€ */
      GPT1->SR |= (1 << 0);
  }
  ```

  

#### å®éªŒäºŒï¼šé«˜ç²¾åº¦å»¶æ—¶

- å»¶æ—¶åˆå§‹åŒ–å‡½æ•°

  ```c
  /* å»¶æ—¶åˆå§‹åŒ–å‡½æ•° */
  void delay_init(void)
  {
      GPT1->CR = 0;
  
      /* è½¯å¤ä½ï¼Œç½®1å¤ä½ï¼Œç­‰å¾…è‡ªåŠ¨æ¸…é›¶ */
      GPT1->CR = (1 << 15);
      while ((GPT1->CR >> 15) & 0x01);
  
      /**
       * bit1: 1ï¼šåˆå§‹å€¼ä¸º0
       * bit6-8: 1ï¼šæ—¶é’Ÿæºé€‰æ‹©ipg_clk = 66MHz
       * bit9: 0ï¼šrestartæ¨¡å¼
       */
      GPT1->CR |= (1 << 1) | (1 << 6);
  
      /* åˆ†é¢‘è®¾ç½®,0-11ä½è®¾ç½®åˆ†é¢‘å€¼ */
      GPT1->PR = 65;      // 66åˆ†é¢‘
      /* 1Mçš„é¢‘ç‡è®¡1ä¸ªæ•°å°±æ˜¯1us */
      GPT1->OCR[0] = 0xffffffff;
  
      GPT1->CR |= (1 << 0);   /* æ‰“å¼€GPT1 */
  }
  ```

  

- uså»¶æ—¶å‡½æ•°

  ```c
  void delay_us(unsigned int usdelay)
  {
      unsigned long oldcnt, newcnt;
      unsigned long tcntvalue = 0;
  
      oldcnt = GPT1->CNT;
      while (1)
      {
          newcnt = GPT1->CNT;
          if(newcnt != oldcnt)
          {
              if(newcnt > oldcnt)
              {
                  tcntvalue += newcnt - oldcnt;
              }
              else
              {
                  tcntvalue += 0xffffffff - oldcnt + newcnt;
              }
              oldcnt = newcnt;
              if (tcntvalue >= usdelay)
              {
                  break;
              }
          } 
      }
  }
  ```

  

- mså»¶æ—¶å‡½æ•°

```c
void delay_ms(unsigned int msdelay)
{
    unsigned int i = 0;
    for (i = 0; i < msdelay; i++)
    {
        delay_us(1000);
    }    
}
```

- ä¸»å‡½æ•°ä¸­ä½¿ç”¨é«˜ç²¾åº¦å»¶æ—¶å‡½æ•°å®ç°LEDé—ªçƒã€‚

# UART

- ä¸²å£IOåˆå§‹åŒ–å‡½æ•°

- ä¸²å£åˆå§‹åŒ–

  - åˆå§‹åŒ–IO

  - åˆå§‹åŒ–å¤ä½UART1

  - é…ç½®ç›¸å…³å¯„å­˜å™¨

    - UCR1ä¸º0
    - UCR2é…ç½®æ•°æ®ä½ï¼Œå¥‡å¶æ ¡éªŒä½ï¼Œåœæ­¢ä½
    - UCR3çš„bti2å¿…é¡»ä¸º1

  - è®¾ç½®æ³¢ç‰¹ç‡

    Baud Rate = ğ‘…ğ‘’ğ‘“ ğ¹ğ‘Ÿğ‘’ğ‘ / (16 Ã—(ğ‘ˆğµğ‘€ğ‘… + 1) / (ğ‘ˆğµğ¼ğ‘… + 1)) 

  - ä½¿èƒ½ä¸²å£

  ```c
  /**
   * @brief åˆå§‹åŒ–UART
   * @brief æ³¢ç‰¹ç‡å›ºå®š115200
   * @param void:void
   */
  void uart_init(void)
  {
      /* åˆå§‹åŒ–ä¸²å£IO */
      uart_io_init();
  
      /* åˆå§‹åŒ–UART1 */
      uart_disable(UART1);    /* å…³é—­UART1 */
      uart_softreset(UART1);   /* å¤ä½UART1 */
  
      /* é…ç½®UART1 */
      UART1->UCR1 = 0;
  
      /* é…ç½®UART1çš„æ•°æ®ä½ï¼Œå¥‡å¶æ ¡éªŒï¼Œåœæ­¢ä½ç­‰ */
      /* bit1-2å‘é€å’Œæ¥æ”¶çš„ä½¿èƒ½ bit5è®¾ç½®æ•°æ®ä½é•¿åº¦8ä½ bit6ä¸€ä½åœæ­¢ä½ bit14å¿½ç•¥RTSè„š */
      UART1->UCR2 = 0;
      UART1->UCR2 |= (1 << 1) | (1 << 2) | (1 << 5) | (1 << 14);
  
      /* bit2å¿…é¡»ä¸º1 */
      UART1->UCR3 |= (1 << 2);
  
      /* è®¾ç½®æ³¢ç‰¹ç‡ */
      UART1->UFCR &= ~(7 << 7);   /* å¯¹RFDIVè¿›è¡Œæ¸…é›¶ */
      UART1->UFCR = 5 << 7;       /* 1åˆ†é¢‘ï¼Œ80M */
      UART1->UBIR = 71;
      UART1->UBMR = 3124;
      /* ä½¿èƒ½ä¸²å£ */
      uart_enable(UART1);
  }
  
  ```

- æ‰“å¼€ä¸²å£

  ```c
  /**
   * @brief æ‰“å¼€ä¸²å£
   * @param UART_Type
   */
  void uart_enable(UART_Type *base)
  {
      base->UCR1 |= (1 << 0);
  }
  ```

- å…³é—­ä¸²å£

  ```c
  /**
   * @brief å…³é—­ä¸²å£
   * @param UART_Type
   */
  void uart_disable(UART_Type *base)
  {
      base->UCR1 &= ~(1 << 0);
  }
  ```

- å¤ä½ä¸²å£

  ```c
  /**
   * @brief å¤ä½UART
   * @param UART_Type
   */
  void uart_softreset(UART_Type *base)
  {
      base->UCR2 &= ~(1 << 0);
      while((base->UCR2 & 0x01) == 0);
  }
  ```

- å‘é€å­—ç¬¦

  ```c
  void putc(unsigned char c)
  {
      /* åœ¨åˆ¤æ–­ä¸Šæ¬¡æ•°æ®æ˜¯å¦å‘é€å®Œæˆ */
      while (((UART1->USR2 >> 3) & 0x01) == 0); /* æ•°æ®æ˜¯å¦åœ¨å‘é€ä¸­ */
      UART1->UTXD = c;
  }
  ```

- æ¥æ”¶å­—ç¬¦

  ```c
  unsigned char getc(void)
  {
      while ((UART1->USR2 & 0x01) == 0); /* æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶ */
      return UART1->URXD;
  }
  ```

  

- å‘é€å­—ç¬¦ä¸²

  ```c
  /**
   * @brief é€šè¿‡ä¸²å£å‘é€ä¸€ä¸²å­—ç¬¦
   * @param str char *
   */
  void puts(char *str)
  {
      char *p = str;
      while(*p != '\0')
      {
          putc(*p++);
      }
  }
  ```

# printfé…ç½®

- æ·»åŠ å®˜æ–¹çš„æ³¢ç‰¹ç‡è®¡ç®—è®¾ç½®å‡½æ•°

  ```c
  /**
   * @brief        	    : æ³¢ç‰¹ç‡è®¡ç®—å…¬å¼ï¼Œå¯ä»¥ç”¨æ­¤å‡½æ•°è®¡ç®—å‡ºæŒ‡å®šä¸²å£å¯¹åº”çš„UFCRï¼ŒUBIRå’ŒUBMRè¿™ä¸‰ä¸ªå¯„å­˜å™¨çš„å€¼
   * @param base		    : è¦è®¡ç®—çš„ä¸²å£ã€‚
   * @param baudrate	    : è¦ä½¿ç”¨çš„æ³¢ç‰¹ç‡ã€‚
   * @param srcclock_hz	: ä¸²å£æ—¶é’Ÿæºé¢‘ç‡ï¼Œå•ä½Hz
   * @return		: æ— 
   */
  void uart_setbaudrate(UART_Type *base, unsigned int baudrate, unsigned int srcclock_hz)
  ```

  - å‡½æ•°ä¸­ç”¨åˆ°æ•°å­¦åº“ï¼Œç¼–è¯‘æ—¶éœ€è¦æŒ‡å®šè·¯å¾„

    ```makefile
    LIBPATH			:= -lgcc -L /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/lib/gcc/arm-linux-gnueabihf/4.9.4
    ```

  - ```c
    /* raiseå‡½æ•°é˜²æ­¢ç¼–è¯‘æŠ¥é”™ */
    void raise(int sig_nr)
    {
        
    }
    ```

- æ·»åŠ stdioæ–‡ä»¶

  - ä¿®æ”¹Makefileï¼Œç¼–è¯‘cæ–‡ä»¶æ—¶åŠ å…¥æŒ‡ä»¤-Wa,-mimplicit-it=thumbé¿å…æŠ¥é”™

    ```makefile
    $(COBJS): obj/%.o : %.c
    	$(CC) $(INCLUDE) -Wa,-mimplicit-it=thumb -fno-builtin -c -Wall -nostdlib -O2 -o $@ $<
    ```

- ä¸»å‡½æ•°

  ```c
  while(1){
          printf("è¯·è¾“å…¥ä¸¤ä¸ªæ•´æ•°ï¼Œä½¿ç”¨ç©ºæ ¼éš”å¼€ï¼š");
          scanf("%d %d", &a, &b);
          printf("\r\næ•°æ®%d+%d=%d\r\n", a, b, a+b);
          printf("%dçš„åå…­è¿›åˆ¶ï¼š%#x\r\n", c);
      }
  ```

  

# DDR3

DDR3ï¼ˆDouble Data Rate 3ï¼‰æ˜¯ç¬¬ä¸‰ä»£åŒå€æ•°æ®ç‡åŒæ­¥åŠ¨æ€éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆSDRAMï¼‰ï¼Œå¹¿æ³›åº”ç”¨äºè®¡ç®—æœºã€æœåŠ¡å™¨å’ŒåµŒå…¥å¼ç³»ç»Ÿä¸­ã€‚ç›¸æ¯”å…¶å‰ä»£ DDR2ï¼ŒDDR3 åœ¨é€Ÿåº¦ã€å¸¦å®½å’Œèƒ½æ•ˆæ–¹é¢éƒ½æœ‰æ˜¾è‘—æå‡ã€‚ä»¥ä¸‹æ˜¯ DDR3 çš„åŸºæœ¬åŸç†å’Œä¸€äº›é‡è¦å‚æ•°çš„ä»‹ç»ã€‚

#### DDR3 çš„å·¥ä½œåŸç†

##### 1. **åŒå€æ•°æ®ç‡ï¼ˆDouble Data Rateï¼‰**:

- DDR3 çš„æ ¸å¿ƒç‰¹ç‚¹æ˜¯åŒå€æ•°æ®ç‡ï¼Œå³åœ¨æ—¶é’Ÿä¿¡å·çš„ä¸Šå‡æ²¿å’Œä¸‹é™æ²¿éƒ½ä¼ è¾“æ•°æ®ã€‚è¿™æ ·ï¼Œåœ¨ç›¸åŒçš„æ—¶é’Ÿé¢‘ç‡ä¸‹ï¼ŒDDR3 å¯ä»¥å®ç°æ¯”ä¼ ç»Ÿ SDRAM æ›´é«˜çš„æ•°æ®ä¼ è¾“é€Ÿç‡ã€‚

##### 2. **å†…éƒ¨ç»“æ„**:

- DDR3 å†…éƒ¨é‡‡ç”¨ 8n é¢„å–æ¶æ„ã€‚æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸ DDR3 å¯ä»¥ä»å†…å­˜é˜µåˆ—ä¸­é¢„å– 8 ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå¹¶åœ¨ 4 ä¸ªæ—¶é’Ÿå‘¨æœŸå†…åˆ† 2 æ¬¡è¾“å‡ºè¿™äº›æ•°æ®ã€‚è¿™ç§æ¶æ„æœ‰åŠ©äºåœ¨æ›´é«˜é¢‘ç‡ä¸‹ç¨³å®šå·¥ä½œã€‚

##### 3. **æ—¶é’Ÿå’Œæ—¶åº**:

- DDR3 ä½¿ç”¨å·®åˆ†æ—¶é’Ÿï¼ˆDifferential Clockï¼ŒCK å’Œ CK#ï¼‰ä¿¡å·æ¥åŒæ­¥å†…å­˜æ“ä½œã€‚æ—¶åºå‚æ•°ï¼ˆå¦‚ CLã€tRCDã€tRP ç­‰ï¼‰å†³å®šäº† DDR3 å†…å­˜æ¨¡å—åœ¨ç‰¹å®šæ“ä½œä¸‹çš„å»¶è¿Ÿå’Œæ€§èƒ½ã€‚

##### 4. **ä½ç”µå‹**:

- DDR3 è¿è¡Œç”µå‹ä¸º 1.5Vï¼Œæ¯” DDR2 çš„ 1.8V æ›´ä½ï¼Œè¿™æœ‰åŠ©äºé™ä½åŠŸè€—ï¼Œå°¤å…¶æ˜¯åœ¨å¤§å‹æœåŠ¡å™¨å’Œæ•°æ®ä¸­å¿ƒç¯å¢ƒä¸­ã€‚

#### DDR3 çš„é‡è¦å‚æ•°

##### 1. **æ•°æ®é€Ÿç‡**:

- DDR3 çš„æ•°æ®ä¼ è¾“é€Ÿç‡ä» 800 MT/sï¼ˆMega Transfers per secondï¼‰åˆ° 2133 MT/s ä¸ç­‰ï¼Œå¸¸è§çš„é€Ÿç‡æœ‰ DDR3-800ã€DDR3-1066ã€DDR3-1333ã€DDR3-1600ã€DDR3-1866 å’Œ DDR3-2133ã€‚

##### 2. **æ—¶é’Ÿé¢‘ç‡**:

- DDR3 çš„å®é™…æ—¶é’Ÿé¢‘ç‡ï¼ˆå†…æ ¸æ—¶é’Ÿï¼‰ä» 400 MHz åˆ° 1066 MHzï¼Œä½†ç”±äºåŒå€æ•°æ®ç‡æŠ€æœ¯ï¼Œå…¶æ•°æ®ä¼ è¾“é€Ÿç‡æ˜¯æ—¶é’Ÿé¢‘ç‡çš„ä¸¤å€ã€‚

##### 3. **å¸¦å®½**:

- å¸¦å®½å–å†³äºå†…å­˜æ¨¡å—çš„ä½å®½å’Œæ•°æ®é€Ÿç‡ã€‚DDR3 çš„å¸¦å®½è®¡ç®—å…¬å¼ä¸ºï¼š`å¸¦å®½ = æ•°æ®é€Ÿç‡ Ã— ä½å®½ Ã· 8`ã€‚ä¾‹å¦‚ï¼ŒDDR3-1600 çš„å•é€šé“å¸¦å®½ä¸º `1600 Ã— 64 Ã· 8 = 12.8 GB/s`ã€‚

##### 4. **æ—¶åºï¼ˆLatencyï¼‰**:

- æ—¶åºæ˜¯æŒ‡å†…å­˜æ¨¡å—åœ¨æ‰§è¡Œä¸åŒæ“ä½œæ—¶çš„å»¶è¿Ÿï¼Œé€šå¸¸ä»¥ä¸€ç³»åˆ—å‚æ•°è¡¨ç¤ºï¼Œå¦‚ CLï¼ˆCAS Latencyï¼‰ã€tRCDï¼ˆRow to Column Delayï¼‰ã€tRPï¼ˆRow Precharge Timeï¼‰ã€tRASï¼ˆRow Active Timeï¼‰ã€‚è¿™äº›å‚æ•°ç›´æ¥å½±å“å†…å­˜çš„è®¿é—®é€Ÿåº¦ã€‚
- ä¾‹å¦‚ï¼ŒDDR3-1600 CL9 çš„æ—¶åºå¯èƒ½æ ‡è®°ä¸º `9-9-9-24`ï¼Œæ„å‘³ç€ CAS Latency ä¸º 9 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒtRCD ä¸º 9 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒtRP ä¸º 9 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒtRAS ä¸º 24 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚

##### 5. **å®¹é‡**:

- DDR3 å†…å­˜æ¨¡å—çš„å®¹é‡é€šå¸¸ä» 512 MB åˆ° 32 GB ä¸ç­‰ï¼Œå…·ä½“å–å†³äºå†…å­˜èŠ¯ç‰‡çš„å¯†åº¦å’Œæ¨¡å—è®¾è®¡ï¼ˆå¦‚å•é€šé“ã€åŒé€šé“æˆ–å¤šé€šé“é…ç½®ï¼‰ã€‚

##### 6. **ç”µå‹**:

- DDR3 æ ‡å‡†ç”µå‹ä¸º 1.5Vï¼Œä½ç”µå‹ç‰ˆæœ¬ DDR3L çš„ç”µå‹ä¸º 1.35Vï¼Œè¶…ä½ç”µå‹ç‰ˆæœ¬ DDR3U çš„ç”µå‹ä¸º 1.25Vã€‚è¿™äº›ä½ç”µå‹ç‰ˆæœ¬æ—¨åœ¨è¿›ä¸€æ­¥é™ä½åŠŸè€—ã€‚

##### 7. **é¢„å–é•¿åº¦**:

- DDR3 çš„é¢„å–é•¿åº¦ä¸º 8nï¼Œæ„å‘³ç€æ¯æ¬¡å†…å­˜è®¿é—®å¯ä»¥é¢„å– 8 ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚è¿™æ˜¯ DDR3 ç›¸æ¯”äº DDR2 æé«˜æ•°æ®å¸¦å®½çš„é‡è¦æŠ€æœ¯æ‰‹æ®µã€‚

##### 8. **æ¨¡å—ç±»å‹**:

- DDR3 å†…å­˜æ¨¡å—åŒ…æ‹¬å¸¸è§çš„ UDIMMï¼ˆUnbuffered DIMMï¼‰ã€RDIMMï¼ˆRegistered DIMMï¼‰ã€SO-DIMMï¼ˆç”¨äºç¬”è®°æœ¬ç”µè„‘çš„å°å‹ DIMMï¼‰ç­‰ã€‚RDIMM å¸¦æœ‰å¯„å­˜å™¨ï¼Œç”¨äºç¨³å®šä¿¡å·ï¼Œé€‚åˆç”¨äºæœåŠ¡å™¨ã€‚

#### DDR3 ç›¸æ¯” DDR2 å’Œ DDR4 çš„ä¼˜åŠ¿

- **ç›¸æ¯” DDR2**:
  - æ›´é«˜çš„å¸¦å®½ï¼šDDR3 çš„æ•°æ®é€Ÿç‡è¿œé«˜äº DDR2ï¼Œå¸¦å®½ç›¸åº”å¢åŠ ã€‚
  - æ›´ä½çš„åŠŸè€—ï¼šDDR3 çš„å·¥ä½œç”µå‹æ¯” DDR2 ä½ï¼Œé™ä½äº†èƒ½è€—ã€‚
  - æ›´å¤§çš„å®¹é‡ï¼šDDR3 æ”¯æŒæ›´é«˜å¯†åº¦çš„å†…å­˜èŠ¯ç‰‡ï¼Œä½¿å¾—å•ä¸ªæ¨¡å—çš„å®¹é‡æ›´å¤§ã€‚
- **ç›¸æ¯” DDR4**:
  - DDR4 è¿›ä¸€æ­¥æå‡äº†æ•°æ®é€Ÿç‡ã€é™ä½äº†ç”µå‹ï¼Œå¹¶å¼•å…¥äº†æ›´å¤šå…ˆè¿›åŠŸèƒ½ï¼ˆå¦‚ Bank Group æŠ€æœ¯ï¼‰ï¼Œä½† DDR3 ä¾ç„¶åœ¨æˆæœ¬æ•æ„Ÿçš„åº”ç”¨ä¸­å¹¿æ³›ä½¿ç”¨ã€‚

#### æ€»ç»“

DDR3 æ˜¯ä¸€ç§æ€§èƒ½å¼ºå¤§ä¸”åº”ç”¨å¹¿æ³›çš„å†…å­˜æŠ€æœ¯ï¼Œå‡­å€Ÿå…¶é«˜å¸¦å®½ã€ä½åŠŸè€—å’Œå¤§å®¹é‡ï¼Œæˆä¸ºäº†è®¸å¤šè®¡ç®—æœºç³»ç»Ÿçš„ä¸»æµé€‰æ‹©ã€‚ç†è§£ DDR3 çš„å·¥ä½œåŸç†å’Œé‡è¦å‚æ•°ï¼Œæœ‰åŠ©äºåœ¨ç³»ç»Ÿè®¾è®¡å’Œä¼˜åŒ–ä¸­åšå‡ºæ›´æ˜æ™ºçš„å†³ç­–ã€‚

# LCD

- è¯»å±å¹•ID

  - æ‰“å¼€æ¨¡æ‹Ÿå¼€å…³ï¼Œè®¾ç½®GPIOï¼ˆå¼•è„šå¤ç”¨å†²çªè§£å†³ï¼‰

    ```c
     /* æ‰“å¼€æ¨¡æ‹Ÿå¼€å…³ï¼Œè®¾ç½®LCD_VSYNCä¸ºé«˜ç”µå¹³ */
        gpio_pin_config_t lcdio_config;
        IOMUXC_SetPinMux(IOMUXC_LCD_VSYNC_GPIO3_IO03, 0);
        IOMUXC_SetPinConfig(IOMUXC_LCD_VSYNC_GPIO3_IO03,0x10b0);
    
        /* GPIOåˆå§‹åŒ– */
        lcdio_config.direction = kGPIO_DigitalOutput;
        lcdio_config.outputLogic = 1;
        gpio_init(GPIO3, 3, &lcdio_config);
    ```

    

  - å°†3ä¸ªIDå£å¤ç”¨ä¸ºGPIOè¾“å…¥æ¨¡å¼

    ```c
     /* è¯»å–IDå€¼ï¼Œè®¾ç½®G7 B7 R7ä¸ºè¾“å…¥ */
    	IOMUXC_SetPinMux(IOMUXC_LCD_DATA07_GPIO3_IO12, 0);		/* B7(M2) */
    	IOMUXC_SetPinMux(IOMUXC_LCD_DATA15_GPIO3_IO20, 0);		/* G7(M1) */
    	IOMUXC_SetPinMux(IOMUXC_LCD_DATA23_GPIO3_IO28, 0);		/* R7(M0) */
    
        IOMUXC_SetPinConfig(IOMUXC_LCD_DATA07_GPIO3_IO12, 0xF080);
    	IOMUXC_SetPinConfig(IOMUXC_LCD_DATA15_GPIO3_IO20, 0xF080);
    	IOMUXC_SetPinConfig(IOMUXC_LCD_DATA23_GPIO3_IO28, 0xF080);
    
        lcdio_config.direction = kGPIO_DigitalInput;
    	gpio_init(GPIO3, 12, &lcdio_config);
    	gpio_init(GPIO3, 20, &lcdio_config);
    	gpio_init(GPIO3, 28, &lcdio_config);
    ```

  - returnå±å¹•ID
  - ä½¿ç”¨ä¸²å£åˆå§‹å±å¹•ID

- åˆå§‹åŒ–å±å¹•IO

  - é…ç½®24ä¸ªæ•°æ®å¼•è„š

  - 4ä¸ªåŠŸèƒ½å¼•è„šï¼ˆLCDIFæ§åˆ¶å™¨ï¼Œä¸ç”¨ä½œGPIOæ‰€ä»¥ä¸ç”¨åˆå§‹æ¢GPIOï¼‰

  - ç‚¹äº®èƒŒå…‰ï¼ˆGPIOï¼‰

  - å¤ä½10ms

    ```c
    /* åˆå§‹åŒ–å±å¹•IO */
    	lcdgpio_init();
    	lcd_reset();
    	delay_ms(10);
    	lcd_noreset();
    ```

- æ ¹æ®ä¸åŒçš„å±å¹•IDæ¥è®¾ç½®å±å¹•å‚æ•°

  ```c
  if(lcdid == ATK7016) {
  		tftlcd_dev.height = 600;	
  		tftlcd_dev.width = 1024;
  		tftlcd_dev.vspw = 3;
  		tftlcd_dev.vbpd = 20;
  		tftlcd_dev.vfpd = 12;
  		tftlcd_dev.hspw = 20;
  		tftlcd_dev.hbpd = 140;
  		tftlcd_dev.hfpd = 160;
  		lcdclk_init(32, 3, 5);	/* åˆå§‹åŒ–LCDæ—¶é’Ÿ 51.2MHz */
  	}
  ```

- è®¾ç½®å…¬å…±å±å¹•å‚æ•°

  ```c
  tftlcd_dev.pixsize = 4;	/* æ¯ä¸ªåƒç´ 4ä¸ªå­—èŠ‚ */
  	tftlcd_dev.framebuffer = LCD_FRAMEBUF_ADDR;
  	tftlcd_dev.forecolor = LCD_RED;
  	tftlcd_dev.backcolor = LCD_BLACK;
  ```

- é…ç½®LCDIFæ§åˆ¶å™¨ç›¸å…³å¯„å­˜å™¨ 

- ä½¿èƒ½ï¼Œæ¸…å±

  ```c
  lcd_enable();			/* ä½¿èƒ½LCD */
  
  delay_ms(20);
  lcd_clear(LCD_WHITE);
  ```

- æ—¶é’Ÿé…ç½®å‡½æ•°

  ```c
  void lcdclk_init(unsigned char loopDiv, unsigned char prediv, unsigned char div)
  {
  	/* ä¸ä½¿ç”¨å°æ•°åˆ†é¢‘å™¨ */
  	CCM_ANALOG->PLL_VIDEO_NUM = 0;
  	CCM_ANALOG->PLL_VIDEO_DENOM = 0;
  
  	/*
       * PLL_VIDEOå¯„å­˜å™¨è®¾ç½®
       * bit[13]:    1   ä½¿èƒ½VIDEO PLLæ—¶é’Ÿ
       * bit[20:19]  2  è®¾ç½®postDividerä¸º1åˆ†é¢‘
       * bit[6:0] : 32  è®¾ç½®loopDividerå¯„å­˜å™¨
  	 */
  	CCM_ANALOG->PLL_VIDEO =  (2 << 19) | (1 << 13) | (loopDiv << 0); 
  
  	/*
       * MISC2å¯„å­˜å™¨è®¾ç½®
       * bit[31:30]: 0  VIDEOçš„post-divè®¾ç½®ï¼Œæ—¶é’Ÿæºæ¥æºäºpostDividerï¼Œ1åˆ†é¢‘
  	 */
  	CCM_ANALOG->MISC2 &= ~(3 << 30);
  
  	/* LCDæ—¶é’Ÿæºæ¥æºä¸PLL5ï¼Œä¹Ÿå°±æ˜¯VIDEO           PLL  */
  	CCM->CSCDR2 &= ~(7 << 15);  	
  	CCM->CSCDR2 |= (2 << 15);			/* è®¾ç½®LCDIF_PRE_CLKä½¿ç”¨PLL5 */
  
  	/* è®¾ç½®LCDIF_PREåˆ†é¢‘ */
  	CCM->CSCDR2 &= ~(7 << 12);		
  	CCM->CSCDR2 |= (prediv - 1) << 12;	/* è®¾ç½®åˆ†é¢‘  */
  
  	/* è®¾ç½®LCDIFåˆ†é¢‘ */
  	CCM->CBCMR &= ~(7 << 23);					
  	CCM->CBCMR |= (div - 1) << 23;		
  
  	/* è®¾ç½®LCDæ—¶é’Ÿæºä¸ºLCDIF_PREæ—¶é’Ÿ */
  	CCM->CSCDR2 &= ~(7 << 9);					/* æ¸…é™¤åŸæ¥çš„è®¾ç½®		 	*/
  	CCM->CSCDR2 |= (0 << 9);					/* LCDIF_PREæ—¶é’Ÿæºé€‰æ‹©LCDIF_PREæ—¶é’Ÿ */
  }
  ```

- åŠŸèƒ½å‡½æ•°
  - ç”»ç‚¹å‡½æ•°
  - è¯»ç‚¹å‡½æ•°
  - æ¸…å±å‡½æ•°
  - çŸ©å½¢å¡«å……å‡½æ•°

# RTC

- æ—¶é—´ç›¸å…³çš„å®å®šä¹‰ï¼Œæ—¶é—´ç›¸å…³çš„ç»“æ„ä½“

  ```c
  /* è·Ÿæ—¶é—´æœ‰å…³çš„å®å®šä¹‰ */
  #define SECONDS_IN_A_DAY    (86400)
  #define SECONDS_IN_A_HOUR   (3600)
  #define SECONDS_IN_A_MINUTE (60)
  #define DAYS_IN_A_YEAR      (365)
  #define YEAR_RANGE_START    (1970)
  #define YEAR_RANGE_END      (2099)
  
  /* è·Ÿæ—¶é—´æœ‰å…³çš„ç»“æ„ä½“ */
  struct rtc_datetime{
  unsigned short  year;
  unsigned char   month;
  unsigned char   day;
  unsigned char   hour;
  unsigned char   minute;
  unsigned char   second;
  };
  ```

- RTCåˆå§‹åŒ–å‡½æ•°

  - å¼€å¯ä¿¡ä»»æ¨¡å¼

  - ä½¿èƒ½RTC

    ```c
    void rtc_init(void)
    {
        struct rtc_datetime rtcDate;
        SNVS->HPCOMR |= (1 << 31) | (1 << 8);
    #if 0
        rtcDate.year    = 2024;
        rtcDate.month   = 8;
        rtcDate.day     = 14;
        rtcDate.hour    = 23;
        rtcDate.minute  = 32;
        rtcDate.second  = 36;
    #endif
        rtc_setdatetime(&rtcDate);
    
        /* å¼€å¯RTC */
        rtc_enable();
    }
    ```

- åŠŸèƒ½å‡½æ•°
  - ä½¿èƒ½RTC
  - å…³é—­RTC
  - **æ—¶é—´è½¬åŒ–ä¸ºç§’æ•°**
  - **è®¾ç½®æ—¶é—´**
  - å¾—åˆ°ç§’æ•°ï¼ˆè¯»å¯„å­˜å™¨ï¼‰
  - ç§’æ•°è½¬åŒ–ä¸ºæ—¶é—´
  - **è·å–æ—¶é—´ï¼ˆå¾—åˆ°ç§’æ•°ï¼Œè½¬åŒ–æ—¶é—´ï¼Œä¼ å…¥æ—¶é—´ç»“æ„ä½“åœ°å€ï¼‰**
  - åˆ¤æ–­é—°å¹´

# IIC

SCLå’ŒSDAéœ€è¦æ¥ä¸Šæ‹‰ç”µé˜»ä¸€èˆ¬4.7Kï¼Œ3.3Vã€‚

I2Cæ€»çº¿æ”¯æŒå¤šä»æœºï¼Œé€šè¿‡ä»æœºåœ°å€å¼€åŒºåˆ†è®¿é—®å“ªä¸ªä»æœº

IICå†™æ—¶åº

![my image](D:\users\wsy\Desktop\document\prinscr\Snipaste_2024-08-21_22-33-14.png)

IICè¯»æ—¶åº

![my image](D:\users\wsy\Desktop\document\prinscr\Snipaste_2024-08-21_22-40-33.png)

å†™æ—¶åºæœ‰ä¸‰éƒ¨åˆ†ï¼Œè¯»æ—¶åºæœ‰å››éƒ¨åˆ†ï¼Œæ¯”å†™å¤šä¸€éƒ¨åˆ†ã€‚åˆ†åˆ«å†™å››ä¸ªå‡½æ•°ä»¥å®ç°å››éƒ¨åˆ†å†…å®¹

#### IICé©±åŠ¨

- åˆå§‹åŒ–IIC

  ```c
  void i2c_init(I2C_Type *base)
  {
      base->I2CR &= ~(1 << 7);        /* å…³é—­I2C */
      base->IFDR = 0x15;              /* 640åˆ†é¢‘ 103.125KHz*/
      base->I2CR |= (1 <<7);          /* æ‰“å¼€I2C */
  }
  ```

- ä¸»æœº

  - startå‡½æ•°

    ä½¿ç”¨å“ªä¸ªIICï¼Œè®¾å¤‡åœ°å€ï¼Œå†™æ–¹å‘

    å¼€å§‹ä½¿ç”¨IICæ—¶åˆ¤æ–­IICæ˜¯å¦åœ¨å¿™

    è®¾ç½®ä¸ºä¸»æœºå‘é€

    å¯„å­˜å™¨ä¸­å†™å…¥åœ°å€ï¼Œè‡ªåŠ¨äº§ç”Ÿstartä¿¡å·

    ```c
    unsigned int i2c_master_start(I2C_Type *base, unsigned char address, enum i2c_direction direction)
    {
        if (base->I2SR & (1 << 5))  /* I2Cå¿™ */
            return 1;
        
        /* è®¾ç½®ä¸ºä¸»æœºæ¨¡å¼1å·¦ç§»5è®¾ç½®ä¸ºä¸»æœºï¼Œ1å·¦ç§»4è®¾ç½®ä¸ºå‘é€ */
        base->I2CR |= (1 << 5) | (1 << 4);
        
        /* äº§ç”Ÿstartï¼Œå‘é€ä»æœºåœ°å€æ—¶ï¼ˆI2C_I2DRå¯„å­˜å™¨ä¸­å†™å…¥ä»æœºåœ°å€ï¼‰ï¼Œstartä¿¡å·å°±ä¼šåŒæ­¥äº§ç”Ÿï¼Œä¸ç”¨æ‰‹åŠ¨è®¾ç½® */
        base->I2DR = ((unsigned int)address << 1) | (direction == kI2C_Read ? 1 : 0);        /* é«˜7ä½æ˜¯åœ°å€ï¼Œæœ€ä½ä½æ˜¯è¯»å†™ï¼Œæ‰€ä»¥è¦å·¦ç§»ä¸€ä½ */
    
        return 0;
    }
    ```

  - stopå‡½æ•°

    åœæ­¢å“ªä¸ªIIC

    å¯„å­˜å™¨æ¸…é›¶åœæ­¢IIC

    ç­‰å¾…IICå·¥ä½œå®Œæˆåreturn OK

    ```c
    unsigned char i2c_master_stop(I2C_Type *base)
    {
        unsigned short timeout = 0xffff;    /* è¶…æ—¶æ—¶é—´ */
    
        /* æ¸…é™¤i2cçš„bit5:3
         * 5æ¸…é›¶ä»æ¨¡å¼
         * 4æ¸…é›¶æ¥æ”¶æ¨¡å¼
         * 3æ¸…é›¶ï¼Œåœ¨æ¥æ”¶åˆ°ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ååœ¨ç¬¬ä¹ä¸ªæ—¶é’Ÿä½å‘æ€»çº¿å‘é€ç¡®è®¤ä¿¡å·ï¼Œè¿™ä¸ªä½ä»…ä»…åœ¨æ¥æ”¶æ¨¡å¼ä¸‹å†™1
         */
        base->I2CR &= ~(0x7 << 3);
    
        /* ç­‰å¾…i2cå¿™ç»“æŸ */
        while(base->I2SR & (1 << 5))
        {
            timeout--;
            if(timeout == 0)    /* è¶…æ—¶è·³å‡º */
                return I2C_STATUS_TIMEOUT;
        }
        return I2C_STATUS_OK;
    }
    ```

  - repeated startå‡½æ•°

    åˆ¤æ–­æ˜¯å¦å¿™ç¢Œæˆ–è€…å·¥ä½œåœ¨ä»æœºæ¨¡å¼

    è®¾ç½®å‘é€äº§ç”Ÿrestart

    å‘é€åœ°å€ä»¥åŠè¯»æ–¹å‘ï¼Œreturn OK

    ```c
    unsigned int i2c_master_repeated_start(I2C_Type *base, unsigned char address, enum i2c_direction direction)
    {
        /* I2Cæ˜¯å¦å¿™æˆ–è€…å·¥ä½œåœ¨ä»æœºæ¨¡å¼ä¸‹ï¼Œå› ä¸ºrestartä¿¡å·æ˜¯åœ¨ä¿¡å·ä¼ è¾“ä¸­è¿›è¡Œçš„ï¼Œæ‰€ä»¥è¦æ£€æŸ¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯å¦è¢«è®¾ç½®æˆäº†ä»æœºæ¨¡å¼ */
        if((base->I2SR & (1 << 5)) && (base->I2CR & (1 << 5)) == 0)
            return 1;
        /* 1<<4ä¸ºå‘é€ï¼Œ1<<2ä¸ºäº§ç”Ÿrestartä¿¡å· */
        base->I2CR |= (1 << 4) | (1 << 2);
        base->I2DR = ((unsigned int)address << 1) | (direction == kI2C_Read ? 1 : 0);        /* é«˜7ä½æ˜¯åœ°å€ï¼Œæœ€ä½ä½æ˜¯è¯»å†™ï¼Œæ‰€ä»¥è¦å·¦ç§»ä¸€ä½ */
        return I2C_STATUS_OK;
    }
    ```

  - é”™è¯¯æ£€æŸ¥å‡½æ•°

    ```c
    unsigned char i2c_check_and_clear_error(I2C_Type *base, unsigned int status)
    {
        /* å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºä»²è£ä¸¢å¤±é”™è¯¯ */
        if(base->I2SR & (1 << 4)) {
            base->I2SR &= ~(1 << 4);
            base->I2CR &= ~(1 << 7);
            base->I2CR |= (1 << 7);
            return I2C_STATUS_ARBITRATION_LOST;
        }
        else if(base->I2SR & (1 << 0)) {    // æ£€æµ‹åˆ°NOACKä¿¡å·
            return I2C_STATUS_NAK;
        }
        return I2C_STATUS_OK;
    }
    ```

  - writeå‡½æ•°

    ä¸­é—´è¿‡ç¨‹ï¼Œç­‰å¾…ä¼ è¾“å®Œæˆè€Œæ˜¯æ£€æµ‹æ˜¯å¦å¤„äºå¿™ç¢Œ

    æ¸…é™¤ä¸­æ–­ï¼Œè®¾ç½®å‘é€

    whileå‡½æ•°å°†è¦å†™å…¥çš„æ•°æ®ä¾æ¬¡ç»™I2DRå¯„å­˜å™¨ï¼Œæ¯ä¸€æ¬¡è¾“å…¥è¦åˆ¤æ–­SRå¯„å­˜å™¨æ˜¯å¦å½“å‰å­—èŠ‚æ•°æ®æ˜¯å¦ä¼ è¾“å®Œæˆï¼Œç„¶åæ‰å¼€å§‹ä¸‹ä¸€ä¸ªæ•°æ®çš„ä¼ è¾“ã€‚

    æ£€æŸ¥æ˜¯å¦æœ‰ä¼ è¾“é”™è¯¯

    æ¸…é™¤æ ‡å¿—ä½ï¼Œåœæ­¢ä¼ è¾“

    ```c
    void i2c_master_write(I2C_Type *base, const unsigned char *buf, unsigned int size)
    {
        /* ç­‰å¾…ä¼ è¾“å®Œæˆ */
        while(!(base->I2SR & (1 << 7)));
    
        base->I2SR &= ~(1 << 1);            /* æ¸…é™¤ä¸­æ–­ */
        base->I2CR |= (1 << 4);             /* è®¾ç½®ä¸ºå‘é€ */
    
        while (size--)
        {
            base->I2DR = *buf++;            /* å°†è¦å‘é€çš„æ•°æ®å†™å…¥I2DR */
            while(!(base->I2SR & (1 << 1)));    /* ç­‰å¾…ä¼ è¾“å®Œæˆ */
            
            /* æ£€æŸ¥ACK */
            if(i2c_check_and_clear_error(base, base->I2SR))
                break;  // æ£€æµ‹åˆ°æœ‰é”™è¯¯å‘ç”Ÿä¸­æ–­å‘é€
        }
        base->I2SR &= ~(1 << 1);
        i2c_master_stop(base);
    }
    ```

  - readå‡½æ•°

    ç­‰å¾…ä¼ è¾“å®Œæˆ

    æ¸…é™¤æ ‡å¿—ä½ï¼Œè®¾ç½®æ¥æ”¶

    ```c
    void i2c_master_read(I2C_Type *base, unsigned char *buf, unsigned int size)
    {
        volatile uint8_t dummy = 0;     /* å‡è¯» */
        dummy++;                        /* é˜²æ­¢ç¼–è¯‘æŠ¥é”™ */
        /* ç­‰å¾…ä¼ è¾“å®Œæˆ */
        while(!(base->I2SR & (1 << 7)));
    
        base->I2SR &= ~(1 << 1);            /* æ¸…é™¤ä¸­æ–­ */
        base->I2CR &= ~((1 << 4) | (1 << 3));
    
        /* å½“æœ‰å¤šä¸ªæ•°æ®çš„æ—¶å€™ï¼Œè¯»å€’æ•°ç¬¬äºŒä¸ªæ•°æ®çš„æ—¶å€™ä¸»æœºå‘ä»æœºå‘é€NACKä¿¡å·ï¼Œå½“åªæœ‰ä¸€ä¸ªæ•°æ®çš„æ—¶å€™ä¸»æœºç›´æ¥å‘ä»æœºå‘é€NACK */
        if (size == 1)
        {
            base->I2CR |= (1 << 3);                 /* NACK */
        }
    
        while(size--) {
            while(!(base->I2SR & (1 << 1)));        /* ç­‰å¾…æ•°æ®ä¼ è¾“å®Œæˆ */
            base->I2SR &= ~(1 << 1);
    
            if (size == 0)                          /* æ•°æ®å‘é€å®Œæˆ */
            {
                i2c_master_stop(base);
            }
            if (size == 1)
            {
                base->I2CR |= (1 << 3);             /* NACK */
            }
            
            *buf++ = base->I2DR;
        }
    }
    ```

  - ä¼ è¾“å‡½æ•°

    ```c
    unsigned char i2c_master_transfer(I2C_Type *base, struct i2c_transfer *xfer)
    {
    	unsigned char ret = 0;
    	enum i2c_direction direction = xfer->direction;	
    
    	base->I2SR &= ~((1 << 1) | (1 << 4));			/* æ¸…é™¤æ ‡å¿—ä½ */
    
    	/* ç­‰å¾…ä¼ è¾“å®Œæˆ */
    	while(!((base->I2SR >> 7) & 0X1)){};
    
    	/* å¦‚æœæ˜¯è¯»çš„è¯ï¼Œè¦å…ˆå‘é€å¯„å­˜å™¨åœ°å€ï¼Œæ‰€ä»¥è¦å…ˆå°†æ–¹å‘æ”¹ä¸ºå†™ */
        if ((xfer->subaddressSize > 0) && (xfer->direction == kI2C_Read))
        {
            direction = kI2C_Write;
        }
    
    	ret = i2c_master_start(base, xfer->slaveAddress, direction); /* å‘é€å¼€å§‹ä¿¡å· */
        if(ret)
        {	
    		return ret;
    	}
    
    	while(!(base->I2SR & (1 << 1))){};			/* ç­‰å¾…ä¼ è¾“å®Œæˆ */
    
        ret = i2c_check_and_clear_error(base, base->I2SR);	/* æ£€æŸ¥æ˜¯å¦å‡ºç°ä¼ è¾“é”™è¯¯ */
        if(ret)
        {
          	i2c_master_stop(base); 						/* å‘é€å‡ºé”™ï¼Œå‘é€åœæ­¢ä¿¡å· */
            return ret;
        }
    	
        /* å‘é€å¯„å­˜å™¨åœ°å€ */
        if(xfer->subaddressSize)
        {
            do
            {
    			base->I2SR &= ~(1 << 1);			/* æ¸…é™¤æ ‡å¿—ä½ */
                xfer->subaddressSize--;				/* åœ°å€é•¿åº¦å‡ä¸€ */
    			
                base->I2DR =  ((xfer->subaddress) >> (8 * xfer->subaddressSize)); //å‘I2DRå¯„å­˜å™¨å†™å…¥å­åœ°å€
      
    			while(!(base->I2SR & (1 << 1)));  	/* ç­‰å¾…ä¼ è¾“å®Œæˆ */
    
                /* æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿ */
                ret = i2c_check_and_clear_error(base, base->I2SR);
                if(ret)
                {
                 	i2c_master_stop(base); 				/* å‘é€åœæ­¢ä¿¡å· */
                 	return ret;
                }  
            } while ((xfer->subaddressSize > 0) && (ret == I2C_STATUS_OK));
    
            if(xfer->direction == kI2C_Read) 		/* è¯»å–æ•°æ® */
            {
                base->I2SR &= ~(1 << 1);			/* æ¸…é™¤ä¸­æ–­æŒ‚èµ·ä½ */
                i2c_master_repeated_start(base, xfer->slaveAddress, kI2C_Read); /* å‘é€é‡å¤å¼€å§‹ä¿¡å·å’Œä»æœºåœ°å€ */
        		while(!(base->I2SR & (1 << 1))){};/* ç­‰å¾…ä¼ è¾“å®Œæˆ */
    
                /* æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿ */
    			ret = i2c_check_and_clear_error(base, base->I2SR);
                if(ret)
                {
                 	ret = I2C_STATUS_ADDRNAK;
                    i2c_master_stop(base); 		/* å‘é€åœæ­¢ä¿¡å· */
                    return ret;  
                }
            }
        }
    
        /* å‘é€æ•°æ® */
        if ((xfer->direction == kI2C_Write) && (xfer->dataSize > 0))
        {
        	i2c_master_write(base, xfer->data, xfer->dataSize);
    	}
    
        /* è¯»å–æ•°æ® */
        if ((xfer->direction == kI2C_Read) && (xfer->dataSize > 0))
        {
           	i2c_master_read(base, xfer->data, xfer->dataSize);
    	}
    	return 0;	
    }
    ```

- ä»æœºå‡½æ•°

  - å®å®šä¹‰ï¼Œå™¨ä»¶åœ°å€å’Œå¯„å­˜å™¨åœ°å€

    ```c
    #define AP3216C_ADDR    	0X1E	/* AP3216Cå™¨ä»¶åœ°å€ */
    
    /* AP3316Cå¯„å­˜å™¨ */
    #define AP3216C_SYSTEMCONG	0x00	/* é…ç½®å¯„å­˜å™¨ 			*/
    #define AP3216C_INTSTATUS	0X01	/* ä¸­æ–­çŠ¶æ€å¯„å­˜å™¨ 			*/
    #define AP3216C_INTCLEAR	0X02	/* ä¸­æ–­æ¸…é™¤å¯„å­˜å™¨ 			*/
    #define AP3216C_IRDATALOW	0x0A	/* IRæ•°æ®ä½å­—èŠ‚ 			*/
    #define AP3216C_IRDATAHIGH	0x0B	/* IRæ•°æ®é«˜å­—èŠ‚ 			*/
    #define AP3216C_ALSDATALOW	0x0C	/* ALSæ•°æ®ä½å­—èŠ‚ 		*/
    #define AP3216C_ALSDATAHIGH	0X0D	/* ALSæ•°æ®é«˜å­—èŠ‚			*/
    #define AP3216C_PSDATALOW	0X0E	/* PSæ•°æ®ä½å­—èŠ‚ 			*/
    #define AP3216C_PSDATAHIGH	0X0F	/* PSæ•°æ®é«˜å­—èŠ‚ 			*/
    ```

  - åˆå§‹åŒ–å‡½æ•°

    IOåˆå§‹åŒ–

    I2Cæ¥å£åˆå§‹åŒ–

    ä¼ æ„Ÿå™¨åˆå§‹åŒ–

    â€‹	æ‰¾ä¸€ä¸ªå¯„å­˜å™¨ï¼Œå…ˆå†™åè¯»ï¼Œåˆ¤æ–­è¯»å†™çš„æ•°æ®æ˜¯å¦ä¸€è‡´

  - è¯»ä¸€ä¸ªå­—èŠ‚

  - å†™ä¸€ä¸ªå­—èŠ‚

  - è¯»æ•°æ®

    ```c
    void ap3216c_readdata(unsigned short *ir, unsigned short *ps, unsigned short *als)
    {
        unsigned char buf[6];
        unsigned char i;
    
    	/* å¾ªç¯è¯»å–æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ® */
        for(i = 0; i < 6; i++)	
        {
            buf[i] = ap3216c_readonebyte(AP3216C_ADDR, AP3216C_IRDATALOW + i);	
        }
    	
        if(buf[0] & 0X80) 	/* IR_OFä½ä¸º1,åˆ™æ•°æ®æ— æ•ˆ */
    		*ir = 0;					
    	else 				/* è¯»å–IRä¼ æ„Ÿå™¨çš„æ•°æ®   		*/
    		*ir = ((unsigned short)buf[1] << 2) | (buf[0] & 0X03); 			
    	
    	*als = ((unsigned short)buf[3] << 8) | buf[2];	/* è¯»å–ALSä¼ æ„Ÿå™¨çš„æ•°æ® 			 */  
    	
        if(buf[4] & 0x40)	/* IR_OFä½ä¸º1,åˆ™æ•°æ®æ— æ•ˆ 			*/
    		*ps = 0;    													
    	else 				/* è¯»å–PSä¼ æ„Ÿå™¨çš„æ•°æ®    */
    		*ps = ((unsigned short)(buf[5] & 0X3F) << 4) | (buf[4] & 0X0F); 	
    }
    ```

# SPI

SPIç›¸å¯¹äºIICæœ€å¤§çš„ä¼˜åŠ¿æœ‰ä¸¤ç‚¹

â€‹	é€Ÿåº¦å¿«ï¼Œæœ€å¤§å¯ä»¥è¾¾åˆ°å‡ åMHzï¼Œç”šè‡³ä¸Šç™¾MHz

â€‹	å…¨åŒå·¥

ä¸€ä¸ªSPIæ¥å£å¯ä»¥è¿æ¥å¤šä¸ªSPIå¤–è®¾

SPIï¼ˆSerial Peripheral Interfaceï¼‰æ˜¯ä¸€ç§åŒæ­¥ä¸²è¡Œé€šä¿¡åè®®ï¼Œä¸»è¦ç”¨äºçŸ­è·ç¦»é€šä¿¡ï¼Œé€šå¸¸ç”¨äºå¾®æ§åˆ¶å™¨ä¸å¤–å›´è®¾å¤‡ï¼ˆå¦‚ä¼ æ„Ÿå™¨ã€å­˜å‚¨è®¾å¤‡ã€æ˜¾ç¤ºå™¨ç­‰ï¼‰ä¹‹é—´çš„é€šä¿¡ã€‚SPI é€šä¿¡åè®®å…·æœ‰é«˜é€Ÿã€ç®€å•ã€å ç”¨èµ„æºå°‘ç­‰ç‰¹ç‚¹ã€‚

## SPIåè®®ä»‹ç»

#### SPI é€šä¿¡åè®®çš„åŸºæœ¬ç‰¹æ€§

1. **ä¸»ä»æ¨¡å¼ï¼ˆMaster-Slaveï¼‰**ï¼š
   - SPI æ˜¯ä¸€ç§ä¸»ä»æ¶æ„çš„åè®®ã€‚åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä¸»è®¾å¤‡ï¼ˆMasterï¼‰æ§åˆ¶æ•´ä¸ªé€šä¿¡è¿‡ç¨‹ï¼Œè€Œä»è®¾å¤‡ï¼ˆSlaveï¼‰åˆ™è¢«åŠ¨åœ°å“åº”ä¸»è®¾å¤‡çš„è¯·æ±‚ã€‚
   - é€šå¸¸åªæœ‰ä¸€ä¸ªä¸»è®¾å¤‡ï¼Œä½†å¯ä»¥æœ‰å¤šä¸ªä»è®¾å¤‡ã€‚
2. **å…¨åŒå·¥é€šä¿¡**ï¼š
   - SPI æ˜¯å…¨åŒå·¥çš„ï¼Œè¿™æ„å‘³ç€æ•°æ®å¯ä»¥åŒæ—¶åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šä¼ è¾“ï¼Œå³ä¸»è®¾å¤‡å’Œä»è®¾å¤‡å¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚
3. **åŒæ­¥é€šä¿¡**ï¼š
   - SPI æ˜¯ä¸€ç§åŒæ­¥é€šä¿¡åè®®ï¼Œè¿™æ„å‘³ç€æ•°æ®ä¼ è¾“æ˜¯ç”±æ—¶é’Ÿä¿¡å·åŒæ­¥çš„ã€‚ä¸»è®¾å¤‡ç”Ÿæˆçš„æ—¶é’Ÿä¿¡å·ç”¨äºåŒæ­¥æ•°æ®çš„å‘é€å’Œæ¥æ”¶ã€‚

#### SPI çš„å››æ¡åŸºæœ¬ä¿¡å·çº¿

1. **MOSIï¼ˆMaster Out Slave Inï¼‰**ï¼š
   - ä¸»è®¾å¤‡å‘é€æ•°æ®åˆ°ä»è®¾å¤‡çš„æ•°æ®çº¿ã€‚
2. **MISOï¼ˆMaster In Slave Outï¼‰**ï¼š
   - ä»è®¾å¤‡å‘é€æ•°æ®åˆ°ä¸»è®¾å¤‡çš„æ•°æ®çº¿ã€‚
3. **SCLKï¼ˆSerial Clockï¼‰**ï¼š
   - ä¸²è¡Œæ—¶é’Ÿçº¿ï¼Œç”±ä¸»è®¾å¤‡ç”Ÿæˆï¼Œç”¨äºåŒæ­¥æ•°æ®çš„ä¼ è¾“ã€‚
4. **SS/CSï¼ˆSlave Select/Chip Selectï¼‰**ï¼š
   - ä»è®¾å¤‡é€‰æ‹©çº¿ï¼Œç”±ä¸»è®¾å¤‡æ§åˆ¶ã€‚å½“æŸä¸ªä»è®¾å¤‡çš„ SS çº¿è¢«æ‹‰ä½ï¼ˆå³é€‰ä¸­ï¼‰æ—¶ï¼Œè¯¥ä»è®¾å¤‡å¼€å§‹ä¸ä¸»è®¾å¤‡é€šä¿¡ã€‚
   - å¯¹äºå¤šä»è®¾å¤‡ç³»ç»Ÿï¼Œæ¯ä¸ªä»è®¾å¤‡é€šå¸¸æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ SS çº¿ã€‚

#### SPI çš„å·¥ä½œæ¨¡å¼

SPI çš„æ—¶é’Ÿæœ‰å››ç§å·¥ä½œæ¨¡å¼ï¼Œè¿™ç”±æ—¶é’Ÿææ€§ï¼ˆCPOLï¼‰å’Œæ—¶é’Ÿç›¸ä½ï¼ˆCPHAï¼‰å†³å®šï¼š

1. **CPOLï¼ˆClock Polarityï¼‰**ï¼šæ—¶é’Ÿææ€§å†³å®šç©ºé—²æ—¶é’Ÿçº¿çš„ç”µå¹³ã€‚
   - CPOL = 0: ç©ºé—²çŠ¶æ€æ—¶ï¼Œæ—¶é’Ÿçº¿ï¼ˆSCLKï¼‰ä¸ºä½ç”µå¹³ã€‚
   - CPOL = 1: ç©ºé—²çŠ¶æ€æ—¶ï¼Œæ—¶é’Ÿçº¿ï¼ˆSCLKï¼‰ä¸ºé«˜ç”µå¹³ã€‚
2. **CPHAï¼ˆClock Phaseï¼‰**ï¼šæ—¶é’Ÿç›¸ä½å†³å®šæ•°æ®é‡‡æ ·ç‚¹çš„ä½ç½®ã€‚
   - CPHA = 0: æ•°æ®åœ¨ç¬¬ä¸€ä¸ªæ—¶é’Ÿè¾¹æ²¿é‡‡æ ·ã€‚
   - CPHA = 1: æ•°æ®åœ¨ç¬¬äºŒä¸ªæ—¶é’Ÿè¾¹æ²¿é‡‡æ ·ã€‚

æ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°ï¼ŒSPI å¯ä»¥æœ‰å››ç§å·¥ä½œæ¨¡å¼ï¼š

- æ¨¡å¼0ï¼ˆCPOL = 0, CPHA = 0ï¼‰
- æ¨¡å¼1ï¼ˆCPOL = 0, CPHA = 1ï¼‰
- æ¨¡å¼2ï¼ˆCPOL = 1, CPHA = 0ï¼‰
- æ¨¡å¼3ï¼ˆCPOL = 1, CPHA = 1ï¼‰

#### SPI çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**ï¼š

- é«˜é€Ÿä¼ è¾“ï¼Œæ”¯æŒå…¨åŒå·¥é€šä¿¡ã€‚
- ç®€å•çš„ç¡¬ä»¶å®ç°ï¼Œæ˜“äºä½¿ç”¨ã€‚
- é€šä¿¡æ—¶æ²¡æœ‰æ—¶é’Ÿçº¿æ‹‰ä¼¸çš„é—®é¢˜ï¼ˆä¸åƒI2Cï¼‰ã€‚
- æ”¯æŒå¤šä»è®¾å¤‡é€šä¿¡ï¼ˆåªéœ€å¢åŠ é¢å¤–çš„ SS çº¿ï¼‰ã€‚

**ç¼ºç‚¹**ï¼š

- éœ€è¦å¤šæ¡æ•°æ®çº¿ï¼Œå°¤å…¶æ˜¯åœ¨å¤šä»è®¾å¤‡ç³»ç»Ÿä¸­ã€‚
- æ²¡æœ‰æ˜ç¡®çš„æ ‡å‡†ï¼Œå‚å•†å®ç°å¯èƒ½ä¸åŒã€‚
- é€šä¿¡è·ç¦»è¾ƒçŸ­ï¼Œé€šå¸¸åªé€‚åˆæ¿çº§é€šä¿¡ã€‚

#### SPI çš„åº”ç”¨

SPI é€šä¿¡å¹¿æ³›åº”ç”¨äºå¾®æ§åˆ¶å™¨ä¸å„ç§å¤–å›´è®¾å¤‡ä¹‹é—´çš„é€šä¿¡ï¼Œå¦‚ï¼š

- æ¸©åº¦ä¼ æ„Ÿå™¨
- å­˜å‚¨è®¾å¤‡ï¼ˆEEPROMã€é—ªå­˜ï¼‰
- æ˜¾ç¤ºå±
- ADC/DACè½¬æ¢å™¨

SPI åè®®ç”±äºå…¶é«˜é€Ÿå’Œçµæ´»æ€§ï¼Œç‰¹åˆ«é€‚åˆéœ€è¦å¿«é€Ÿä¼ è¾“æ•°æ®çš„åº”ç”¨åœºåˆã€‚

## SPIæ—¶åºä»‹ç»

SPIï¼ˆSerial Peripheral Interfaceï¼‰çš„æ—¶åºæ˜¯ SPI é€šä¿¡åè®®ä¸­çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ï¼Œå®ƒå†³å®šäº†æ•°æ®åœ¨ä¸»è®¾å¤‡å’Œä»è®¾å¤‡ä¹‹é—´çš„ä¼ è¾“æ–¹å¼ã€‚SPI çš„æ—¶åºä¸»è¦ç”±æ—¶é’Ÿä¿¡å·ï¼ˆSCLKï¼‰çš„ææ€§å’Œç›¸ä½ä»¥åŠæ•°æ®é‡‡æ ·æ—¶åˆ»å†³å®šã€‚äº†è§£è¿™äº›æ—¶åºå¯¹äºæ­£ç¡®å®ç° SPI é€šä¿¡éå¸¸å…³é”®ã€‚

### SPI æ—¶é’Ÿï¼ˆSCLKï¼‰

SPI é€šä¿¡çš„æ—¶é’Ÿç”±ä¸»è®¾å¤‡ï¼ˆMasterï¼‰ç”Ÿæˆï¼Œå¹¶åœ¨é€šä¿¡è¿‡ç¨‹ä¸­åŒæ­¥ä¸»è®¾å¤‡å’Œä»è®¾å¤‡çš„æ•°æ®ä¼ è¾“ã€‚SPI çš„æ—¶é’Ÿæœ‰ä¸¤ä¸ªå…³é”®å‚æ•°ï¼š

1. **æ—¶é’Ÿææ€§ï¼ˆCPOL, Clock Polarityï¼‰**ï¼šç¡®å®šæ—¶é’Ÿçº¿ï¼ˆSCLKï¼‰åœ¨ç©ºé—²çŠ¶æ€æ—¶çš„ç”µå¹³ã€‚
   - **CPOL = 0**ï¼šç©ºé—²çŠ¶æ€æ—¶ï¼Œæ—¶é’Ÿçº¿ä¸ºä½ç”µå¹³ã€‚
   - **CPOL = 1**ï¼šç©ºé—²çŠ¶æ€æ—¶ï¼Œæ—¶é’Ÿçº¿ä¸ºé«˜ç”µå¹³ã€‚
2. **æ—¶é’Ÿç›¸ä½ï¼ˆCPHA, Clock Phaseï¼‰**ï¼šç¡®å®šæ•°æ®åœ¨æ—¶é’Ÿçš„å“ªä¸ªè¾¹æ²¿è¢«é‡‡æ ·å’Œå‘é€ã€‚
   - **CPHA = 0**ï¼šæ•°æ®åœ¨ç¬¬ä¸€ä¸ªæ—¶é’Ÿè¾¹æ²¿é‡‡æ ·ï¼ˆå³ç¬¬ä¸€ä¸ªè¾¹æ²¿æ˜¯æ•°æ®é‡‡æ ·ç‚¹ï¼‰ã€‚
   - **CPHA = 1**ï¼šæ•°æ®åœ¨ç¬¬äºŒä¸ªæ—¶é’Ÿè¾¹æ²¿é‡‡æ ·ï¼ˆå³ç¬¬äºŒä¸ªè¾¹æ²¿æ˜¯æ•°æ®é‡‡æ ·ç‚¹ï¼‰ã€‚

æ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°ï¼ŒSPI æœ‰å››ç§å·¥ä½œæ¨¡å¼ï¼š

1. **æ¨¡å¼ 0 (CPOL = 0, CPHA = 0)**ï¼š
   - æ—¶é’Ÿçº¿ç©ºé—²æ—¶ä¸ºä½ç”µå¹³ï¼ˆCPOL = 0ï¼‰ã€‚
   - åœ¨æ—¶é’Ÿçš„ä¸Šå‡æ²¿é‡‡æ ·æ•°æ®ï¼ˆCPHA = 0ï¼‰ã€‚
2. **æ¨¡å¼ 1 (CPOL = 0, CPHA = 1)**ï¼š
   - æ—¶é’Ÿçº¿ç©ºé—²æ—¶ä¸ºä½ç”µå¹³ï¼ˆCPOL = 0ï¼‰ã€‚
   - åœ¨æ—¶é’Ÿçš„ä¸‹é™æ²¿é‡‡æ ·æ•°æ®ï¼ˆCPHA = 1ï¼‰ã€‚
3. **æ¨¡å¼ 2 (CPOL = 1, CPHA = 0)**ï¼š
   - æ—¶é’Ÿçº¿ç©ºé—²æ—¶ä¸ºé«˜ç”µå¹³ï¼ˆCPOL = 1ï¼‰ã€‚
   - åœ¨æ—¶é’Ÿçš„ä¸‹é™æ²¿é‡‡æ ·æ•°æ®ï¼ˆCPHA = 0ï¼‰ã€‚
4. **æ¨¡å¼ 3 (CPOL = 1, CPHA = 1)**ï¼š
   - æ—¶é’Ÿçº¿ç©ºé—²æ—¶ä¸ºé«˜ç”µå¹³ï¼ˆCPOL = 1ï¼‰ã€‚
   - åœ¨æ—¶é’Ÿçš„ä¸Šå‡æ²¿é‡‡æ ·æ•°æ®ï¼ˆCPHA = 1ï¼‰ã€‚

### SPI æ—¶åºå›¾

ä»¥ä¸‹æ˜¯æ¯ç§æ¨¡å¼ä¸‹çš„å…¸å‹ SPI æ—¶åºå›¾è¯´æ˜ï¼š

- **æ¨¡å¼ 0 (CPOL = 0, CPHA = 0)**:
  - æ—¶é’Ÿç©ºé—²æ—¶ä¸ºä½ç”µå¹³ã€‚
  - æ—¶é’Ÿä¸Šå‡æ²¿æ—¶ï¼Œä¸»è®¾å¤‡å‘é€æ•°æ®ï¼Œä»è®¾å¤‡åœ¨åŒä¸€æ—¶é’Ÿè¾¹æ²¿é‡‡æ ·æ•°æ®ã€‚
- **æ¨¡å¼ 1 (CPOL = 0, CPHA = 1)**:
  - æ—¶é’Ÿç©ºé—²æ—¶ä¸ºä½ç”µå¹³ã€‚
  - æ—¶é’Ÿä¸‹é™æ²¿æ—¶ï¼Œä¸»è®¾å¤‡å‘é€æ•°æ®ï¼Œä»è®¾å¤‡åœ¨ä¸‹ä¸€ä¸ªæ—¶é’Ÿä¸Šå‡æ²¿é‡‡æ ·æ•°æ®ã€‚
- **æ¨¡å¼ 2 (CPOL = 1, CPHA = 0)**:
  - æ—¶é’Ÿç©ºé—²æ—¶ä¸ºé«˜ç”µå¹³ã€‚
  - æ—¶é’Ÿä¸‹é™æ²¿æ—¶ï¼Œä¸»è®¾å¤‡å‘é€æ•°æ®ï¼Œä»è®¾å¤‡åœ¨åŒä¸€æ—¶é’Ÿè¾¹æ²¿é‡‡æ ·æ•°æ®ã€‚
- **æ¨¡å¼ 3 (CPOL = 1, CPHA = 1)**:
  - æ—¶é’Ÿç©ºé—²æ—¶ä¸ºé«˜ç”µå¹³ã€‚
  - æ—¶é’Ÿä¸Šå‡æ²¿æ—¶ï¼Œä¸»è®¾å¤‡å‘é€æ•°æ®ï¼Œä»è®¾å¤‡åœ¨ä¸‹ä¸€ä¸ªæ—¶é’Ÿä¸‹é™æ²¿é‡‡æ ·æ•°æ®ã€‚

### æ•°æ®ä¼ è¾“è¿‡ç¨‹

1. **æ•°æ®å‘é€**ï¼šåœ¨ä¸»è®¾å¤‡çš„æ—¶é’Ÿä¿¡å·ä½œç”¨ä¸‹ï¼Œä¸»è®¾å¤‡é€šè¿‡ MOSI çº¿å‘é€æ•°æ®ä½ï¼Œæ¯ä¸ªæ•°æ®ä½åœ¨æ—¶é’Ÿçš„æŒ‡å®šè¾¹æ²¿å‘é€ã€‚
2. **æ•°æ®é‡‡æ ·**ï¼šä»è®¾å¤‡åœ¨æ—¶é’Ÿçš„æŒ‡å®šè¾¹æ²¿é‡‡æ ·æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œå¹¶å°†æ•°æ®ä½å­˜å‚¨åœ¨å…¶æ¥æ”¶ç¼“å†²åŒºã€‚
3. **æ•°æ®æ¥æ”¶**ï¼šä»è®¾å¤‡é€šè¿‡ MISO çº¿å°†æ•°æ®å‘é€å›ä¸»è®¾å¤‡ï¼Œä¸»è®¾å¤‡åœ¨æ—¶é’Ÿçš„ç›¸åº”è¾¹æ²¿é‡‡æ ·æ¥æ”¶åˆ°çš„æ•°æ®ã€‚

### SPI é€šä¿¡çš„æ—¶åºåˆ†æ

1. **æ—¶é’Ÿä¿¡å·çš„é€‰æ‹©**ï¼šCPOL å’Œ CPHA çš„é€‰æ‹©å–å†³äºå…·ä½“çš„ SPI è®¾å¤‡å’Œå…¶è¦æ±‚çš„æ—¶åºã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè®¾å¤‡çš„æ—¶åºè¦æ±‚ä¼šåœ¨å…¶æ•°æ®æ‰‹å†Œä¸­è¯¦ç»†è¯´æ˜ã€‚
2. **å¤šä»è®¾å¤‡æ—¶çš„æ—¶åºç®¡ç†**ï¼šå½“æœ‰å¤šä¸ªä»è®¾å¤‡æ—¶ï¼Œä¸»è®¾å¤‡éœ€è¦ç®¡ç†ä¸åŒçš„ä»è®¾å¤‡é€‰æ‹©ä¿¡å·ï¼ˆSS/CSï¼‰ï¼Œä»¥ç¡®ä¿åªæœ‰ä¸€ä¸ªä»è®¾å¤‡å¤„äºé€šä¿¡çŠ¶æ€ï¼Œé¿å…æ€»çº¿å†²çªã€‚

äº†è§£ SPI çš„æ—¶åºæœ‰åŠ©äºåœ¨ç¡¬ä»¶è®¾è®¡ä¸­åˆç†åœ°é…ç½®æ—¶é’Ÿä¿¡å·ï¼Œç¡®ä¿æ•°æ®ä¼ è¾“çš„æ­£ç¡®æ€§å’Œå¯é æ€§ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œåº”è¯¥æ ¹æ®å…·ä½“è®¾å¤‡çš„è¦æ±‚é€‰æ‹©åˆé€‚çš„ SPI å·¥ä½œæ¨¡å¼ï¼Œå¹¶è°ƒè¯•éªŒè¯æ—¶åºæ˜¯å¦æ»¡è¶³é€šä¿¡è¦æ±‚ã€‚

## ç¨‹åºè®¾è®¡

### SPIæ”¯æŒåŒ…

- SPIåˆå§‹åŒ–å‡½æ•°

  ```c
  /**
   * @brief SPIåˆå§‹åŒ–
   * 
   * @param base : ECSPIn
   */
  void spi_init(ECSPI_Type *base)
  {
      base->CONREG = 0;
      /* bit0ç½®1ï¼Œä½¿èƒ½SPIã€‚
       * bit3ç½®1ï¼Œè¡¨ç¤ºå½“å‘TXFIFOå†™å…¥æ•°æ®åé©¬ä¸Šå¼€å¯SPIçªå‘è®¿é—®ï¼Œä¹Ÿå°±æ˜¯å‘é€æ•°æ®ã€‚
       * bit7:4è®¾ç½®SPIé€šé“ä¸»ä»æ¨¡å¼ï¼Œbit7ä¸ºé€šé“3ï¼Œbit4ä¸ºé€šé“0ã€‚
       * æˆ‘ä»¬ä½¿ç”¨äº†SS0ï¼Œä¹Ÿå°±æ˜¯é€šé“0.å®é™…ä¸Šæœ¬å®éªŒç‰‡é€‰ç”±è½¯ä»¶å®ç°
       * bit31:20è®¾ç½®çªå‘è®¿é—®é•¿åº¦ï¼Œè®¾ç½®ä¸º7ï¼Œå³é•¿åº¦ä¸º8bitï¼Œä¸€ä¸ªå­—èŠ‚ã€‚
       */
      base->CONREG |= (1 << 0) | (1 << 3) | (1 << 4) | (7 << 20);
  
      /**
       * bit14:0è®¾ç½®wait statesæ—¶é—´ï¼Œè®¾ç½®ä¸º0x2000;
       * bit15è®¾ç½®æ—¶é’Ÿæºä¸ºSPI clkå°†æ­¤ä½è®¾ç½®ä¸º0.
       * bit21:16è¡¨ç¤ºç‰‡é€‰ä¿¡å·å¾—å»¶æ—¶ï¼Œè®¾ç½®ä¸º0.æˆ‘ä»¬é‡‡ç”¨è½¯ä»¶ç‰‡é€‰
       */
      base->PERIODREG = 0;
      base->PERIODREG = 2000;
  
      /* SPIæ—¶é’ŸICM20608æœ€é«˜åªèƒ½åˆ°8Mï¼Œå°†SPI CLK = 6M */
      base->CONREG &= ~((0xf << 12) | (0xf << 8));
      base->CONREG |= (9 << 12);          /* ä¸€çº§10åˆ†é¢‘ */    
  }
  ```

- SPIå‘é€/æ¥æ”¶å‡½æ•°

  ```c
   * @brief SPIå‘é€/æ¥æ”¶å‡½æ•°
   * 
   * @param base : ECSPIn
   * @param txdata : è¦å‘é€çš„æ•°æ®ï¼Œå½“æ¥æ”¶æ•°æ®æ—¶ï¼Œè¯¥å‚æ•°ç»™0xff
   * @return unsigned char 
   */
  unsigned char spich0_readwrite_byte(ECSPI_Type *base, unsigned char txdata)
  {
      uint32_t spirxdata = 0;
      uint32_t spitxdata = txdata;
  
      /* é€‰æ‹©é€šé“0 */
      base->CONREG &= ~(3 << 18);
      base->CONREG |= (0 << 18);
  
      /* æ•°æ®å‘é€ï¼Œå‘é€æ•°æ®å‰ä¸€å®šè¦ç­‰å¾…STATREGçš„bit0ä¸ºç©º */
      while((base->STATREG & (1 << 0)) == 0);
      base->TXDATA = spitxdata;
  
      /* æ•°æ®æ¥æ”¶ */
      while((base->STATREG & (1 << 3)) == 0);
      spirxdata = base->RXDATA;
  
      return spirxdata;
  }
  ```

  

### ICM20608æ”¯æŒåŒ…

- åˆå§‹åŒ–å‡½æ•°

  ```c
  unsigned char icm20608_init(void)
  {
      unsigned char regval = 0;
      // 1.SPIå¼•è„šçš„åˆå§‹åŒ–
      IOMUXC_SetPinMux(IOMUXC_UART2_RX_DATA_ECSPI3_SCLK, 0);
      IOMUXC_SetPinMux(IOMUXC_UART2_CTS_B_ECSPI3_MOSI, 0);
      IOMUXC_SetPinMux(IOMUXC_UART2_RTS_B_ECSPI3_MISO, 0);
  
      IOMUXC_SetPinConfig(IOMUXC_UART2_RX_DATA_ECSPI3_SCLK, 0x10b0);
      IOMUXC_SetPinConfig(IOMUXC_UART2_CTS_B_ECSPI3_MOSI, 0x10b0);
      IOMUXC_SetPinConfig(IOMUXC_UART2_RTS_B_ECSPI3_MISO, 0x10b0);
  
      // ç‰‡é€‰å¼•è„šåˆå§‹åŒ–
      IOMUXC_SetPinMux(IOMUXC_UART2_TX_DATA_GPIO1_IO20, 0);
      IOMUXC_SetPinConfig(IOMUXC_UART2_TX_DATA_GPIO1_IO20, 0x10b0);
  
      gpio_pin_config_t cs_config;
      cs_config.direction = kGPIO_DigitalOutput;
      cs_config.outputLogic = 0;
      gpio_init(GPIO1, 20, &cs_config);
  
      // 2.SPIæ§åˆ¶å™¨çš„åˆå§‹åŒ–
      spi_init(ECSPI3);
  
      icm20608_write_reg(ICM20_PWR_MGMT_1, 0x80);		/* å¤ä½ï¼Œå¤ä½åä¸º0x40,ç¡çœ æ¨¡å¼ 			*/
  	delay_ms(50);
  	icm20608_write_reg(ICM20_PWR_MGMT_1, 0x01);		/* å…³é—­ç¡çœ ï¼Œè‡ªåŠ¨é€‰æ‹©æ—¶é’Ÿ 					*/
  	delay_ms(50);
  
      // 3.IMC20608çš„åˆå§‹åŒ–
      regval = icm20608_read_reg(ICM20_WHO_AM_I);
      printf("icm20608 id = %#X\r\n", regval);
      if((regval != ICM20608G_ID) && (regval != ICM20608D_ID))
          return 1;
      icm20608_write_reg(ICM20_SMPLRT_DIV, 0x00); 	/* è¾“å‡ºé€Ÿç‡æ˜¯å†…éƒ¨é‡‡æ ·ç‡					*/
  	icm20608_write_reg(ICM20_GYRO_CONFIG, 0x18); 	/* é™€èºä»ªÂ±2000dpsé‡ç¨‹ 				*/
  	icm20608_write_reg(ICM20_ACCEL_CONFIG, 0x18); 	/* åŠ é€Ÿåº¦è®¡Â±16Gé‡ç¨‹ 					*/
  	icm20608_write_reg(ICM20_CONFIG, 0x04); 		/* é™€èºä»ªä½é€šæ»¤æ³¢BW=20Hz 				*/
  	icm20608_write_reg(ICM20_ACCEL_CONFIG2, 0x04); 	/* åŠ é€Ÿåº¦è®¡ä½é€šæ»¤æ³¢BW=21.2Hz 			*/
  	icm20608_write_reg(ICM20_PWR_MGMT_2, 0x00); 	/* æ‰“å¼€åŠ é€Ÿåº¦è®¡å’Œé™€èºä»ªæ‰€æœ‰è½´ 				*/
  	icm20608_write_reg(ICM20_LP_MODE_CFG, 0x00); 	/* å…³é—­ä½åŠŸè€— 						*/
  	icm20608_write_reg(ICM20_FIFO_EN, 0x00);		/* å…³é—­FIFO						*/
      return 0;
  }
  ```

- è¯»å†™å‡½æ•°

  èŠ¯ç‰‡çš„è¯»å†™å‡½æ•°å‚è€ƒèŠ¯ç‰‡çš„æ‰‹å†Œç¼–å†™

  ```c
  /* ICM20608é€šè¿‡SPIæ¥å£è¯»æ•°æ®ï¼Œå†™å…¥åœ°å€ï¼Œè¯»å›æ•°æ® */
  unsigned char icm20608_read_reg(unsigned char reg)
  {
      unsigned char reg_val = 0;
      reg |= 0x80;                /* åœ°å€çš„bit7ç½®1ï¼Œè¡¨ç¤ºè¯»å–æ•°æ® */
      ICM20608_CSN(0);            /* ç‰‡é€‰æ‹‰ä½ */
      spich0_readwrite_byte(ECSPI3, reg);                 /* å†™å…¥è¦è¯»å–å¯„å­˜å™¨çš„åœ°å€ */
      reg_val = spich0_readwrite_byte(ECSPI3, 0xff);
  
      ICM20608_CSN(1);            /* ç‰‡é€‰æ‹‰é«˜ï¼Œåœæ­¢è®¿é—® */
      return reg_val;
  }
  /* ICM20608é€šè¿‡SPIæ¥å£å†™æ•°æ® */
  void icm20608_write_reg(unsigned char reg, unsigned char val)
  {
      reg &= ~0x80;                /* åœ°å€çš„bit7ç½®1ï¼Œè¡¨ç¤ºè¯»å–æ•°æ® */
      ICM20608_CSN(0);            /* ç‰‡é€‰æ‹‰ä½ */
      spich0_readwrite_byte(ECSPI3, reg);                 /* å†™å…¥è¦è¯»å–å¯„å­˜å™¨çš„åœ°å€ */
      spich0_readwrite_byte(ECSPI3, val);
  
      ICM20608_CSN(1);            /* ç‰‡é€‰æ‹‰é«˜ï¼Œåœæ­¢è®¿é—® */
  }
  ```

- é¡ºåºè¯»å–å¤šä¸ªå¯„å­˜å™¨çš„å€¼

  ```c
  /**
   * @param	    : è¯»å–ICM20608è¿ç»­å¤šä¸ªå¯„å­˜å™¨
   * @param reg	: è¦è¯»å–çš„å¯„å­˜å™¨åœ°å€
   * @return 		: è¯»å–åˆ°çš„å¯„å­˜å™¨å€¼
   */
  void icm20608_read_len(unsigned char reg, unsigned char *buf, unsigned char len)
  {  
  	unsigned char i;
  	
  	/* ICM20608åœ¨ä½¿ç”¨SPIæ¥å£çš„æ—¶å€™å¯„å­˜å™¨åœ°å€ï¼Œåªæœ‰ä½7ä½æœ‰æ•ˆ,
  	 * å¯„å­˜å™¨åœ°å€æœ€é«˜ä½æ˜¯è¯»/å†™æ ‡å¿—ä½è¯»çš„æ—¶å€™è¦ä¸º1ï¼Œå†™çš„æ—¶å€™è¦ä¸º0ã€‚
  	 */
  	reg |= 0x80; 
  		
     	ICM20608_CSN(0);               				/* ä½¿èƒ½SPIä¼ è¾“	 		*/
    	spich0_readwrite_byte(ECSPI3, reg);			/* å‘é€å¯„å­˜å™¨åœ°å€  		*/   	   
   	for(i = 0; i < len; i++)					/* é¡ºåºè¯»å–å¯„å­˜å™¨çš„å€¼ 			*/
   	{
  		buf[i] = spich0_readwrite_byte(ECSPI3, 0XFF);	
  	}
   	ICM20608_CSN(1);                			/* ç¦æ­¢SPIä¼ è¾“ 			*/
  }
  ```

- è¯»å–èŠ¯ç‰‡å¯„å­˜å™¨çš„å€¼å¹¶è¿›è¡Œå¤„ç†åå¾—åŠ é€Ÿåº¦ç­‰æ•°æ®é‡çš„è¯»å–å€¼

  ```c
  void icm20608_getdata(void)
  {
  	unsigned char data[14];
  	
  	icm20608_read_len(ICM20_ACCEL_XOUT_H, data, 14);
  
      /* ADCä¼ æ„Ÿå™¨æ•°æ® */
  	icm20608_dev.accel_x_adc = (signed short)((data[0] << 8) | data[1]); 
  	icm20608_dev.accel_y_adc = (signed short)((data[2] << 8) | data[3]); 
  	icm20608_dev.accel_z_adc = (signed short)((data[4] << 8) | data[5]); 
  	icm20608_dev.temp_adc    = (signed short)((data[6] << 8) | data[7]); 
  	icm20608_dev.gyro_x_adc  = (signed short)((data[8] << 8) | data[9]); 
  	icm20608_dev.gyro_y_adc  = (signed short)((data[10] << 8) | data[11]);
  	icm20608_dev.gyro_z_adc  = (signed short)((data[12] << 8) | data[13]);
  }
  ```

- æ˜¾ç¤ºæ•´æ•°éƒ¨åˆ†çš„å‡½æ•°

- æ˜¾ç¤ºå°æ•°éƒ¨åˆ†çš„å‡½æ•°

- ç¡¬ä»¶æµ®ç‚¹æ•°å¤„ç†

  - åœ¨ä½¿ç”¨æµ®ç‚¹æ•°è®¡ç®—æ—¶éœ€è¦ä½¿ç”¨IMX6ULçš„ç¡¬ä»¶æµ®ç‚¹å•å…ƒ

    è¿™ä¸ªå‡½æ•°ç”¨äºä½¿èƒ½ I.MX6UL å¤„ç†å™¨çš„ç¡¬ä»¶ NEON å’Œ FPUï¼ˆæµ®ç‚¹è¿ç®—å•å…ƒï¼‰ã€‚åœ¨ ARM å¤„ç†å™¨ä¸­ï¼ŒNEON æ˜¯ä¸€ç§ç”¨äºåŠ é€Ÿå¤šåª’ä½“å¤„ç†çš„ SIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰æ‰©å±•ï¼Œè€Œ FPU åˆ™ç”¨äºåŠ é€Ÿæµ®ç‚¹æ•°è¿ç®—ã€‚

    è¿™ä¸ªå‡½æ•°é€šè¿‡æ“ä½œ `CPACR` å’Œ `FPEXC` å¯„å­˜å™¨ï¼Œå¼€å¯ NEON å’Œ FPU åŠŸèƒ½ã€‚å®ƒçš„æ“ä½œåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š

    1. **é…ç½® CPACR å¯„å­˜å™¨**ï¼šå¼€å¯å¯¹åå¤„ç†å™¨ 10 å’Œåå¤„ç†å™¨ 11 çš„å®Œå…¨è®¿é—®ï¼Œè¿™ä¸¤ä¸ªåå¤„ç†å™¨åˆ†åˆ«å¯¹åº” NEON å’Œ FPUã€‚
    2. **é…ç½® FPEXC å¯„å­˜å™¨**ï¼šä½¿èƒ½ FPU çš„é«˜çº§æ‰©å±•ã€‚

    *è¿™ä¸ªå‡½æ•°æ˜¯åº•å±‚ç¡¬ä»¶é…ç½®çš„ä¸€éƒ¨åˆ†ï¼Œé€šå¸¸åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è°ƒç”¨ï¼Œä»¥ç¡®ä¿åœ¨æ¥ä¸‹æ¥çš„åº”ç”¨ç¨‹åºä¸­å¯ä»¥ä½¿ç”¨ NEON å’Œ FPU åŠ é€Ÿã€‚*

    ```c
    /*
     * @description	: ä½¿èƒ½I.MX6Uçš„ç¡¬ä»¶NEONå’ŒFPU
     * @param 		: æ— 
     * @return 		: æ— 
     */
     void imx6ul_hardfpu_enable(void)
    {
    	uint32_t cpacr;
    	uint32_t fpexc;
    
    	/* ä½¿èƒ½NEONå’ŒFPU */
    	cpacr = __get_CPACR();
    	cpacr = (cpacr & ~(CPACR_ASEDIS_Msk | CPACR_D32DIS_Msk))
    		   |  (3UL << CPACR_cp10_Pos) | (3UL << CPACR_cp11_Pos);
    	__set_CPACR(cpacr);
    	fpexc = __get_FPEXC();
    	fpexc |= 0x40000000UL;	
    	__set_FPEXC(fpexc);
    }
    ```

  - ç¼–è¯‘çš„æ—¶å€™æŒ‡å®šç¡¬ä»¶æµ®ç‚¹

    è¿™äº›ç¼–è¯‘é€‰é¡¹ç”¨äºç¼–è¯‘é’ˆå¯¹ ARM æ¶æ„çš„ä»£ç ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹ ARMv7-A å¤„ç†å™¨æ¶æ„ï¼Œå¹¶å¯ç”¨äº† NEON å’Œ VFPv4 æµ®ç‚¹è¿ç®—å•å…ƒã€‚å…·ä½“è§£é‡Šå¦‚ä¸‹ï¼š

    1. **-march=armv7-a**ï¼š
       - **å«ä¹‰**ï¼šæŒ‡å®šç›®æ ‡æ¶æ„ä¸º ARMv7-Aã€‚ARMv7-A æ˜¯ä¸€ä¸ª 32 ä½çš„å¤„ç†å™¨æ¶æ„ï¼Œå¸¸ç”¨äºæ™ºèƒ½æ‰‹æœºã€å¹³æ¿ç”µè„‘ç­‰åµŒå…¥å¼è®¾å¤‡ä¸­ã€‚è¿™ä¸ªæ¶æ„æ”¯æŒé«˜çº§æŒ‡ä»¤é›†ï¼Œå¹¶ä¸”é€šå¸¸é›†æˆäº† NEON å’Œ VFPï¼ˆå‘é‡æµ®ç‚¹è¿ç®—å•å…ƒï¼‰ã€‚
       - **ä½œç”¨**ï¼šå‘Šè¯‰ç¼–è¯‘å™¨ç”Ÿæˆçš„æœºå™¨ä»£ç åº”é’ˆå¯¹ ARMv7-A æ¶æ„è¿›è¡Œä¼˜åŒ–ã€‚
    2. **-mfpu=neon-vfpv4**ï¼š
       - **å«ä¹‰**ï¼šæŒ‡å®šä½¿ç”¨ NEON å’Œ VFPv4 æµ®ç‚¹è¿ç®—å•å…ƒã€‚NEON æ˜¯ä¸€ä¸ª SIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰åå¤„ç†å™¨ï¼Œå¸¸ç”¨äºåŠ é€Ÿå¤šåª’ä½“å’Œä¿¡å·å¤„ç†ä»»åŠ¡ã€‚VFPv4 æ˜¯ä¸€ä¸ªæ”¯æŒåŒç²¾åº¦æµ®ç‚¹è¿ç®—çš„æµ®ç‚¹å•å…ƒã€‚
       - **ä½œç”¨**ï¼šå‘Šè¯‰ç¼–è¯‘å™¨ç”Ÿæˆä»£ç æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ NEON å’Œ VFPv4 æŒ‡ä»¤é›†è¿›è¡Œæµ®ç‚¹å’Œå‘é‡è¿ç®—çš„ä¼˜åŒ–ã€‚
    3. **-mfloat-abi=hard**ï¼š
       - **å«ä¹‰**ï¼šæŒ‡å®šä½¿ç”¨ç¡¬æµ®ç‚¹ ABIï¼ˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼‰ã€‚ç¡¬æµ®ç‚¹ ABI æ„å‘³ç€æµ®ç‚¹è¿ç®—å°†ç›´æ¥ä½¿ç”¨ç¡¬ä»¶æµ®ç‚¹å•å…ƒï¼Œè€Œä¸æ˜¯é€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿã€‚
       - **ä½œç”¨**ï¼šé€šè¿‡ä½¿ç”¨ç¡¬ä»¶æµ®ç‚¹è¿ç®—ï¼Œæå‡æµ®ç‚¹è®¡ç®—çš„æ•ˆç‡ã€‚

    ### æ€»ç»“

    è¿™äº›é€‰é¡¹ç»„åˆåœ¨ä¸€èµ·ï¼ŒæŒ‡ç¤ºç¼–è¯‘å™¨ä¸º ARMv7-A æ¶æ„ç”Ÿæˆä¼˜åŒ–çš„ä»£ç ï¼Œåˆ©ç”¨ NEON å’Œ VFPv4 æŒ‡ä»¤é›†ï¼Œå¹¶ç›´æ¥ä½¿ç”¨ç¡¬ä»¶çš„æµ®ç‚¹è¿ç®—å•å…ƒã€‚è¿™äº›ä¼˜åŒ–å¯¹äºå¤šåª’ä½“å¤„ç†ã€ä¿¡å·å¤„ç†å’Œå…¶ä»–è®¡ç®—å¯†é›†å‹åº”ç”¨ç‰¹åˆ«æœ‰æ•ˆã€‚

  - ```makefile
    -march-armv7-a -mfpu=neon-vfpv4 -mfloat-abi=hard
    ```

    

## åå¤„ç†å™¨

åå¤„ç†å™¨ï¼ˆCoprocessorï¼‰æ˜¯ä¸€ä¸ªè®¡ç®—æœºå¤„ç†å™¨ï¼Œå®ƒä¸“é—¨ç”¨äºæ‰§è¡Œç‰¹å®šç±»å‹çš„è®¡ç®—ä»»åŠ¡ï¼Œé€šå¸¸ç”¨äºåŠ é€Ÿä¸»å¤„ç†å™¨ï¼ˆä¹Ÿç§°ä¸ºä¸­å¤®å¤„ç†å™¨ï¼ŒCPUï¼‰çš„æŸäº›æ“ä½œã€‚åå¤„ç†å™¨é€šå¸¸ä¸ä¸»å¤„ç†å™¨ååŒå·¥ä½œï¼Œå¯ä»¥å¤„ç†ç‰¹å®šç±»å‹çš„æŒ‡ä»¤é›†æˆ–æ‰§è¡Œå¤æ‚çš„è®¡ç®—ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡åœ¨ä¸»å¤„ç†å™¨ä¸Šå¯èƒ½ä¼šæ›´æ…¢æˆ–ä¸å¤Ÿé«˜æ•ˆã€‚

### åå¤„ç†å™¨çš„ç±»å‹å’ŒåŠŸèƒ½

1. **æµ®ç‚¹è¿ç®—åå¤„ç†å™¨ï¼ˆFPUï¼‰**ï¼š
   - **åŠŸèƒ½**ï¼šå¤„ç†æµ®ç‚¹æ•°çš„åŠ å‡ä¹˜é™¤ã€å¹³æ–¹æ ¹ç­‰è¿ç®—ã€‚æµ®ç‚¹è¿ç®—åœ¨å¾ˆå¤šç§‘å­¦è®¡ç®—ã€å·¥ç¨‹åº”ç”¨ã€å›¾å½¢å¤„ç†ç­‰é¢†åŸŸéå¸¸å¸¸è§ï¼Œä½†è¿™ç±»è¿ç®—ç›¸å¯¹å¤æ‚ï¼Œä½¿ç”¨ FPU å¯ä»¥å¤§å¤§æé«˜å¤„ç†é€Ÿåº¦ã€‚
   - **ä¾‹å­**ï¼šæ—©æœŸçš„ x86 å¤„ç†å™¨æ²¡æœ‰å†…ç½® FPUï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå«åš 80387 çš„åå¤„ç†å™¨æ¥å¤„ç†æµ®ç‚¹è¿ç®—ã€‚ç°ä»£çš„ CPU é€šå¸¸å·²ç»å°† FPU é›†æˆåœ¨äº†ä¸»å¤„ç†å™¨å†…éƒ¨ã€‚
2. **å›¾å½¢åå¤„ç†å™¨ï¼ˆGPUï¼‰**ï¼š
   - **åŠŸèƒ½**ï¼šä¸“é—¨ç”¨äºå¤„ç†å›¾å½¢æ¸²æŸ“å’Œå¹¶è¡Œè®¡ç®—ä»»åŠ¡ã€‚GPU å¯ä»¥å¤„ç†å¤§é‡çš„çŸ©é˜µè¿ç®—å’Œå‘é‡è®¡ç®—ï¼Œåœ¨å›¾åƒå¤„ç†ã€æœºå™¨å­¦ä¹ ç­‰åº”ç”¨ä¸­èµ·åˆ°äº†å…³é”®ä½œç”¨ã€‚
   - **ä¾‹å­**ï¼šNVIDIA å’Œ AMD çš„æ˜¾å¡å°±æ˜¯å…¸å‹çš„ GPUï¼Œå®ƒä»¬é€šè¿‡ä¸ä¸» CPU åä½œï¼Œå¤„ç†å¤æ‚çš„å›¾å½¢è®¡ç®—ä»»åŠ¡ã€‚
3. **æ•°å­—ä¿¡å·å¤„ç†å™¨ï¼ˆDSPï¼‰**ï¼š
   - **åŠŸèƒ½**ï¼šç”¨äºå¤„ç†æ•°å­—ä¿¡å·ï¼ˆå¦‚éŸ³é¢‘ã€è§†é¢‘ä¿¡å·ï¼‰çš„åå¤„ç†å™¨ã€‚DSP é€šå¸¸ç”¨äºå®æ—¶å¤„ç†ä»»åŠ¡ï¼Œå¦‚éŸ³é¢‘ç¼–ç è§£ç ã€æ»¤æ³¢ã€è°ƒåˆ¶è§£è°ƒç­‰ã€‚
   - **ä¾‹å­**ï¼šåœ¨æ‰‹æœºçš„éŸ³é¢‘å­ç³»ç»Ÿä¸­ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ª DSP åå¤„ç†å™¨æ¥å¤„ç†éŸ³é¢‘ä¿¡å·çš„æ»¤æ³¢å’Œå¢å¼ºã€‚
4. **åŠ å¯†åå¤„ç†å™¨**ï¼š
   - **åŠŸèƒ½**ï¼šç”¨äºå¤„ç†åŠ å¯†è§£å¯†ä»»åŠ¡çš„åå¤„ç†å™¨ï¼Œæä¾›ç¡¬ä»¶åŠ é€Ÿçš„åŠ å¯†ç®—æ³•è®¡ç®—ï¼Œå¦‚ AESã€RSA ç­‰ã€‚
   - **ä¾‹å­**ï¼šç°ä»£å¤„ç†å™¨ä¸­ç»å¸¸é›†æˆæœ‰åŠ å¯†åå¤„ç†å™¨ï¼Œç”¨äºåŠ é€Ÿå®‰å…¨é€šä¿¡å’Œæ•°æ®ä¿æŠ¤ã€‚
5. **NEON åå¤„ç†å™¨**ï¼ˆåœ¨ ARM æ¶æ„ä¸­ï¼‰ï¼š
   - **åŠŸèƒ½**ï¼šARM å¤„ç†å™¨ä¸­çš„ NEON æ˜¯ä¸€ä¸ª SIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰åå¤„ç†å™¨ï¼Œä¸“é—¨ç”¨äºåŠ é€Ÿå¤šåª’ä½“å¤„ç†ã€æ•°å­—ä¿¡å·å¤„ç†å’Œå…¶ä»–è®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚
   - **ä¾‹å­**ï¼šåœ¨ ARM å¤„ç†å™¨ä¸­ï¼ŒNEON åå¤„ç†å™¨è¢«å¹¿æ³›åº”ç”¨äºæ‰‹æœºã€å¹³æ¿ç”µè„‘ç­‰è®¾å¤‡ä¸­ï¼Œç”¨äºå›¾åƒå¤„ç†ã€éŸ³é¢‘å¤„ç†ç­‰ã€‚

### åå¤„ç†å™¨çš„ä½œç”¨

- **æé«˜æ•ˆç‡**ï¼šåå¤„ç†å™¨å¯ä»¥åŠ é€Ÿç‰¹å®šä»»åŠ¡ï¼Œå‡è½»ä¸»å¤„ç†å™¨çš„è´Ÿæ‹…ï¼Œä½¿å¾—ä¸»å¤„ç†å™¨èƒ½å¤Ÿæ›´å¿«åœ°å®Œæˆå…¶ä»–ä»»åŠ¡ã€‚
- **ä¸“ç”¨è®¡ç®—**ï¼šåå¤„ç†å™¨é€šå¸¸é’ˆå¯¹ç‰¹å®šçš„è®¡ç®—ä»»åŠ¡è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå› æ­¤åœ¨è¿™äº›ä»»åŠ¡ä¸Šèƒ½æä¾›è¿œè¶…ä¸»å¤„ç†å™¨çš„æ€§èƒ½ã€‚
- **å¹¶è¡Œå¤„ç†**ï¼šåå¤„ç†å™¨å¯ä»¥ä¸ä¸»å¤„ç†å™¨å¹¶è¡Œå·¥ä½œï¼Œå¢åŠ ç³»ç»Ÿçš„æ•´ä½“è®¡ç®—èƒ½åŠ›ã€‚
- **èŠ‚èƒ½çœç”µ**ï¼šåœ¨ä¸€äº›åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œä½¿ç”¨åå¤„ç†å™¨å¯ä»¥é™ä½æ•´ä½“åŠŸè€—ï¼Œå› ä¸ºåå¤„ç†å™¨å¯ä»¥ä»¥æ›´ä½çš„èƒ½è€—å®Œæˆç‰¹å®šä»»åŠ¡ã€‚

### æ€»ç»“

åå¤„ç†å™¨æ˜¯ä¸“é—¨ä¸ºå¤„ç†æŸç±»ç‰¹å®šä»»åŠ¡è€Œè®¾è®¡çš„ç¡¬ä»¶æ¨¡å—ï¼Œå®ƒå¯ä»¥æ˜¾è‘—æå‡è®¡ç®—æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦å¤§é‡ç‰¹å®šç±»å‹è®¡ç®—çš„åœºæ™¯ä¸‹ã€‚é€šè¿‡å°†ä»»åŠ¡åˆ†é…ç»™é€‚åˆçš„åå¤„ç†å™¨ï¼Œæ•´ä¸ªç³»ç»Ÿèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°è¿è¡Œã€‚