### Cè¯­è¨€çŸ¥è¯†ç‚¹ï¼Œè¾¹å­¦è¾¹è®°

#### å‡½æ•°æŒ‡é’ˆ

- å‡½æ•°æŒ‡é’ˆæ˜¯æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆã€‚å®ƒå…è®¸åŠ¨æ€åœ°è°ƒç”¨å‡½æ•°ï¼Œå³åœ¨è¿è¡Œä¸­å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚

  ```C
  typedef void (*system_irq_handler_t)(unsigned int gicciar, void *param);
  ```

  è¿™æ¡è¯­å¥å°†ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆç±»å‹å®šä¹‰ä¸º `system_irq_handler_t`ï¼Œå®ƒæŒ‡å‘ä¸€ä¸ªè¿”å›ç±»å‹ä¸º `void` çš„å‡½æ•°ã€‚

  **åªè¦æ»¡è¶³è¾“å…¥å‚æ•°ç±»å‹ï¼Œè¿”å›å‚æ•°ç±»å‹ä¸å‡½æ•°æŒ‡é’ˆå®šä¹‰ç›¸åŒ¹é…ï¼Œéƒ½å¯ä»¥è¢«å‡½æ•°æŒ‡é’ˆæŒ‡å‘ã€‚**

  ç¤ºä¾‹ï¼š

  ```c
  /* å®šä¹‰å‡½æ•° */
  #include <stdio.h>
  
  // å®šä¹‰ç¬¦åˆ system_irq_handler_t ç±»å‹çš„å‡½æ•°
  void my_irq_handler(unsigned int gicciar, void *param) {
      printf("IRQ Handler called with gicciar: %u, param: %p\n", gicciar, param);
  }
  
  ```

  ```C
  // å®šä¹‰å‡½æ•°æŒ‡é’ˆç±»å‹
  typedef void (*system_irq_handler_t)(unsigned int gicciar, void *param);
  ```

  ```C
  // å£°æ˜å’Œä½¿ç”¨å‡½æ•°æŒ‡é’ˆ
  int main() {
      // å£°æ˜ä¸€ä¸ª system_irq_handler_t ç±»å‹çš„å‡½æ•°æŒ‡é’ˆ
      system_irq_handler_t handler;
  
      // å°†å‡½æ•°æŒ‡é’ˆæŒ‡å‘ my_irq_handler å‡½æ•°
      handler = my_irq_handler;
  
      // è°ƒç”¨å‡½æ•°æŒ‡é’ˆ
      handler(123, (void *)0xDEADBEEF);
  
      return 0;
  }
  ```

#### å†…è”å‡½æ•°

åœ¨Cè¯­è¨€ä¸­ï¼Œ`inline`å…³é”®å­—ç”¨äºå»ºè®®ç¼–è¯‘å™¨å°†å‡½æ•°çš„ä»£ç ç›´æ¥æ’å…¥åˆ°è°ƒç”¨ç‚¹ï¼Œè€Œä¸æ˜¯é€šè¿‡å¸¸è§„çš„å‡½æ•°è°ƒç”¨æœºåˆ¶æ¥è°ƒç”¨ã€‚è¿™æ ·å¯ä»¥å‡å°‘å‡½æ•°è°ƒç”¨çš„å¼€é”€ï¼Œæ¯”å¦‚é¿å…äº†è°ƒç”¨å’Œè¿”å›æ—¶çš„æ ˆæ“ä½œï¼Œä»¥åŠå¯èƒ½çš„è·³è½¬æŒ‡ä»¤ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚

`inline` è¯¦ç»†è§£é‡Š

- **å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€**ï¼šé€šå¸¸ï¼Œå‡½æ•°è°ƒç”¨æ¶‰åŠå°†å‚æ•°å‹æ ˆã€è·³è½¬åˆ°å‡½æ•°ä»£ç ã€æ‰§è¡Œä»£ç ã€è¿”å›å¹¶æ¸…ç†æ ˆã€‚`inline`å‡½æ•°é€šè¿‡å°†å‡½æ•°ä»£ç ç›´æ¥æ’å…¥åˆ°è°ƒç”¨ç‚¹ï¼Œé¿å…äº†è¿™äº›å¼€é”€ã€‚
- **ç¼–è¯‘å™¨ä¼˜åŒ–å»ºè®®**ï¼š`inline` åªæ˜¯ä¸€ä¸ªå»ºè®®ï¼Œç¼–è¯‘å™¨å¯ä»¥é€‰æ‹©å¿½ç•¥å®ƒã€‚å¦‚æœå‡½æ•°ä½“è¿‡å¤§ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šå¿½ç•¥ `inline` æç¤ºï¼Œå› ä¸ºå†…è”è¾ƒå¤§çš„å‡½æ•°å¯èƒ½ä¼šå¢åŠ ç¨‹åºçš„ä»£ç é‡ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
- **æ³¨æ„äº‹é¡¹**ï¼š
  - é€’å½’å‡½æ•°ä¸èƒ½è¢«å†…è”ï¼Œå› ä¸ºç¼–è¯‘å™¨æ— æ³•ç¡®å®šé€’å½’çš„ç»“æŸæ¡ä»¶ã€‚
  - è¿‡å¤šä½¿ç”¨ `inline` å¯èƒ½å¯¼è‡´ä»£ç è†¨èƒ€ï¼Œåè€Œé™ä½æ€§èƒ½ã€‚

### while

```
i = 5;
while(i--) {}
```

`i` çš„å€¼ä¼šæ˜¯ 4, 3, 2, 1, 0ã€‚è§£é‡Šå¦‚ä¸‹ï¼š

- `i--` æ˜¯ä¸€ä¸ªåç¼€é€’å‡æ“ä½œç¬¦ã€‚å®ƒä¼šåœ¨æ¯æ¬¡è¿­ä»£æ—¶é¦–å…ˆä½¿ç”¨ `i` çš„å½“å‰å€¼ï¼Œç„¶åå°† `i` å‡ 1ã€‚
- å½“ `i` çš„å€¼ä¸º 5 æ—¶ï¼Œ`i--` ä¼šå…ˆå°† `i` çš„å€¼ 5 ç”¨äºåˆ¤æ–­å¾ªç¯æ¡ä»¶ï¼Œç„¶åå°† `i` å‡ 1 å˜æˆ 4ã€‚
- å¾ªç¯ä¼šç»§ç»­æ‰§è¡Œç›´åˆ° `i` çš„å€¼å˜æˆ 0ã€‚åœ¨ `i` ä¸º 0 æ—¶ï¼Œ`i--` ä¼šå°† `i` ç”¨äºåˆ¤æ–­æ¡ä»¶ï¼ˆ0ï¼‰åå†å°† `i` å‡ 1ã€‚æ­¤æ—¶ `i` å˜æˆ -1ï¼Œä½†å¾ªç¯å·²ç»ç»“æŸï¼Œå› ä¸ºåˆ¤æ–­æ¡ä»¶ `i--` åœ¨æ¯æ¬¡è¿­ä»£åä¼šä½¿ç”¨ `i` çš„å€¼ã€‚

æ‰€ä»¥ï¼Œ`i` çš„å€¼åœ¨å¾ªç¯ç»“æŸæ—¶æ˜¯ `-1`ï¼Œä½†å¾ªç¯è¿‡ç¨‹ä¸­ `i` çš„å€¼ä¸º 5, 4, 3, 2, 1, 0ã€‚

### æ­£ç‚¹åŸå­Makefileæ–‡ä»¶è¯¦è§£

```makefile
CROSS_COMPILE 	?= arm-linux-gnueabihf-		# å˜é‡ï¼Œäº¤å‰ç¼–è¯‘å·¥å…·é“¾çš„å‰ç¼€
TARGET 			?= i2c						# ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶çš„åç§°
CC				:= $(CROSS_COMPILE)gcc		# å®šä¹‰gccç¼–è¯‘å™¨
LD				:= $(CROSS_COMPILE)ld		# é“¾æ¥å™¨
OBJCOPY			:= $(CROSS_COMPILE)objcopy	# ç”Ÿæˆelfå¯æ‰§è¡Œæ–‡ä»¶
OBJDUMP			:= $(CROSS_COMPILE)objdump	# åæ±‡ç¼–

# LIBPATHï¼šé“¾æ¥å™¨çš„åº“è·¯å¾„å’Œåº“æ–‡ä»¶ã€‚åœ¨è¿™é‡ŒæŒ‡å®šäº†åº“è·¯å¾„å’Œ -lgcc é€‰é¡¹ã€‚
# å‘Šè¯‰é“¾æ¥å™¨åœ¨é“¾æ¥é˜¶æ®µéœ€è¦ä½¿ç”¨å“ªäº›åº“å’Œå“ªäº›åº“æ–‡ä»¶
# -lgcc -læ˜¯é“¾æ¥å™¨é€‰é¡¹çš„æ ‡å¿—ï¼Œè¡¨ç¤ºé“¾æ¥ä¸€ä¸ªåº“ gccæ˜¯è¦é“¾æ¥åº“çš„åç§°ï¼Œå®ƒé€šå¸¸æ˜¯GCCç¼–è¯‘å™¨è‡ªå¸¦çš„è¿è¡Œæ—¶åº“
# -L æ˜¯é“¾æ¥å™¨é€‰é¡¹çš„æ ‡å¿—ï¼Œè¡¨ç¤ºæŒ‡å®šä¸€ä¸ªåº“æ–‡ä»¶æœç´¢è·¯å¾„
# -lgccï¼šå‘Šè¯‰é“¾æ¥å™¨é“¾æ¥ GCC çš„è¿è¡Œæ—¶åº“ï¼ˆlibgccï¼‰ï¼Œè¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå®ƒæä¾›äº†ä¸€äº›åŸºæœ¬çš„æ”¯æŒåŠŸèƒ½ã€‚
# -L /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/lib/gcc/arm-linux-gnueabihf/4.9.4ï¼šæŒ‡å®šäº†ä¸€ä¸ªåº“æœç´¢è·¯å¾„ï¼Œé“¾æ¥å™¨ä¼šåœ¨è¿™ä¸ªè·¯å¾„ä¸‹æŸ¥æ‰¾ libgcc åŠå…¶ä»–åº“æ–‡ä»¶ã€‚
LIBPATH			:= -lgcc -L /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/lib/gcc/arm-linux-gnueabihf/4.9.4

# å¤´æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„
INCUDIRS		:= 	imx6u 		\
					bsp/clk		\
					bsp/delay	\
					bsp/led		\
					bsp/beep	\
					bsp/key		\
					bsp/gpio	\
					bsp/int		\
					bsp/exit	\
					bsp/epit	\
					bsp/keyfilter\
					bsp/uart	\
					bsp/lcd		\
					bsp/rtc		\
					bsp/ap3216c	\
					bsp/i2c		\
					stdio/include

# æºæ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„
SRCDIRS			:=	project		\
					bsp/clk		\
					bsp/delay	\
					bsp/led		\
					bsp/beep	\
					bsp/key		\
					bsp/gpio	\
					bsp/int		\
					bsp/exit	\
					bsp/epit	\
					bsp/keyfilter\
					bsp/uart	\
					bsp/lcd		\
					bsp/rtc		\
					bsp/ap3216c	\
					bsp/i2c		\
					stdio/lib
# è¿™ä¸ªå‡½æ•°ç”¨äºæ›¿æ¢å­—ç¬¦ä¸²ä¸­çš„æ¨¡å¼ï¼Œ%ï¼Œè¡¨ç¤ºåŒ¹é… INCUDIRS ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ã€‚å³å°†INCUDIRSä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ å‰éƒ½åŠ ä¸Š-I
# -Içš„ä½œç”¨-Ié€‰é¡¹åœ¨ç¼–è¯‘å™¨ä¸­ç”¨äºæŒ‡å®šå¤´æ–‡ä»¶çš„æœç´¢è·¯å¾„ã€‚å®ƒå‘Šè¯‰ç¼–è¯‘å™¨åœ¨å“ªé‡ŒæŸ¥æ‰¾ #include æŒ‡ä»¤ä¸­æŒ‡å®šçš„å¤´æ–‡ä»¶ã€‚
INCLUDE			:= $(patsubst %, -I %, $(INCUDIRS))

# æŸ¥æ‰¾æ‰€æœ‰æ±‡ç¼–æ–‡ä»¶å’ŒCæ–‡ä»¶ï¼ˆæ–‡ä»¶è·¯å¾„ï¼‰
# $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.S))
# foreachå‡½æ•°éå†åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ å¹¶ æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼ˆwildcardå‡½æ•°æ“ä½œï¼‰
# æŸ¥æ‰¾SRCDIRSä¸­æ¯ä¸ªè·¯å¾„å¹¶ä¸”å¤åˆ¶ç»™dir
# wildcardå‡½æ•°ç”¨äºåŒ¹é…ç¬¦åˆæŒ‡å®šæ¨¡å¼çš„æ–‡ä»¶ï¼Œæ‰¾åˆ°æ¯ä¸ªdirè·¯å¾„ä¸­çš„.Sæ–‡ä»¶

# å·¥ä½œæµç¨‹
# éå† $(SRCDIRS) å˜é‡ä¸­çš„æ¯ä¸€ä¸ªç›®å½•:
# $(foreach dir, $(SRCDIRS), ...) ä¼šä¾æ¬¡å°† $(SRCDIRS) ä¸­çš„æ¯ä¸ªç›®å½•èµ‹å€¼ç»™ dirã€‚

# å¯¹äºæ¯ä¸ªç›®å½•ï¼Œä½¿ç”¨ wildcard æŸ¥æ‰¾æ±‡ç¼–æºæ–‡ä»¶:
# $(wildcard $(dir)/*.S) æŸ¥æ‰¾å½“å‰ç›®å½• $(dir) ä¸‹æ‰€æœ‰æ‰©å±•åä¸º .S çš„æ–‡ä»¶ã€‚

# å°†æ‰€æœ‰æ‰¾åˆ°çš„æ–‡ä»¶åˆå¹¶æˆä¸€ä¸ªåˆ—è¡¨:
# foreach å‡½æ•°å°†æ¯æ¬¡ wildcard æ‰¾åˆ°çš„æ–‡ä»¶åˆ—è¡¨åˆå¹¶æˆä¸€ä¸ªå¤§çš„æ–‡ä»¶åˆ—è¡¨ï¼Œæœ€ç»ˆèµ‹å€¼ç»™ SFILES å˜é‡ã€‚
SFILES			:= $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.S))
CFILES			:= $(foreach dir, $(SRCDIRS), $(wildcard $(dir)/*.c))

# è·å–æºæ–‡ä»¶çš„æ–‡ä»¶åï¼ˆä¸åŒ…æ‹¬è·¯å¾„ï¼‰
SFILENDIR		:= $(notdir $(SFILES))
CFILENDIR		:= $(notdir $(CFILES))

# å¯¹åº”çš„ç›®æ ‡æ–‡ä»¶ï¼ˆ.oï¼‰ï¼Œæ”¾åœ¨obj/ä¸‹
SOBJS			:= $(patsubst %, obj/%, $(SFILENDIR:.S=.o))
COBJS			:= $(patsubst %, obj/%, $(CFILENDIR:.c=.o))

# æ‰€æœ‰ç›®æ ‡æ–‡ä»¶åˆ—è¡¨
OBJS 			:= $(SOBJS)$(COBJS)

# æŒ‡å®šmakeæŸ¥æ‰¾æºæ–‡ä»¶çš„è·¯å¾„
VPATH			:= $(SRCDIRS)

# æ„å»ºè§„åˆ™
$(TARGET).bin: $(OBJS)
	$(LD) -Timx6u.lds -o $(TARGET).elf $^ $(LIBPATH)
	$(OBJCOPY) -O binary -S $(TARGET).elf $@
	$(OBJDUMP) -D -m arm $(TARGET).elf > $(TARGET).dis

$(COBJS): obj/%.o : %.c
	$(CC) $(INCLUDE) -Wa,-mimplicit-it=thumb -fno-builtin -c -Wall -nostdlib -O2 -o $@ $<
$(SOBJS): obj/%.o : %.S
	$(CC) $(INCLUDE) -fno-builtin -c -Wall -nostdlib -O2 -o $@ $<

.PHONY:clean
clean:
	rm -rf $(OBJS) $(TARGET).elf $(TARGET).bin $(TARGET).dis load.imx
	rm -rf *.elf *.bin *.dis load.imx

```



### å¯åŠ¨æµç¨‹

#### æ±‡ç¼–å¯åŠ¨ç¨‹åº

- è®¾ç½®ä¸­æ–­å‘é‡è¡¨

- å®šä¹‰ä¸­æ–­æœåŠ¡ç¨‹åº
  - å¤ä½ä¸­æ–­æœåŠ¡ç¨‹åº
    - å…³é—­å…¨å±€ä¸­æ–­(cpsid i)ã€‚
    - ä½¿ç”¨CP15åå¤„ç†å™¨ç®¡ç†STCLRå¯„å­˜å™¨ï¼Œå…³é—­ICacheï¼ŒDCacheï¼ŒMMUã€‚
    - **æ¸…é™¤BSSæ®µã€‚**é“¾æ¥è„šæœ¬(.lds)ä¸­è®¾ç½®BSSæ®µçš„èµ·å§‹å’Œç»ˆæ­¢åœ°å€ï¼Œä½¿ç”¨å¾ªç¯æ¸…é™¤è¿™ä¸ªåœ°å€èŒƒå›´å†…çš„æ‰€æœ‰å†…å®¹ã€‚
    - åˆ†åˆ«è®¾ç½®å¤„ç†å™¨çš„9ç§å·¥ä½œæ¨¡å¼å¹¶å®šä¹‰å¯¹åº”çš„SPæŒ‡é’ˆã€‚æŸ¥çœ‹å„ç§å·¥ä½œæ¨¡å¼ä¸‹16ä¸ªå¯„å­˜å™¨çš„å…±ç”¨æ¨¡å¼ã€‚æœ€åè®¾ç½®CPUå·¥ä½œæ¨¡å¼ä¸º**SVCæ¨¡å¼**
    - æ‰“å¼€IRQä¸­æ–­(cpsie i)ã€‚
    - è·³è½¬åˆ°mainå‡½æ•°ã€‚
    
  - ç¼–å†™IRQä¸­æ–­æœåŠ¡å‡½æ•°
  
    - 1. ä¿æŠ¤ç°åœºã€‚è§¦å‘ä¸­æ–­çš„æœºåˆ¶é¦–å…ˆä¼šä¿å­˜(push)ä¸€äº›å¯„å­˜å™¨ï¼Œä¸€äº›ä¸ä¼šè‡ªåŠ¨ä¿å­˜çš„å¯„å­˜å™¨(r0-r3, r12)éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨ä¿å­˜ï¼Œ`push {lr}` ç”¨äºä¿å­˜å‡½æ•°è°ƒç”¨è¿”å›åœ°å€ã€‚
  
         ```csv
         mrs r0, spsr	// ä¿å­˜spsr
         push {r0}
         ```

      2. è¯»å–GICC_IARå¯„å­˜å™¨ï¼Œè¿™ä¸ªå¯„å­˜å™¨ä¿å­˜ç€å½“å‰å‘ç”Ÿä¸­æ–­çš„ä¸­æ–­å·ï¼Œé€šè¿‡è¿™ä¸ªä¸­æ–­å·æ¥å†³å®šæ¥è°ƒç”¨å“ªä¸ªä¸­æ–­æœåŠ¡å‡½æ•°ã€‚
  
      3. è¿›å…¥svcæ¨¡å¼ï¼Œpush {lr}ï¼Œè·³è½¬æ‰§è¡Œsystem_irqhandlerã€‚
  
      4. æ‰§è¡Œå®Œåpop {lr}ã€‚å›åˆ°irqæ¨¡å¼ã€‚
  
      5. ä¸­æ–­æ‰§è¡Œå®Œæˆï¼Œå†™GICC_EOIRå¯„å­˜å™¨ã€‚å¤„ç†å®Œå…·ä½“ä¸­æ–­åï¼Œéœ€è¦å°†å¯¹åº”çš„ä¸­æ–­IDå€¼å†™å…¥åˆ°GICC_EOIRä¸­ é€šçŸ¥GICå½“å‰å¤„ç†ä¸­æ–­å·²ç»å¤„ç†å®Œæ¯•ï¼Œå…è®¸GICåˆ†é…ä¸‹ä¸€ä¸ªä¸­æ–­ã€‚
  
      6. æ¢å¤ç°åœºã€‚
  
         ```csv
         pop {r0-r3, r12}
         subs pc, lr, #4
         /* pc = lr-4æ˜¯å› ä¸ºarmçš„æŒ‡ä»¤æ˜¯ä¸‰çº§æµæ°´çº¿ç»“æ„ï¼Œå‡å¦‚åœ¨æ‰§è¡Œ0x2000æŒ‡ä»¤æ—¶è§¦å‘ä¸­æ–­ï¼Œpcæ­¤æ—¶æ˜¯  * æŒ‡å‘0x2008çš„ï¼Œå¦‚æœä¸­æ–­ç»“æŸåè¿”å›åˆ°0x2008å¼€å§‹æ‰§è¡Œé‚£ä¹ˆå°†ä¼šæ¼æ‰ä¸€ä¸ªæŒ‡ä»¤ï¼Œè¿™ä¸ªåæœä¼šå¾ˆä¸¥é‡ */
         ```
  
  
  - Cè¯­è¨€ä¸­ç¼–å†™ä¸­æ–­ç›¸å…³å‡½æ•°ã€‚
  
    - ä¸­æ–­åˆå§‹åŒ–å‡½æ•°ã€‚
  
    - å®šä¹‰ä¸­æ–­å¤„ç†å‡½æ•°(å‡½æ•°æŒ‡é’ˆ)ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼ŒåŒ…æ‹¬iarï¼Œparamã€‚åˆ›å»ºåŒ…æ‹¬å‡½æ•°æŒ‡é’ˆå’Œå‚æ•°çš„ä¸­æ–­å¤„ç†ç»“æ„ä½“ã€‚
  
      ```C
      typedef struct _sys_irq_handler
      {
          system_irq_handler_t irqHandler;            /* ä¸­æ–­å¤„ç†å‡½æ•° */
          void *userParam;                            /* ä¸­æ–­å¤„ç†å‡½æ•°çš„å‚æ•° */
      }sys_irq_handle_t;
      ```
  
    - å®šä¹‰ä¸­æ–­å¤„ç†å‡½æ•°è¡¨(å­˜æ”¾ä¸­æ–­å¤„ç†å‡½æ•°ç»“æ„ä½“ç±»å‹çš„æ•°ç»„)ã€‚
  
      ```c
      static sys_irq_handle_t irqTable[NUMBER_OF_INT_VECTORS];            /* 160ä¸ª */
      ```
  
      ç›¸å½“äºç»™äº†160ä¸ªä¸­æ–­å¤„ç†å‡½æ•°ã€‚å¯¹åº”ç€ç›¸åº”çš„ä¸­æ–­å·ã€‚
  
    - åˆå§‹åŒ–ä¸­æ–­å¤„ç†å‡½æ•°è¡¨ã€‚
  
      ```c
      void system_irq_init(void)
      {
          unsigned int i = 0;
          irqNesting = 0;
          for (i = 0; i < NUMBER_OF_INT_VECTORS; i++)
          {
              irqTable[i].irqHandler = default_irqHandler;
              irqTable[i].userParam  = NULL;
          } 
      }
      ```
  
    - æ³¨å†Œä¸­æ–­å¤„ç†å‡½æ•°
  
      ```c
      void system_register_irqhandler(IRQn_Type irq, system_irq_handler_t handler, void *userparam)
      {
          irqTable[irq].irqHandler = handler;
          irqTable[irq].userParam  = userparam;
      }
      ```
  
    - å…·ä½“çš„ä¸­æ–­å¤„ç†å‡½æ•°
  
      ```c
      void system_irqhandler(unsigned int gicciar)
      {
          /* æ£€æŸ¥ä¸­æ–­ID */
          uint32_t intNum = gicciar & 0x3ff;
          if(intNum >= NUMBER_OF_INT_VECTORS)
          {
              return;
          }
          irqNesting++;
          /* æ ¹æ®ä¸­æ–­IDå·ï¼Œè¯»å–ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œç„¶åæ‰§è¡Œ */
          irqTable[intNum].irqHandler(intNum, irqTable[intNum].userParam);
          irqNesting--;
      }
      ```
  
      

#### é“¾æ¥è„šæœ¬

##### é“¾æ¥è„šæœ¬å…·ä½“è§£é‡Š

è¿™ä¸ªä»£ç æ®µæ˜¯ä¸€ä¸ªGNU LDï¼ˆLinker Scriptï¼‰è„šæœ¬ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•å°†ç¨‹åºçš„ä¸åŒéƒ¨åˆ†å¸ƒå±€åˆ°å†…å­˜ä¸­ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸ªè„šæœ¬å®šä¹‰äº†å„ä¸ªæ®µï¼ˆsectionsï¼‰åœ¨å†…å­˜ä¸­çš„ä½ç½®å’Œå¯¹é½æ–¹å¼ã€‚

1. **èµ·å§‹åœ°å€è®¾ç½®**:

   ```ld
   . = 0X87800000;
   ```

   è¿™è¡Œä»£ç å°†é“¾æ¥å™¨çš„å½“å‰ä½ç½®ï¼ˆå³å†…å­˜åœ°å€ï¼‰è®¾ç½®ä¸º`0x87800000`ã€‚è¿™æ„å‘³ç€æ¥ä¸‹æ¥çš„æ‰€æœ‰æ®µéƒ½ä¼šä»è¿™ä¸ªåœ°å€å¼€å§‹æ”¾ç½®ã€‚

2. **.textæ®µ**:

   ```ld
   .text : 
   {
       obj/start.o
       *(.text)
   }
   ```

   `.text`æ®µé€šå¸¸åŒ…å«ç¨‹åºçš„ä»£ç éƒ¨åˆ†ã€‚è¿™é‡ŒæŒ‡å®šäº†`obj/start.o`æ–‡ä»¶ä¸­çš„å†…å®¹é¦–å…ˆæ”¾å…¥`.text`æ®µï¼Œç„¶åå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶ä¸­çš„`.text`æ®µå†…å®¹ä¾æ¬¡æ”¾å…¥ã€‚

3. **.rodataæ®µ**:

   ```ld
   .rodata ALIGN(4) : {*(.rodata*)}
   ```

   `.rodata`æ®µç”¨äºå­˜å‚¨åªè¯»æ•°æ®ã€‚è¿™é‡Œå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶ä¸­çš„`.rodata`æ®µå†…å®¹æ”¾å…¥ï¼Œå¹¶ä¸”å°†å…¶å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œã€‚

4. **.dataæ®µ**:

   ```ld
   .data ALIGN(4) : {*(.data)}
   ```

   `.data`æ®µç”¨äºå­˜å‚¨å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚è¿™é‡Œå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶ä¸­çš„`.data`æ®µå†…å®¹æ”¾å…¥ï¼Œå¹¶ä¸”å°†å…¶å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œã€‚

5. **å¯¹é½æŒ‡é’ˆ**:

   ```ld
   . = ALIGN(4);
   ```

   è¿™è¡Œä»£ç å°†å½“å‰ä½ç½®å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œã€‚

6. **__bss_startç¬¦å·**:

   ```ld
   __bss_start = .;
   ```

   å®šä¹‰ä¸€ä¸ªç¬¦å·`__bss_start`ï¼Œå…¶å€¼ä¸ºå½“å‰ä½ç½®ï¼ˆå³`bss`æ®µçš„èµ·å§‹åœ°å€ï¼‰ã€‚

7. **.bssæ®µ**:

   ```ld
   .bss ALIGN(4) : {*(.bss) *(common)}
   ```

   `.bss`æ®µç”¨äºå­˜å‚¨æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚è¿™é‡Œå°†æ‰€æœ‰è¾“å…¥æ–‡ä»¶ä¸­çš„`.bss`æ®µå’Œ`common`æ®µå†…å®¹æ”¾å…¥ï¼Œå¹¶ä¸”å°†å…¶å¯¹é½åˆ°4å­—èŠ‚è¾¹ç•Œã€‚

8. **__bss_endç¬¦å·**:

   ```ld
   __bss_end = .;
   ```

   å®šä¹‰ä¸€ä¸ªç¬¦å·`__bss_end`ï¼Œå…¶å€¼ä¸ºå½“å‰ä½ç½®ï¼ˆå³`bss`æ®µçš„ç»“æŸåœ°å€ï¼‰ã€‚

#### CP15åå¤„ç†å™¨å¯„å­˜å™¨

CP15å¯„å­˜å™¨æ˜¯ARMæ¶æ„ä¸­çš„åå¤„ç†å™¨15å¯„å­˜å™¨ï¼Œä¸»è¦ç”¨äºé…ç½®å’Œç®¡ç†ç³»ç»Ÿæ§åˆ¶ã€å†…å­˜ç®¡ç†ã€è°ƒè¯•ç­‰åŠŸèƒ½ã€‚CP15å¯„å­˜å™¨åœ¨ARMå¤„ç†å™¨ä¸­æ‰®æ¼”ç€å…³é”®è§’è‰²ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦åŠŸèƒ½å’Œä½œç”¨ï¼š

1. **ç³»ç»Ÿæ§åˆ¶**ï¼š
   - æ§åˆ¶å¯„å­˜å™¨ï¼ˆå¦‚SCTLRï¼‰ï¼šç”¨äºé…ç½®å¤„ç†å™¨çš„è¿è¡Œæ¨¡å¼å’Œç‰¹æ€§ï¼Œä¾‹å¦‚å¯ç”¨æˆ–ç¦ç”¨ç¼“å­˜ã€MMUã€å¼‚å¸¸å¤„ç†ç­‰ã€‚
2. **å†…å­˜ç®¡ç†**ï¼š
   - TLBï¼ˆTranslation Lookaside Bufferï¼‰æ§åˆ¶ï¼šç®¡ç†TLBçš„åˆ·æ–°ã€æ— æ•ˆåŒ–ç­‰æ“ä½œã€‚
   - é¡µè¡¨åŸºåœ°å€å¯„å­˜å™¨ï¼šå­˜å‚¨é¡µè¡¨çš„åŸºåœ°å€ï¼Œç”¨äºåœ°å€è½¬æ¢ã€‚
3. **ä¸­æ–­å’Œå¼‚å¸¸å¤„ç†**ï¼š
   - ä¸­æ–­æ§åˆ¶å¯„å­˜å™¨ï¼šé…ç½®ä¸­æ–­çš„ä¼˜å…ˆçº§ã€ä½¿èƒ½çŠ¶æ€ç­‰ã€‚
   - *å¼‚å¸¸å‘é‡è¡¨åŸºåœ°å€å¯„å­˜å™¨ï¼šæŒ‡å®šå¼‚å¸¸å‘é‡è¡¨çš„åœ°å€*ã€‚
4. **æ€§èƒ½ç›‘æ§**ï¼š
   - æ€§èƒ½ç›‘æ§å¯„å­˜å™¨ï¼šç”¨äºæ€§èƒ½è®¡æ•°ã€äº‹ä»¶ç›‘æ§ï¼Œå¸®åŠ©å¼€å‘äººå‘˜ä¼˜åŒ–ä»£ç æ€§èƒ½ã€‚
5. **è°ƒè¯•å’Œè·Ÿè¸ª**ï¼š
   - è°ƒè¯•æ§åˆ¶å¯„å­˜å™¨ï¼šé…ç½®è°ƒè¯•åŠŸèƒ½ã€æ–­ç‚¹ã€è§‚å¯Ÿç‚¹ç­‰ã€‚
   - è·Ÿè¸ªæ§åˆ¶å¯„å­˜å™¨ï¼šé…ç½®è·Ÿè¸ªåŠŸèƒ½ï¼Œç”¨äºç¨‹åºæ‰§è¡Œæµçš„è®°å½•å’Œåˆ†æã€‚
6. **ç”µæºç®¡ç†**ï¼š
   - ç”µæºæ§åˆ¶å¯„å­˜å™¨ï¼šé…ç½®ä½åŠŸè€—æ¨¡å¼ã€èŠ‚èƒ½ç‰¹æ€§ç­‰ã€‚

CP15å¯„å­˜å™¨åœ¨ARMå¤„ç†å™¨çš„è¿è¡Œå’Œç®¡ç†ä¸­å‘æŒ¥ç€é‡è¦ä½œç”¨ï¼Œä½¿ç³»ç»Ÿèƒ½å¤Ÿçµæ´»ã€é«˜æ•ˆåœ°è¿›è¡Œé…ç½®å’Œæ§åˆ¶ã€‚



#### SCTLRå¯„å­˜å™¨

SCTLRï¼ˆSystem Control Registerï¼‰æ˜¯ARMæ¶æ„ä¸­çš„ä¸€ä¸ªé‡è¦å¯„å­˜å™¨ï¼Œä½äºCP15åå¤„ç†å™¨ä¸­ã€‚å®ƒç”¨äºæ§åˆ¶å¤„ç†å™¨çš„å„ç§ç³»ç»Ÿçº§ç‰¹æ€§å’Œæ“ä½œæ¨¡å¼ã€‚SCTLRçš„ä½œç”¨éå¸¸å¹¿æ³›ï¼Œä¸‹é¢æ˜¯å…¶ä¸»è¦åŠŸèƒ½å’Œæ§åˆ¶ä½ï¼š

1. **MMUå¯ç”¨**ï¼š
   - Mä½ï¼šæ§åˆ¶MMUï¼ˆå†…å­˜ç®¡ç†å•å…ƒï¼‰çš„å¯ç”¨å’Œç¦ç”¨ã€‚
     - 0ï¼šç¦ç”¨MMU
     - 1ï¼šå¯ç”¨MMU
2. **å¯¹é½æ£€æŸ¥**ï¼š
   - Aä½ï¼šæ§åˆ¶æœªå¯¹é½æ•°æ®è®¿é—®çš„æ£€æŸ¥ã€‚
     - 0ï¼šç¦ç”¨å¯¹é½æ£€æŸ¥
     - 1ï¼šå¯ç”¨å¯¹é½æ£€æŸ¥
3. **æ•°æ®ç¼“å­˜å¯ç”¨**ï¼š
   - Cä½ï¼šæ§åˆ¶æ•°æ®ç¼“å­˜çš„å¯ç”¨å’Œç¦ç”¨ã€‚
     - 0ï¼šç¦ç”¨æ•°æ®ç¼“å­˜
     - 1ï¼šå¯ç”¨æ•°æ®ç¼“å­˜
4. **æŒ‡ä»¤ç¼“å­˜å¯ç”¨**ï¼š
   - Iä½ï¼šæ§åˆ¶æŒ‡ä»¤ç¼“å­˜çš„å¯ç”¨å’Œç¦ç”¨ã€‚
     - 0ï¼šç¦ç”¨æŒ‡ä»¤ç¼“å­˜
     - 1ï¼šå¯ç”¨æŒ‡ä»¤ç¼“å­˜
5. **ç³»ç»Ÿä¿æŠ¤**ï¼š
   - Sä½ï¼šé…ç½®ç³»ç»Ÿä¿æŠ¤ï¼Œä½¿ç³»ç»ŸåŒºå’Œç”¨æˆ·åŒºçš„è®¿é—®æƒé™ä¸åŒã€‚
     - 0ï¼šç¦ç”¨ç³»ç»Ÿä¿æŠ¤
     - 1ï¼šå¯ç”¨ç³»ç»Ÿä¿æŠ¤
6. **å†™ç¼“å†²åŒº**ï¼š
   - Bä½ï¼šæ§åˆ¶å†™ç¼“å†²åŒºçš„å¯ç”¨å’Œç¦ç”¨ã€‚
     - 0ï¼šç¦ç”¨å†™ç¼“å†²åŒº
     - 1ï¼šå¯ç”¨å†™ç¼“å†²åŒº
7. **å°ç«¯æ¨¡å¼/å¤§ç«¯æ¨¡å¼**ï¼š
   - Eä½ï¼šé…ç½®å¤„ç†å™¨çš„å­—èŠ‚åºæ¨¡å¼ã€‚
     - 0ï¼šå°ç«¯æ¨¡å¼
     - 1ï¼šå¤§ç«¯æ¨¡å¼
8. **å¯¹ç§°å¤šå¤„ç†æ”¯æŒ**ï¼š
   - SMPä½ï¼šå¯ç”¨æˆ–ç¦ç”¨å¯¹ç§°å¤šå¤„ç†ï¼ˆSMPï¼‰æ”¯æŒã€‚
     - 0ï¼šç¦ç”¨SMP
     - 1ï¼šå¯ç”¨SMP
9. **æŒ‡ä»¤é¢„å–**ï¼š
   - Zä½ï¼šæ§åˆ¶æŒ‡ä»¤é¢„å–ã€‚
     - 0ï¼šç¦ç”¨é¢„å–
     - 1ï¼šå¯ç”¨é¢„å–
10. **åˆ†æ”¯é¢„æµ‹**ï¼š
    - Pä½ï¼šæ§åˆ¶åˆ†æ”¯é¢„æµ‹åŠŸèƒ½ã€‚
      - 0ï¼šç¦ç”¨åˆ†æ”¯é¢„æµ‹
      - 1ï¼šå¯ç”¨åˆ†æ”¯é¢„æµ‹

SCTLRå¯„å­˜å™¨ä¸­çš„è¿™äº›æ§åˆ¶ä½ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®éœ€æ±‚é…ç½®å¤„ç†å™¨çš„è¿è¡Œæ¨¡å¼å’Œç‰¹æ€§ï¼Œä»è€Œä¼˜åŒ–æ€§èƒ½å’Œå®‰å…¨æ€§ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæ“ä½œç³»ç»Ÿæˆ–å›ºä»¶ä¼šè®¾ç½®è¿™äº›ä½ï¼Œä»¥ç¡®ä¿å¤„ç†å™¨ä»¥é¢„æœŸçš„æ–¹å¼è¿è¡Œã€‚



#### ä¸­æ–­åç§»åœ°å€å’Œç¨‹åºå…¥å£åœ°å€

1. ä¸­æ–­å‘é‡è¡¨å’Œç¨‹åºèµ·å§‹åœ°å€é€šå¸¸ä¸ä¼šè®¾ç½®ç›¸åŒçš„å€¼ï¼Œè¿™ä¼šå¯¼è‡´ä¸¤è€…ä¹‹é—´çš„å†²çªã€‚ç„¶è€Œï¼Œåœ¨æŸäº›ç‰¹å®šæƒ…å†µä¸‹ç‰¹åˆ«æ˜¯åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œå¯ä»¥é€šè¿‡ç‰¹æ®Šçš„é…ç½®å’Œä½¿ç”¨ä¸åŒæ–¹æ³•æ¥å®ç°è¿™ç§è®¾ç½®ã€‚
2. ä¸­æ–­å‘é‡è¡¨åœ¨_start:ä¸­è®¾ç½®ã€‚

### GPIOä¸­æ–­ç¨‹åº

- æ±‡ç¼–æ–‡ä»¶

  - åœ¨æ±‡ç¼–å¯åŠ¨ç¨‹åºä¸­é…ç½®å¥½ä¸­æ–­å‘é‡è¡¨å’Œä¸­æ–­æœåŠ¡å‡½æ•°IRQ_Hanlderã€‚

- BSP_INT(ä¸­æ–­é…ç½®æ–‡ä»¶)

  - åˆ›å»ºä¸­æ–­å‡½æ•°æŒ‡é’ˆç±»å‹ã€‚
  - åˆ›å»ºä¸­æ–­å‡½æ•°ç»“æ„ä½“ï¼ŒåŒ…æ‹¬ä¸­æ–­æœåŠ¡å‡½æ•°å’Œä¸­æ–­æœåŠ¡å‡½æ•°å‚æ•°ã€‚
  - åˆ›å»ºå˜é‡è®°å½•ä¸­æ–­åµŒå¥—æ•°é‡ã€‚
  - åˆ›å»ºä¸­æ–­å¤„ç†å‡½æ•°è¡¨ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚
  - åˆ›å»ºåˆå§‹åŒ–ä¸­æ–­å‡½æ•°è¡¨å‡½æ•°ï¼Œä¸­æ–­æ•°é‡æ¸…é›¶ã€‚
  - ä¸­æ–­åˆå§‹åŒ–å‡½æ•°(åˆå§‹åŒ–GICï¼Œåˆå§‹åŒ–ä¸­æ–­å‡½æ•°è¡¨ï¼Œè®¾ç½®ä¸­æ–­å‘é‡åç§»)ã€‚
  - ä¸­æ–­å¤„ç†æ³¨å†Œå‡½æ•°ã€‚
  - ç³»ç»Ÿä¸­æ–­å¤„ç†å‡½æ•°(IRQè·³è½¬)ï¼Œæ£€æŸ¥ä¸­æ–­å¤„ç†å‡½æ•°IDå·ï¼Œä¸­æ–­æ•°åŠ ä¸€ï¼Œè¿è¡Œä¸­æ–­irqTable[intNum]ã€‚

- BSP_GPIOä¸­æ–­æ–‡ä»¶é…ç½®

  - å®šä¹‰æšä¸¾æ•°æ®ä¸­æ–­å‡ºå‘ç±»å‹gpio_interrupt_mode_tã€‚
  - GPIOé…ç½®ç»“æ„ä½“ä¸­åŠ ä¸Šä¸­æ–­ç±»å‹ã€‚
  - GPIOä¸­æ–­é…ç½®å‡½æ•°ï¼Œè¾“å…¥å‚æ•°GPIO*ï¼Œpinï¼Œgpio_interrupt_mode_tã€‚
    - å®šä¹‰icræŒ‡é’ˆã€‚å¹¶`icrShift = pin;`
    - SELç½®1æ—¶è®¾ç½®ICRå¯„å­˜å™¨æ— æ•ˆï¼Œæ‰€ä»¥ç»™æ­¤å¯„å­˜å™¨æ¸…é›¶ã€‚
    - ä½16ä½`icr = &(base->ICR1);`é«˜16ä½`icrShift -= 16;`
    - åˆ¤æ–­ä¸­æ–­å‡ºå‘ç±»å‹ï¼Œè®¾ç½®ICRå¯„å­˜å™¨ã€‚
  - GPIOåˆå§‹åŒ–å‡½æ•°ä¸­åŠ å…¥GPIOä¸­æ–­é…ç½®å‡½æ•°ã€‚
  - å®šä¹‰å‡½æ•°ï¼šä½¿èƒ½GPIOä¸­æ–­ï¼Œç¦æ­¢GPIOä¸­æ–­ï¼Œæ¸…é™¤ä¸­æ–­æ ‡å¿—ä½(è¯¥å‡½æ•°ä½œç”¨ä½é€€å‡ºä¸­æ–­)

- BSP_EXITå¤–éƒ¨ä¸­æ–­é…ç½®æ–‡ä»¶

  - å¤–éƒ¨ä¸­æ–­åˆå§‹åŒ–å‡½æ•°

    - å®šä¹‰gpioé…ç½®ç»“æ„ä½“

    - å¼•è„šå¤ç”¨ï¼Œç”µæ°”å±æ€§ä¸Šæ‹‰è¾“å…¥ã€‚

    - GPIOåˆå§‹åŒ–ã€‚

    - GICä½¿èƒ½ä¸­æ–­ã€‚

    - æ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ã€‚

    - gpioä¸­æ–­ä½¿èƒ½ã€‚

      ```c
      GIC_EnableIRQ(GPIO1_Combined_16_31_IRQn);
      system_register_irqhandler(GPIO1_Combined_16_31_IRQn, gpio1_io18_irqhandler, NULL);
      /* ä½¿èƒ½ä¸­æ–­ä¹‹å‰éœ€è¦å…ˆæ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œå¦åˆ™ä½¿èƒ½åæ¥ä¸­æ–­å¯èƒ½ä¼šå‡ºé—®é¢˜ */
      gpio_enableint(GPIO1, 18);
      ```

  - ä¸­æ–­æœåŠ¡å‡½æ•°ã€‚

### EPITä¸­æ–­

- ä¸­æ–­åˆå§‹åŒ–å‡½æ•°

  - è¾“å…¥å‚æ•°ä¸ºåˆ†é¢‘å€¼å’Œè½½å…¥å€¼ã€‚

    ```c
    void epit1_int(unsigned int frac, unsigned int value)
    ```

  - åˆ¤æ–­åˆ†é¢‘æ•°æ˜¯å¦å¤§äº4095ã€‚

  - é…ç½®EPITä¸­æ–­å¯„å­˜å™¨ã€‚

    ```c
    /* é…ç½®EPITçš„CRå¯„å­˜å™¨ */
    EPIT1->CR = 0;
    /**
      * bit1=1ï¼Œè®¡æ•°å™¨ä»loadå€¼æˆ–è€…0xffffffffå¼€å§‹è®¡æ•°
      * bit2=1ä½¿èƒ½æ¯”è¾ƒä¸­æ–­
      * bit3=1ä»å¯„å­˜å™¨è®°å½•çš„å€¼é‡æ–°è®¡æ•°
      * bit4-15åˆ†é…å€¼frac
      * bit24=1è®¾ç½®å®šæ—¶å™¨æ—¶é’Ÿæº
      */
    EPIT1->CR = (1 << 1) | (1 << 2) | (1 << 3) | (frac << 4) | (1 << 24);
    EPIT1->LR = value;
    EPIT1->CMPR =0;
    ```

  - GICä½¿èƒ½

  - æ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°

  - å¼€å¯ä¸­æ–­

    ```c
    /* åˆå§‹åŒ–ä¸­æ–­ */
    GIC_EnableIRQ(EPIT1_IRQn);
    system_register_irqhandler(EPIT1_IRQn, epit1_irqhandler, NULL);   
    /* æ‰“å¼€EPIT1 */ 
    EPIT1->CR |= (1 << 0);
    ```

- EPIT1ä¸­æ–­æœåŠ¡å‡½æ•°

  ```c
  void epit1_irqhandler(unsigned int gicciar, void *param)
  {
      static unsigned char state = 0;
      state = !state;
      if (EPIT1->SR & (1 << 0))   /* ä¸­æ–­å‘ç”Ÿäº† */
      {
          led_switch(LED0, state);
      }
      /* æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ */
      EPIT1->SR |= (1 << 0);
  }
  ```

### å®šæ—¶å™¨æŒ‰é”®æ¶ˆæŠ–

- å¤–éƒ¨ä¸­æ–­åˆå§‹åŒ–

  ```c
  void keyfilter_init(void)
  {
      gpio_pin_config_t key_config;
      IOMUXC_SetPinMux(IOMUXC_UART1_CTS_B_GPIO1_IO18, 0);                 //è®¾ç½®å¼•è„šå¤ç”¨ï¼ŒGPIO1_18
      IOMUXC_SetPinConfig(IOMUXC_UART1_CTS_B_GPIO1_IO18, 0xf080);         //è®¾ç½®å¼•è„šç”µæ°”å±æ€§ è®¾ç½®ä¸ºä¸Šæ‹‰è¾“å…¥
  
      /* GPIOåˆå§‹åŒ– */
      key_config.direction = kGPIO_DigitalInput;
      key_config.interruptMode = kGPIO_IntFallingEdge;
      key_config.outputLogic = 1;
      gpio_init(GPIO1, 18, &key_config);      //è®¾ç½®å¼•è„šä¸ºè¾“å…¥
  
      GIC_EnableIRQ(GPIO1_Combined_16_31_IRQn);
      system_register_irqhandler(GPIO1_Combined_16_31_IRQn, gpio1_16_32_irqhandler, NULL);
      /* ä½¿èƒ½ä¸­æ–­ä¹‹å‰éœ€è¦å…ˆæ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œå¦åˆ™ä½¿èƒ½åæ¥ä¸­æ–­å¯èƒ½ä¼šå‡ºé—®é¢˜ */
      gpio_enableint(GPIO1, 18);
      filtertimer_init(66000000/100); //å®šæ—¶å™¨åˆå§‹åŒ–æ”¾åœ¨å¤–éƒ¨ä¸­æ–­åˆå§‹åŒ–å‡½æ•°ä¸­
  }
  ```

  

- å®šæ—¶å™¨ä¸­æ–­åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–å®šæ—¶å™¨,ä½†ä¸ä½¿èƒ½ï¼Œè¦åœ¨æŒ‰é”®ä¸‹é™æ²¿ä¸­æ–­è§¦å‘ä¹‹ååœ¨æŒ‰é”®çš„ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­å¼€å¯ï¼Œå¼€å§‹è®¡æ•°ï¼Œè®¡æ•°æ»¡è¶³å®šä¹‰çš„æ—¶é—´è§¦å‘å®šæ—¶å™¨ä¸­æ–­ã€‚

  ```c
  void filtertimer_init(unsigned int value)
  {
      EPIT1->CR = 0;
      EPIT1->CR = (1 << 1) | (1 << 2) | (1 << 3) | (1 << 24);
      EPIT1->LR = value;
      EPIT1->CMPR =0;
      
      /* åˆå§‹åŒ–ä¸­æ–­ */
      GIC_EnableIRQ(EPIT1_IRQn);
      system_register_irqhandler(EPIT1_IRQn, filtertimer_irqhandler, NULL);   
  }
  ```

- å¤–éƒ¨ä¸­æ–­æœåŠ¡å‡½æ•°

  ```c
  void gpio1_16_32_irqhandler(unsigned int gicciar, void *param)
  {
      /* å¼€å¯å®šæ—¶å™¨ */
      filtertimer_restart(66000000/100);
      /* æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ */
      gpio_clearintflags(GPIO1, 18);
  }
  ```

- å®šæ—¶å™¨ä¸­æ–­æœåŠ¡å‡½æ•°

  ```c
  void filtertimer_irqhandler(unsigned int gicciar, void *param)
  {
      static unsigned char state = OFF;
      
      if(EPIT1->SR & (1 << 0))
      {
          /* å…³é—­å®šæ—¶å™¨ */
          filtertimer_stop();
          if (gpio_pinread(GPIO1, 18) == 0)
          {
              state = !state;
              beep_switch(state);
          }
      }
      /* æ¸…é™¤ä¸­æ–­æ ‡å¿—ä½ */
      EPIT1->SR |= (1 << 0);
  }
  ```

- å…³é—­EPIT1å®šæ—¶å™¨

  ```C
  /* å…³é—­EPIT1å®šæ—¶å™¨ */
  void filtertimer_stop(void)
  {
      EPIT1->CR &= ~(1 << 0);
  }
  ```

  

- å¼€å¯EPIT1å®šæ—¶å™¨

  ```c
  /* å¼€å¯EPIT1å®šæ—¶å™¨ */
  void filtertimer_restart(unsigned int value)
  {
      EPIT1->CR &= ~(1 << 0);
      EPIT1->LR = value;
      EPIT1->CR |= ( 1<< 0);
  }
  ```

### GPTå®šæ—¶å™¨å®ç°é«˜ç²¾åº¦å»¶æ—¶

#### å®éªŒä¸€ï¼šè¿›å…¥GPTä¸­æ–­å®ç°LEDé—ªçƒ

- å»¶æ—¶åˆå§‹åŒ–å‡½æ•°

  - åˆå§‹åŒ–ç›¸å…³å¯„å­˜å™¨

    CRå¯„å­˜å™¨ï¼Œå…ˆå…¨éƒ¨æ¸…é›¶ï¼Œè½¯ä»¶å¤ä½ï¼Œè®¾ç½®åˆå§‹å€¼ï¼Œæ—¶é’Ÿæºï¼Œè®¾ç½®æ¨¡å¼ä¸ºrestartæ¨¡å¼å³æ¯”è¾ƒä¸­æ–­åé‡æ–°è®¡æ—¶ã€‚è®¾ç½®åˆ†é¢‘å€¼ï¼Œä½¿å®šæ—¶å™¨é¢‘ç‡ä¸º1Mã€‚è®¾ç½®OCR[0]ä¸º1000000/2å³500msè¿›å…¥ä¸€æ¬¡æ¯”è¾ƒä¸­æ–­ã€‚

  - æ‰“å¼€é€šé“1æ¯”è¾ƒä¸­æ–­ï¼ŒGICä½¿èƒ½ï¼Œæ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œæ‰“å¼€GPT1

  ```c
  /* å»¶æ—¶åˆå§‹åŒ–å‡½æ•° */
  void delay_init(void)
  {
      GPT1->CR = 0;
  
      /* è½¯å¤ä½ï¼Œç½®1å¤ä½ï¼Œç­‰å¾…è‡ªåŠ¨æ¸…é›¶ */
      GPT1->CR = (1 << 15);
      while ((GPT1->CR >> 15) & 0x01);
  
      /**
       * bit1: 1ï¼šåˆå§‹å€¼ä¸º0
       * bit6-8: 1ï¼šæ—¶é’Ÿæºé€‰æ‹©ipg_clk = 66MHz
       * bit9: 0ï¼šrestartæ¨¡å¼
       */
      GPT1->CR |= (1 << 1) | (1 << 6);
  
      /* åˆ†é¢‘è®¾ç½®,0-11ä½è®¾ç½®åˆ†é¢‘å€¼ */
      GPT1->PR = 65;      // 66åˆ†é¢‘
      /* é…ç½®è¾“å‡ºæ¯”è¾ƒé€šé“ */
      GPT1->OCR[0] = 1000000/2;    /* è®¾ç½®ä¸­æ–­å‘¨æœŸä¸º500ms */
  
      /* æ‰“å¼€é€šé“1æ¯”è¾ƒä¸­æ–­ */
      GPT1->IR = 1 << 0;
  
      GIC_EnableIRQ(GPT1_IRQn);
      system_register_irqhandler(GPT1_IRQn, gpt1_irqhandler, NULL);
      GPT1->CR |= (1 << 0);   /* æ‰“å¼€GPT1 */
  }
  
  void gpt1_irqhandler(unsigned int gicciar, void *param)
  {
      static unsigned char state  = 0;
  
      /* åˆ¤æ–­æ˜¯å“ªä¸ªä¸­æ–­ */
      if (GPT1->SR & (1 << 0))
      {
          state = !state;
          led_switch(LED0, state);
      }
  
      /* æ¸…é™¤ä¸­æ–­çŠ¶æ€ */
      GPT1->SR |= (1 << 0);
  }
  ```

  

#### å®éªŒäºŒï¼šé«˜ç²¾åº¦å»¶æ—¶

- å»¶æ—¶åˆå§‹åŒ–å‡½æ•°

  ```c
  /* å»¶æ—¶åˆå§‹åŒ–å‡½æ•° */
  void delay_init(void)
  {
      GPT1->CR = 0;
  
      /* è½¯å¤ä½ï¼Œç½®1å¤ä½ï¼Œç­‰å¾…è‡ªåŠ¨æ¸…é›¶ */
      GPT1->CR = (1 << 15);
      while ((GPT1->CR >> 15) & 0x01);
  
      /**
       * bit1: 1ï¼šåˆå§‹å€¼ä¸º0
       * bit6-8: 1ï¼šæ—¶é’Ÿæºé€‰æ‹©ipg_clk = 66MHz
       * bit9: 0ï¼šrestartæ¨¡å¼
       */
      GPT1->CR |= (1 << 1) | (1 << 6);
  
      /* åˆ†é¢‘è®¾ç½®,0-11ä½è®¾ç½®åˆ†é¢‘å€¼ */
      GPT1->PR = 65;      // 66åˆ†é¢‘
      /* 1Mçš„é¢‘ç‡è®¡1ä¸ªæ•°å°±æ˜¯1us */
      GPT1->OCR[0] = 0xffffffff;
  
      GPT1->CR |= (1 << 0);   /* æ‰“å¼€GPT1 */
  }
  ```

  

- uså»¶æ—¶å‡½æ•°

  ```c
  void delay_us(unsigned int usdelay)
  {
      unsigned long oldcnt, newcnt;
      unsigned long tcntvalue = 0;
  
      oldcnt = GPT1->CNT;
      while (1)
      {
          newcnt = GPT1->CNT;
          if(newcnt != oldcnt)
          {
              if(newcnt > oldcnt)
              {
                  tcntvalue += newcnt - oldcnt;
              }
              else
              {
                  tcntvalue += 0xffffffff - oldcnt + newcnt;
              }
              oldcnt = newcnt;
              if (tcntvalue >= usdelay)
              {
                  break;
              }
          } 
      }
  }
  ```

  

- mså»¶æ—¶å‡½æ•°

```c
void delay_ms(unsigned int msdelay)
{
    unsigned int i = 0;
    for (i = 0; i < msdelay; i++)
    {
        delay_us(1000);
    }    
}
```

- ä¸»å‡½æ•°ä¸­ä½¿ç”¨é«˜ç²¾åº¦å»¶æ—¶å‡½æ•°å®ç°LEDé—ªçƒã€‚

### UART

- ä¸²å£IOåˆå§‹åŒ–å‡½æ•°

- ä¸²å£åˆå§‹åŒ–

  - åˆå§‹åŒ–IO

  - åˆå§‹åŒ–å¤ä½UART1

  - é…ç½®ç›¸å…³å¯„å­˜å™¨

    - UCR1ä¸º0
    - UCR2é…ç½®æ•°æ®ä½ï¼Œå¥‡å¶æ ¡éªŒä½ï¼Œåœæ­¢ä½
    - UCR3çš„bti2å¿…é¡»ä¸º1

  - è®¾ç½®æ³¢ç‰¹ç‡

    Baud Rate = ğ‘…ğ‘’ğ‘“ ğ¹ğ‘Ÿğ‘’ğ‘ / (16 Ã—(ğ‘ˆğµğ‘€ğ‘… + 1) / (ğ‘ˆğµğ¼ğ‘… + 1)) 

  - ä½¿èƒ½ä¸²å£

  ```c
  /**
   * @brief åˆå§‹åŒ–UART
   * @brief æ³¢ç‰¹ç‡å›ºå®š115200
   * @param void:void
   */
  void uart_init(void)
  {
      /* åˆå§‹åŒ–ä¸²å£IO */
      uart_io_init();
  
      /* åˆå§‹åŒ–UART1 */
      uart_disable(UART1);    /* å…³é—­UART1 */
      uart_softreset(UART1);   /* å¤ä½UART1 */
  
      /* é…ç½®UART1 */
      UART1->UCR1 = 0;
  
      /* é…ç½®UART1çš„æ•°æ®ä½ï¼Œå¥‡å¶æ ¡éªŒï¼Œåœæ­¢ä½ç­‰ */
      /* bit1-2å‘é€å’Œæ¥æ”¶çš„ä½¿èƒ½ bit5è®¾ç½®æ•°æ®ä½é•¿åº¦8ä½ bit6ä¸€ä½åœæ­¢ä½ bit14å¿½ç•¥RTSè„š */
      UART1->UCR2 = 0;
      UART1->UCR2 |= (1 << 1) | (1 << 2) | (1 << 5) | (1 << 14);
  
      /* bit2å¿…é¡»ä¸º1 */
      UART1->UCR3 |= (1 << 2);
  
      /* è®¾ç½®æ³¢ç‰¹ç‡ */
      UART1->UFCR &= ~(7 << 7);   /* å¯¹RFDIVè¿›è¡Œæ¸…é›¶ */
      UART1->UFCR = 5 << 7;       /* 1åˆ†é¢‘ï¼Œ80M */
      UART1->UBIR = 71;
      UART1->UBMR = 3124;
      /* ä½¿èƒ½ä¸²å£ */
      uart_enable(UART1);
  }
  
  ```

- æ‰“å¼€ä¸²å£

  ```c
  /**
   * @brief æ‰“å¼€ä¸²å£
   * @param UART_Type
   */
  void uart_enable(UART_Type *base)
  {
      base->UCR1 |= (1 << 0);
  }
  ```

- å…³é—­ä¸²å£

  ```c
  /**
   * @brief å…³é—­ä¸²å£
   * @param UART_Type
   */
  void uart_disable(UART_Type *base)
  {
      base->UCR1 &= ~(1 << 0);
  }
  ```

- å¤ä½ä¸²å£

  ```c
  /**
   * @brief å¤ä½UART
   * @param UART_Type
   */
  void uart_softreset(UART_Type *base)
  {
      base->UCR2 &= ~(1 << 0);
      while((base->UCR2 & 0x01) == 0);
  }
  ```

- å‘é€å­—ç¬¦

  ```c
  void putc(unsigned char c)
  {
      /* åœ¨åˆ¤æ–­ä¸Šæ¬¡æ•°æ®æ˜¯å¦å‘é€å®Œæˆ */
      while (((UART1->USR2 >> 3) & 0x01) == 0); /* æ•°æ®æ˜¯å¦åœ¨å‘é€ä¸­ */
      UART1->UTXD = c;
  }
  ```

- æ¥æ”¶å­—ç¬¦

  ```c
  unsigned char getc(void)
  {
      while ((UART1->USR2 & 0x01) == 0); /* æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶ */
      return UART1->URXD;
  }
  ```

  

- å‘é€å­—ç¬¦ä¸²

  ```c
  /**
   * @brief é€šè¿‡ä¸²å£å‘é€ä¸€ä¸²å­—ç¬¦
   * @param str char *
   */
  void puts(char *str)
  {
      char *p = str;
      while(*p != '\0')
      {
          putc(*p++);
      }
  }
  ```

### printfé…ç½®

- æ·»åŠ å®˜æ–¹çš„æ³¢ç‰¹ç‡è®¡ç®—è®¾ç½®å‡½æ•°

  ```c
  /**
   * @brief        	    : æ³¢ç‰¹ç‡è®¡ç®—å…¬å¼ï¼Œå¯ä»¥ç”¨æ­¤å‡½æ•°è®¡ç®—å‡ºæŒ‡å®šä¸²å£å¯¹åº”çš„UFCRï¼ŒUBIRå’ŒUBMRè¿™ä¸‰ä¸ªå¯„å­˜å™¨çš„å€¼
   * @param base		    : è¦è®¡ç®—çš„ä¸²å£ã€‚
   * @param baudrate	    : è¦ä½¿ç”¨çš„æ³¢ç‰¹ç‡ã€‚
   * @param srcclock_hz	: ä¸²å£æ—¶é’Ÿæºé¢‘ç‡ï¼Œå•ä½Hz
   * @return		: æ— 
   */
  void uart_setbaudrate(UART_Type *base, unsigned int baudrate, unsigned int srcclock_hz)
  ```

  - å‡½æ•°ä¸­ç”¨åˆ°æ•°å­¦åº“ï¼Œç¼–è¯‘æ—¶éœ€è¦æŒ‡å®šè·¯å¾„

    ```makefile
    LIBPATH			:= -lgcc -L /usr/local/arm/gcc-linaro-4.9.4-2017.01-x86_64_arm-linux-gnueabihf/lib/gcc/arm-linux-gnueabihf/4.9.4
    ```

  - ```c
    /* raiseå‡½æ•°é˜²æ­¢ç¼–è¯‘æŠ¥é”™ */
    void raise(int sig_nr)
    {
        
    }
    ```

- æ·»åŠ stdioæ–‡ä»¶

  - ä¿®æ”¹Makefileï¼Œç¼–è¯‘cæ–‡ä»¶æ—¶åŠ å…¥æŒ‡ä»¤-Wa,-mimplicit-it=thumbé¿å…æŠ¥é”™

    ```makefile
    $(COBJS): obj/%.o : %.c
    	$(CC) $(INCLUDE) -Wa,-mimplicit-it=thumb -fno-builtin -c -Wall -nostdlib -O2 -o $@ $<
    ```

- ä¸»å‡½æ•°

  ```c
  while(1){
          printf("è¯·è¾“å…¥ä¸¤ä¸ªæ•´æ•°ï¼Œä½¿ç”¨ç©ºæ ¼éš”å¼€ï¼š");
          scanf("%d %d", &a, &b);
          printf("\r\næ•°æ®%d+%d=%d\r\n", a, b, a+b);
          printf("%dçš„åå…­è¿›åˆ¶ï¼š%#x\r\n", c);
      }
  ```

  

### DDR3

DDR3ï¼ˆDouble Data Rate 3ï¼‰æ˜¯ç¬¬ä¸‰ä»£åŒå€æ•°æ®ç‡åŒæ­¥åŠ¨æ€éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆSDRAMï¼‰ï¼Œå¹¿æ³›åº”ç”¨äºè®¡ç®—æœºã€æœåŠ¡å™¨å’ŒåµŒå…¥å¼ç³»ç»Ÿä¸­ã€‚ç›¸æ¯”å…¶å‰ä»£ DDR2ï¼ŒDDR3 åœ¨é€Ÿåº¦ã€å¸¦å®½å’Œèƒ½æ•ˆæ–¹é¢éƒ½æœ‰æ˜¾è‘—æå‡ã€‚ä»¥ä¸‹æ˜¯ DDR3 çš„åŸºæœ¬åŸç†å’Œä¸€äº›é‡è¦å‚æ•°çš„ä»‹ç»ã€‚

#### DDR3 çš„å·¥ä½œåŸç†

##### 1. **åŒå€æ•°æ®ç‡ï¼ˆDouble Data Rateï¼‰**:

- DDR3 çš„æ ¸å¿ƒç‰¹ç‚¹æ˜¯åŒå€æ•°æ®ç‡ï¼Œå³åœ¨æ—¶é’Ÿä¿¡å·çš„ä¸Šå‡æ²¿å’Œä¸‹é™æ²¿éƒ½ä¼ è¾“æ•°æ®ã€‚è¿™æ ·ï¼Œåœ¨ç›¸åŒçš„æ—¶é’Ÿé¢‘ç‡ä¸‹ï¼ŒDDR3 å¯ä»¥å®ç°æ¯”ä¼ ç»Ÿ SDRAM æ›´é«˜çš„æ•°æ®ä¼ è¾“é€Ÿç‡ã€‚

##### 2. **å†…éƒ¨ç»“æ„**:

- DDR3 å†…éƒ¨é‡‡ç”¨ 8n é¢„å–æ¶æ„ã€‚æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸ DDR3 å¯ä»¥ä»å†…å­˜é˜µåˆ—ä¸­é¢„å– 8 ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œå¹¶åœ¨ 4 ä¸ªæ—¶é’Ÿå‘¨æœŸå†…åˆ† 2 æ¬¡è¾“å‡ºè¿™äº›æ•°æ®ã€‚è¿™ç§æ¶æ„æœ‰åŠ©äºåœ¨æ›´é«˜é¢‘ç‡ä¸‹ç¨³å®šå·¥ä½œã€‚

##### 3. **æ—¶é’Ÿå’Œæ—¶åº**:

- DDR3 ä½¿ç”¨å·®åˆ†æ—¶é’Ÿï¼ˆDifferential Clockï¼ŒCK å’Œ CK#ï¼‰ä¿¡å·æ¥åŒæ­¥å†…å­˜æ“ä½œã€‚æ—¶åºå‚æ•°ï¼ˆå¦‚ CLã€tRCDã€tRP ç­‰ï¼‰å†³å®šäº† DDR3 å†…å­˜æ¨¡å—åœ¨ç‰¹å®šæ“ä½œä¸‹çš„å»¶è¿Ÿå’Œæ€§èƒ½ã€‚

##### 4. **ä½ç”µå‹**:

- DDR3 è¿è¡Œç”µå‹ä¸º 1.5Vï¼Œæ¯” DDR2 çš„ 1.8V æ›´ä½ï¼Œè¿™æœ‰åŠ©äºé™ä½åŠŸè€—ï¼Œå°¤å…¶æ˜¯åœ¨å¤§å‹æœåŠ¡å™¨å’Œæ•°æ®ä¸­å¿ƒç¯å¢ƒä¸­ã€‚

#### DDR3 çš„é‡è¦å‚æ•°

##### 1. **æ•°æ®é€Ÿç‡**:

- DDR3 çš„æ•°æ®ä¼ è¾“é€Ÿç‡ä» 800 MT/sï¼ˆMega Transfers per secondï¼‰åˆ° 2133 MT/s ä¸ç­‰ï¼Œå¸¸è§çš„é€Ÿç‡æœ‰ DDR3-800ã€DDR3-1066ã€DDR3-1333ã€DDR3-1600ã€DDR3-1866 å’Œ DDR3-2133ã€‚

##### 2. **æ—¶é’Ÿé¢‘ç‡**:

- DDR3 çš„å®é™…æ—¶é’Ÿé¢‘ç‡ï¼ˆå†…æ ¸æ—¶é’Ÿï¼‰ä» 400 MHz åˆ° 1066 MHzï¼Œä½†ç”±äºåŒå€æ•°æ®ç‡æŠ€æœ¯ï¼Œå…¶æ•°æ®ä¼ è¾“é€Ÿç‡æ˜¯æ—¶é’Ÿé¢‘ç‡çš„ä¸¤å€ã€‚

##### 3. **å¸¦å®½**:

- å¸¦å®½å–å†³äºå†…å­˜æ¨¡å—çš„ä½å®½å’Œæ•°æ®é€Ÿç‡ã€‚DDR3 çš„å¸¦å®½è®¡ç®—å…¬å¼ä¸ºï¼š`å¸¦å®½ = æ•°æ®é€Ÿç‡ Ã— ä½å®½ Ã· 8`ã€‚ä¾‹å¦‚ï¼ŒDDR3-1600 çš„å•é€šé“å¸¦å®½ä¸º `1600 Ã— 64 Ã· 8 = 12.8 GB/s`ã€‚

##### 4. **æ—¶åºï¼ˆLatencyï¼‰**:

- æ—¶åºæ˜¯æŒ‡å†…å­˜æ¨¡å—åœ¨æ‰§è¡Œä¸åŒæ“ä½œæ—¶çš„å»¶è¿Ÿï¼Œé€šå¸¸ä»¥ä¸€ç³»åˆ—å‚æ•°è¡¨ç¤ºï¼Œå¦‚ CLï¼ˆCAS Latencyï¼‰ã€tRCDï¼ˆRow to Column Delayï¼‰ã€tRPï¼ˆRow Precharge Timeï¼‰ã€tRASï¼ˆRow Active Timeï¼‰ã€‚è¿™äº›å‚æ•°ç›´æ¥å½±å“å†…å­˜çš„è®¿é—®é€Ÿåº¦ã€‚
- ä¾‹å¦‚ï¼ŒDDR3-1600 CL9 çš„æ—¶åºå¯èƒ½æ ‡è®°ä¸º `9-9-9-24`ï¼Œæ„å‘³ç€ CAS Latency ä¸º 9 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒtRCD ä¸º 9 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒtRP ä¸º 9 ä¸ªæ—¶é’Ÿå‘¨æœŸï¼ŒtRAS ä¸º 24 ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚

##### 5. **å®¹é‡**:

- DDR3 å†…å­˜æ¨¡å—çš„å®¹é‡é€šå¸¸ä» 512 MB åˆ° 32 GB ä¸ç­‰ï¼Œå…·ä½“å–å†³äºå†…å­˜èŠ¯ç‰‡çš„å¯†åº¦å’Œæ¨¡å—è®¾è®¡ï¼ˆå¦‚å•é€šé“ã€åŒé€šé“æˆ–å¤šé€šé“é…ç½®ï¼‰ã€‚

##### 6. **ç”µå‹**:

- DDR3 æ ‡å‡†ç”µå‹ä¸º 1.5Vï¼Œä½ç”µå‹ç‰ˆæœ¬ DDR3L çš„ç”µå‹ä¸º 1.35Vï¼Œè¶…ä½ç”µå‹ç‰ˆæœ¬ DDR3U çš„ç”µå‹ä¸º 1.25Vã€‚è¿™äº›ä½ç”µå‹ç‰ˆæœ¬æ—¨åœ¨è¿›ä¸€æ­¥é™ä½åŠŸè€—ã€‚

##### 7. **é¢„å–é•¿åº¦**:

- DDR3 çš„é¢„å–é•¿åº¦ä¸º 8nï¼Œæ„å‘³ç€æ¯æ¬¡å†…å­˜è®¿é—®å¯ä»¥é¢„å– 8 ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚è¿™æ˜¯ DDR3 ç›¸æ¯”äº DDR2 æé«˜æ•°æ®å¸¦å®½çš„é‡è¦æŠ€æœ¯æ‰‹æ®µã€‚

##### 8. **æ¨¡å—ç±»å‹**:

- DDR3 å†…å­˜æ¨¡å—åŒ…æ‹¬å¸¸è§çš„ UDIMMï¼ˆUnbuffered DIMMï¼‰ã€RDIMMï¼ˆRegistered DIMMï¼‰ã€SO-DIMMï¼ˆç”¨äºç¬”è®°æœ¬ç”µè„‘çš„å°å‹ DIMMï¼‰ç­‰ã€‚RDIMM å¸¦æœ‰å¯„å­˜å™¨ï¼Œç”¨äºç¨³å®šä¿¡å·ï¼Œé€‚åˆç”¨äºæœåŠ¡å™¨ã€‚

#### DDR3 ç›¸æ¯” DDR2 å’Œ DDR4 çš„ä¼˜åŠ¿

- **ç›¸æ¯” DDR2**:
  - æ›´é«˜çš„å¸¦å®½ï¼šDDR3 çš„æ•°æ®é€Ÿç‡è¿œé«˜äº DDR2ï¼Œå¸¦å®½ç›¸åº”å¢åŠ ã€‚
  - æ›´ä½çš„åŠŸè€—ï¼šDDR3 çš„å·¥ä½œç”µå‹æ¯” DDR2 ä½ï¼Œé™ä½äº†èƒ½è€—ã€‚
  - æ›´å¤§çš„å®¹é‡ï¼šDDR3 æ”¯æŒæ›´é«˜å¯†åº¦çš„å†…å­˜èŠ¯ç‰‡ï¼Œä½¿å¾—å•ä¸ªæ¨¡å—çš„å®¹é‡æ›´å¤§ã€‚
- **ç›¸æ¯” DDR4**:
  - DDR4 è¿›ä¸€æ­¥æå‡äº†æ•°æ®é€Ÿç‡ã€é™ä½äº†ç”µå‹ï¼Œå¹¶å¼•å…¥äº†æ›´å¤šå…ˆè¿›åŠŸèƒ½ï¼ˆå¦‚ Bank Group æŠ€æœ¯ï¼‰ï¼Œä½† DDR3 ä¾ç„¶åœ¨æˆæœ¬æ•æ„Ÿçš„åº”ç”¨ä¸­å¹¿æ³›ä½¿ç”¨ã€‚

#### æ€»ç»“

DDR3 æ˜¯ä¸€ç§æ€§èƒ½å¼ºå¤§ä¸”åº”ç”¨å¹¿æ³›çš„å†…å­˜æŠ€æœ¯ï¼Œå‡­å€Ÿå…¶é«˜å¸¦å®½ã€ä½åŠŸè€—å’Œå¤§å®¹é‡ï¼Œæˆä¸ºäº†è®¸å¤šè®¡ç®—æœºç³»ç»Ÿçš„ä¸»æµé€‰æ‹©ã€‚ç†è§£ DDR3 çš„å·¥ä½œåŸç†å’Œé‡è¦å‚æ•°ï¼Œæœ‰åŠ©äºåœ¨ç³»ç»Ÿè®¾è®¡å’Œä¼˜åŒ–ä¸­åšå‡ºæ›´æ˜æ™ºçš„å†³ç­–ã€‚

### LCD

- è¯»å±å¹•ID

  - æ‰“å¼€æ¨¡æ‹Ÿå¼€å…³ï¼Œè®¾ç½®GPIOï¼ˆå¼•è„šå¤ç”¨å†²çªè§£å†³ï¼‰

    ```c
     /* æ‰“å¼€æ¨¡æ‹Ÿå¼€å…³ï¼Œè®¾ç½®LCD_VSYNCä¸ºé«˜ç”µå¹³ */
        gpio_pin_config_t lcdio_config;
        IOMUXC_SetPinMux(IOMUXC_LCD_VSYNC_GPIO3_IO03, 0);
        IOMUXC_SetPinConfig(IOMUXC_LCD_VSYNC_GPIO3_IO03,0x10b0);
    
        /* GPIOåˆå§‹åŒ– */
        lcdio_config.direction = kGPIO_DigitalOutput;
        lcdio_config.outputLogic = 1;
        gpio_init(GPIO3, 3, &lcdio_config);
    ```

    

  - å°†3ä¸ªIDå£å¤ç”¨ä¸ºGPIOè¾“å…¥æ¨¡å¼

    ```c
     /* è¯»å–IDå€¼ï¼Œè®¾ç½®G7 B7 R7ä¸ºè¾“å…¥ */
    	IOMUXC_SetPinMux(IOMUXC_LCD_DATA07_GPIO3_IO12, 0);		/* B7(M2) */
    	IOMUXC_SetPinMux(IOMUXC_LCD_DATA15_GPIO3_IO20, 0);		/* G7(M1) */
    	IOMUXC_SetPinMux(IOMUXC_LCD_DATA23_GPIO3_IO28, 0);		/* R7(M0) */
    
        IOMUXC_SetPinConfig(IOMUXC_LCD_DATA07_GPIO3_IO12, 0xF080);
    	IOMUXC_SetPinConfig(IOMUXC_LCD_DATA15_GPIO3_IO20, 0xF080);
    	IOMUXC_SetPinConfig(IOMUXC_LCD_DATA23_GPIO3_IO28, 0xF080);
    
        lcdio_config.direction = kGPIO_DigitalInput;
    	gpio_init(GPIO3, 12, &lcdio_config);
    	gpio_init(GPIO3, 20, &lcdio_config);
    	gpio_init(GPIO3, 28, &lcdio_config);
    ```

  - returnå±å¹•ID
  - ä½¿ç”¨ä¸²å£åˆå§‹å±å¹•ID

- åˆå§‹åŒ–å±å¹•IO

  - é…ç½®24ä¸ªæ•°æ®å¼•è„š

  - 4ä¸ªåŠŸèƒ½å¼•è„šï¼ˆLCDIFæ§åˆ¶å™¨ï¼Œä¸ç”¨ä½œGPIOæ‰€ä»¥ä¸ç”¨åˆå§‹æ¢GPIOï¼‰

  - ç‚¹äº®èƒŒå…‰ï¼ˆGPIOï¼‰

  - å¤ä½10ms

    ```c
    /* åˆå§‹åŒ–å±å¹•IO */
    	lcdgpio_init();
    	lcd_reset();
    	delay_ms(10);
    	lcd_noreset();
    ```

- æ ¹æ®ä¸åŒçš„å±å¹•IDæ¥è®¾ç½®å±å¹•å‚æ•°

  ```c
  if(lcdid == ATK7016) {
  		tftlcd_dev.height = 600;	
  		tftlcd_dev.width = 1024;
  		tftlcd_dev.vspw = 3;
  		tftlcd_dev.vbpd = 20;
  		tftlcd_dev.vfpd = 12;
  		tftlcd_dev.hspw = 20;
  		tftlcd_dev.hbpd = 140;
  		tftlcd_dev.hfpd = 160;
  		lcdclk_init(32, 3, 5);	/* åˆå§‹åŒ–LCDæ—¶é’Ÿ 51.2MHz */
  	}
  ```

- è®¾ç½®å…¬å…±å±å¹•å‚æ•°

  ```c
  tftlcd_dev.pixsize = 4;	/* æ¯ä¸ªåƒç´ 4ä¸ªå­—èŠ‚ */
  	tftlcd_dev.framebuffer = LCD_FRAMEBUF_ADDR;
  	tftlcd_dev.forecolor = LCD_RED;
  	tftlcd_dev.backcolor = LCD_BLACK;
  ```

- é…ç½®LCDIFæ§åˆ¶å™¨ç›¸å…³å¯„å­˜å™¨ 

- ä½¿èƒ½ï¼Œæ¸…å±

  ```c
  lcd_enable();			/* ä½¿èƒ½LCD */
  
  delay_ms(20);
  lcd_clear(LCD_WHITE);
  ```

- æ—¶é’Ÿé…ç½®å‡½æ•°

  ```c
  void lcdclk_init(unsigned char loopDiv, unsigned char prediv, unsigned char div)
  {
  	/* ä¸ä½¿ç”¨å°æ•°åˆ†é¢‘å™¨ */
  	CCM_ANALOG->PLL_VIDEO_NUM = 0;
  	CCM_ANALOG->PLL_VIDEO_DENOM = 0;
  
  	/*
       * PLL_VIDEOå¯„å­˜å™¨è®¾ç½®
       * bit[13]:    1   ä½¿èƒ½VIDEO PLLæ—¶é’Ÿ
       * bit[20:19]  2  è®¾ç½®postDividerä¸º1åˆ†é¢‘
       * bit[6:0] : 32  è®¾ç½®loopDividerå¯„å­˜å™¨
  	 */
  	CCM_ANALOG->PLL_VIDEO =  (2 << 19) | (1 << 13) | (loopDiv << 0); 
  
  	/*
       * MISC2å¯„å­˜å™¨è®¾ç½®
       * bit[31:30]: 0  VIDEOçš„post-divè®¾ç½®ï¼Œæ—¶é’Ÿæºæ¥æºäºpostDividerï¼Œ1åˆ†é¢‘
  	 */
  	CCM_ANALOG->MISC2 &= ~(3 << 30);
  
  	/* LCDæ—¶é’Ÿæºæ¥æºä¸PLL5ï¼Œä¹Ÿå°±æ˜¯VIDEO           PLL  */
  	CCM->CSCDR2 &= ~(7 << 15);  	
  	CCM->CSCDR2 |= (2 << 15);			/* è®¾ç½®LCDIF_PRE_CLKä½¿ç”¨PLL5 */
  
  	/* è®¾ç½®LCDIF_PREåˆ†é¢‘ */
  	CCM->CSCDR2 &= ~(7 << 12);		
  	CCM->CSCDR2 |= (prediv - 1) << 12;	/* è®¾ç½®åˆ†é¢‘  */
  
  	/* è®¾ç½®LCDIFåˆ†é¢‘ */
  	CCM->CBCMR &= ~(7 << 23);					
  	CCM->CBCMR |= (div - 1) << 23;		
  
  	/* è®¾ç½®LCDæ—¶é’Ÿæºä¸ºLCDIF_PREæ—¶é’Ÿ */
  	CCM->CSCDR2 &= ~(7 << 9);					/* æ¸…é™¤åŸæ¥çš„è®¾ç½®		 	*/
  	CCM->CSCDR2 |= (0 << 9);					/* LCDIF_PREæ—¶é’Ÿæºé€‰æ‹©LCDIF_PREæ—¶é’Ÿ */
  }
  ```

- åŠŸèƒ½å‡½æ•°
  - ç”»ç‚¹å‡½æ•°
  - è¯»ç‚¹å‡½æ•°
  - æ¸…å±å‡½æ•°
  - çŸ©å½¢å¡«å……å‡½æ•°

### RTC

- æ—¶é—´ç›¸å…³çš„å®å®šä¹‰ï¼Œæ—¶é—´ç›¸å…³çš„ç»“æ„ä½“

  ```c
  /* è·Ÿæ—¶é—´æœ‰å…³çš„å®å®šä¹‰ */
  #define SECONDS_IN_A_DAY    (86400)
  #define SECONDS_IN_A_HOUR   (3600)
  #define SECONDS_IN_A_MINUTE (60)
  #define DAYS_IN_A_YEAR      (365)
  #define YEAR_RANGE_START    (1970)
  #define YEAR_RANGE_END      (2099)
  
  /* è·Ÿæ—¶é—´æœ‰å…³çš„ç»“æ„ä½“ */
  struct rtc_datetime{
  unsigned short  year;
  unsigned char   month;
  unsigned char   day;
  unsigned char   hour;
  unsigned char   minute;
  unsigned char   second;
  };
  ```

- RTCåˆå§‹åŒ–å‡½æ•°

  - å¼€å¯ä¿¡ä»»æ¨¡å¼

  - ä½¿èƒ½RTC

    ```c
    void rtc_init(void)
    {
        struct rtc_datetime rtcDate;
        SNVS->HPCOMR |= (1 << 31) | (1 << 8);
    #if 0
        rtcDate.year    = 2024;
        rtcDate.month   = 8;
        rtcDate.day     = 14;
        rtcDate.hour    = 23;
        rtcDate.minute  = 32;
        rtcDate.second  = 36;
    #endif
        rtc_setdatetime(&rtcDate);
    
        /* å¼€å¯RTC */
        rtc_enable();
    }
    ```

- åŠŸèƒ½å‡½æ•°
  - ä½¿èƒ½RTC
  - å…³é—­RTC
  - **æ—¶é—´è½¬åŒ–ä¸ºç§’æ•°**
  - **è®¾ç½®æ—¶é—´**
  - å¾—åˆ°ç§’æ•°ï¼ˆè¯»å¯„å­˜å™¨ï¼‰
  - ç§’æ•°è½¬åŒ–ä¸ºæ—¶é—´
  - **è·å–æ—¶é—´ï¼ˆå¾—åˆ°ç§’æ•°ï¼Œè½¬åŒ–æ—¶é—´ï¼Œä¼ å…¥æ—¶é—´ç»“æ„ä½“åœ°å€ï¼‰**
  - åˆ¤æ–­é—°å¹´

### IIC

SCLå’ŒSDAéœ€è¦æ¥ä¸Šæ‹‰ç”µé˜»ä¸€èˆ¬4.7Kï¼Œ3.3Vã€‚

I2Cæ€»çº¿æ”¯æŒå¤šä»æœºï¼Œé€šè¿‡ä»æœºåœ°å€å¼€åŒºåˆ†è®¿é—®å“ªä¸ªä»æœº

IICå†™æ—¶åº

![my image](D:\users\wsy\Desktop\document\prinscr\Snipaste_2024-08-21_22-33-14.png)

IICè¯»æ—¶åº

![my image](D:\users\wsy\Desktop\document\prinscr\Snipaste_2024-08-21_22-40-33.png)

å†™æ—¶åºæœ‰ä¸‰éƒ¨åˆ†ï¼Œè¯»æ—¶åºæœ‰å››éƒ¨åˆ†ï¼Œæ¯”å†™å¤šä¸€éƒ¨åˆ†ã€‚åˆ†åˆ«å†™å››ä¸ªå‡½æ•°ä»¥å®ç°å››éƒ¨åˆ†å†…å®¹

#### IICé©±åŠ¨

- åˆå§‹åŒ–IIC

  ```c
  void i2c_init(I2C_Type *base)
  {
      base->I2CR &= ~(1 << 7);        /* å…³é—­I2C */
      base->IFDR = 0x15;              /* 640åˆ†é¢‘ 103.125KHz*/
      base->I2CR |= (1 <<7);          /* æ‰“å¼€I2C */
  }
  ```

- ä¸»æœº

  - startå‡½æ•°

    ä½¿ç”¨å“ªä¸ªIICï¼Œè®¾å¤‡åœ°å€ï¼Œå†™æ–¹å‘

    å¼€å§‹ä½¿ç”¨IICæ—¶åˆ¤æ–­IICæ˜¯å¦åœ¨å¿™

    è®¾ç½®ä¸ºä¸»æœºå‘é€

    å¯„å­˜å™¨ä¸­å†™å…¥åœ°å€ï¼Œè‡ªåŠ¨äº§ç”Ÿstartä¿¡å·

    ```c
    unsigned int i2c_master_start(I2C_Type *base, unsigned char address, enum i2c_direction direction)
    {
        if (base->I2SR & (1 << 5))  /* I2Cå¿™ */
            return 1;
        
        /* è®¾ç½®ä¸ºä¸»æœºæ¨¡å¼1å·¦ç§»5è®¾ç½®ä¸ºä¸»æœºï¼Œ1å·¦ç§»4è®¾ç½®ä¸ºå‘é€ */
        base->I2CR |= (1 << 5) | (1 << 4);
        
        /* äº§ç”Ÿstartï¼Œå‘é€ä»æœºåœ°å€æ—¶ï¼ˆI2C_I2DRå¯„å­˜å™¨ä¸­å†™å…¥ä»æœºåœ°å€ï¼‰ï¼Œstartä¿¡å·å°±ä¼šåŒæ­¥äº§ç”Ÿï¼Œä¸ç”¨æ‰‹åŠ¨è®¾ç½® */
        base->I2DR = ((unsigned int)address << 1) | (direction == kI2C_Read ? 1 : 0);        /* é«˜7ä½æ˜¯åœ°å€ï¼Œæœ€ä½ä½æ˜¯è¯»å†™ï¼Œæ‰€ä»¥è¦å·¦ç§»ä¸€ä½ */
    
        return 0;
    }
    ```

  - stopå‡½æ•°

    åœæ­¢å“ªä¸ªIIC

    å¯„å­˜å™¨æ¸…é›¶åœæ­¢IIC

    ç­‰å¾…IICå·¥ä½œå®Œæˆåreturn OK

    ```c
    unsigned char i2c_master_stop(I2C_Type *base)
    {
        unsigned short timeout = 0xffff;    /* è¶…æ—¶æ—¶é—´ */
    
        /* æ¸…é™¤i2cçš„bit5:3
         * 5æ¸…é›¶ä»æ¨¡å¼
         * 4æ¸…é›¶æ¥æ”¶æ¨¡å¼
         * 3æ¸…é›¶ï¼Œåœ¨æ¥æ”¶åˆ°ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ååœ¨ç¬¬ä¹ä¸ªæ—¶é’Ÿä½å‘æ€»çº¿å‘é€ç¡®è®¤ä¿¡å·ï¼Œè¿™ä¸ªä½ä»…ä»…åœ¨æ¥æ”¶æ¨¡å¼ä¸‹å†™1
         */
        base->I2CR &= ~(0x7 << 3);
    
        /* ç­‰å¾…i2cå¿™ç»“æŸ */
        while(base->I2SR & (1 << 5))
        {
            timeout--;
            if(timeout == 0)    /* è¶…æ—¶è·³å‡º */
                return I2C_STATUS_TIMEOUT;
        }
        return I2C_STATUS_OK;
    }
    ```

  - repeated startå‡½æ•°

    åˆ¤æ–­æ˜¯å¦å¿™ç¢Œæˆ–è€…å·¥ä½œåœ¨ä»æœºæ¨¡å¼

    è®¾ç½®å‘é€äº§ç”Ÿrestart

    å‘é€åœ°å€ä»¥åŠè¯»æ–¹å‘ï¼Œreturn OK

    ```c
    unsigned int i2c_master_repeated_start(I2C_Type *base, unsigned char address, enum i2c_direction direction)
    {
        /* I2Cæ˜¯å¦å¿™æˆ–è€…å·¥ä½œåœ¨ä»æœºæ¨¡å¼ä¸‹ï¼Œå› ä¸ºrestartä¿¡å·æ˜¯åœ¨ä¿¡å·ä¼ è¾“ä¸­è¿›è¡Œçš„ï¼Œæ‰€ä»¥è¦æ£€æŸ¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯å¦è¢«è®¾ç½®æˆäº†ä»æœºæ¨¡å¼ */
        if((base->I2SR & (1 << 5)) && (base->I2CR & (1 << 5)))
            return 1;
        /* 1<<4ä¸ºå‘é€ï¼Œ1<<2ä¸ºäº§ç”Ÿrestartä¿¡å· */
        base->I2CR |= (1 << 4) | (1 << 2);
        base->I2DR = ((unsigned int)address << 1) | (direction == kI2C_Read ? 1 : 0);        /* é«˜7ä½æ˜¯åœ°å€ï¼Œæœ€ä½ä½æ˜¯è¯»å†™ï¼Œæ‰€ä»¥è¦å·¦ç§»ä¸€ä½ */
        return I2C_STATUS_OK;
    }
    ```

  - é”™è¯¯æ£€æŸ¥å‡½æ•°

    ```c
    unsigned char i2c_check_and_clear_error(I2C_Type *base, unsigned int status)
    {
        /* å…ˆæ£€æŸ¥æ˜¯å¦ä¸ºä»²è£ä¸¢å¤±é”™è¯¯ */
        if(base->I2SR & (1 << 4)) {
            base->I2SR &= ~(1 << 4);
            base->I2CR &= ~(1 << 7);
            base->I2CR |= (1 << 7);
            return I2C_STATUS_ARBITRATION_LOST;
        }
        else if(base->I2SR & (1 << 0)) {    // æ£€æµ‹åˆ°NOACKä¿¡å·
            return I2C_STATUS_NAK;
        }
        return I2C_STATUS_OK;
    }
    ```

  - writeå‡½æ•°

    ä¸­é—´è¿‡ç¨‹ï¼Œç­‰å¾…ä¼ è¾“å®Œæˆè€Œæ˜¯æ£€æµ‹æ˜¯å¦å¤„äºå¿™ç¢Œ

    æ¸…é™¤ä¸­æ–­ï¼Œè®¾ç½®å‘é€

    whileå‡½æ•°å°†è¦å†™å…¥çš„æ•°æ®ä¾æ¬¡ç»™I2DRå¯„å­˜å™¨ï¼Œæ¯ä¸€æ¬¡è¾“å…¥è¦åˆ¤æ–­SRå¯„å­˜å™¨æ˜¯å¦å½“å‰å­—èŠ‚æ•°æ®æ˜¯å¦ä¼ è¾“å®Œæˆï¼Œç„¶åæ‰å¼€å§‹ä¸‹ä¸€ä¸ªæ•°æ®çš„ä¼ è¾“ã€‚

    æ£€æŸ¥æ˜¯å¦æœ‰ä¼ è¾“é”™è¯¯

    æ¸…é™¤æ ‡å¿—ä½ï¼Œåœæ­¢ä¼ è¾“

    ```c
    void i2c_master_write(I2C_Type *base, const unsigned char *buf, unsigned int size)
    {
        /* ç­‰å¾…ä¼ è¾“å®Œæˆ */
        while(!(base->I2SR & (1 << 7)));
    
        base->I2SR &= ~(1 << 1);            /* æ¸…é™¤ä¸­æ–­ */
        base->I2CR |= (1 << 4);             /* è®¾ç½®ä¸ºå‘é€ */
    
        while (size--)
        {
            base->I2DR = *buf++;            /* å°†è¦å‘é€çš„æ•°æ®å†™å…¥I2DR */
            while(!(base->I2SR & (1 << 1)));    /* ç­‰å¾…ä¼ è¾“å®Œæˆ */
            
            /* æ£€æŸ¥ACK */
            if(i2c_check_and_clear_error(base, base->I2SR))
                break;  // æ£€æµ‹åˆ°æœ‰é”™è¯¯å‘ç”Ÿä¸­æ–­å‘é€
        }
        base->I2SR &= ~(1 << 1);
        i2c_master_stop(base);
    }
    ```

  - readå‡½æ•°

    ç­‰å¾…ä¼ è¾“å®Œæˆ

    æ¸…é™¤æ ‡å¿—ä½ï¼Œè®¾ç½®æ¥æ”¶

    ```c
    void i2c_master_read(I2C_Type *base, unsigned char *buf, unsigned int size)
    {
        volatile uint8_t dummy = 0;     /* å‡è¯» */
        dummy++;                        /* é˜²æ­¢ç¼–è¯‘æŠ¥é”™ */
        /* ç­‰å¾…ä¼ è¾“å®Œæˆ */
        while(!(base->I2SR & (1 << 7)));
    
        base->I2SR &= ~(1 << 1);            /* æ¸…é™¤ä¸­æ–­ */
        base->I2CR &= ~((1 << 4) | (1 << 3));
    
        /* å½“æœ‰å¤šä¸ªæ•°æ®çš„æ—¶å€™ï¼Œè¯»å€’æ•°ç¬¬äºŒä¸ªæ•°æ®çš„æ—¶å€™ä¸»æœºå‘ä»æœºå‘é€NACKä¿¡å·ï¼Œå½“åªæœ‰ä¸€ä¸ªæ•°æ®çš„æ—¶å€™ä¸»æœºç›´æ¥å‘ä»æœºå‘é€NACK */
        if (size == 1)
        {
            base->I2CR |= (1 << 3);                 /* NACK */
        }
    
        while(size--) {
            while(!(base->I2SR & (1 << 1)));        /* ç­‰å¾…æ•°æ®ä¼ è¾“å®Œæˆ */
            base->I2SR &= ~(1 << 1);
    
            if (size == 0)                          /* æ•°æ®å‘é€å®Œæˆ */
            {
                i2c_master_stop(base);
            }
            if (size == 1)
            {
                base->I2CR |= (1 << 3);             /* NACK */
            }
            
            *buf++ = base->I2DR;
        }
    }
    ```

  - ä¼ è¾“å‡½æ•°

    ```c
    unsigned char i2c_master_transfer(I2C_Type *base, struct i2c_transfer *xfer)
    {
    	unsigned char ret = 0;
    	enum i2c_direction direction = xfer->direction;	
    
    	base->I2SR &= ~((1 << 1) | (1 << 4));			/* æ¸…é™¤æ ‡å¿—ä½ */
    
    	/* ç­‰å¾…ä¼ è¾“å®Œæˆ */
    	while(!((base->I2SR >> 7) & 0X1)){};
    
    	/* å¦‚æœæ˜¯è¯»çš„è¯ï¼Œè¦å…ˆå‘é€å¯„å­˜å™¨åœ°å€ï¼Œæ‰€ä»¥è¦å…ˆå°†æ–¹å‘æ”¹ä¸ºå†™ */
        if ((xfer->subaddressSize > 0) && (xfer->direction == kI2C_Read))
        {
            direction = kI2C_Write;
        }
    
    	ret = i2c_master_start(base, xfer->slaveAddress, direction); /* å‘é€å¼€å§‹ä¿¡å· */
        if(ret)
        {	
    		return ret;
    	}
    
    	while(!(base->I2SR & (1 << 1))){};			/* ç­‰å¾…ä¼ è¾“å®Œæˆ */
    
        ret = i2c_check_and_clear_error(base, base->I2SR);	/* æ£€æŸ¥æ˜¯å¦å‡ºç°ä¼ è¾“é”™è¯¯ */
        if(ret)
        {
          	i2c_master_stop(base); 						/* å‘é€å‡ºé”™ï¼Œå‘é€åœæ­¢ä¿¡å· */
            return ret;
        }
    	
        /* å‘é€å¯„å­˜å™¨åœ°å€ */
        if(xfer->subaddressSize)
        {
            do
            {
    			base->I2SR &= ~(1 << 1);			/* æ¸…é™¤æ ‡å¿—ä½ */
                xfer->subaddressSize--;				/* åœ°å€é•¿åº¦å‡ä¸€ */
    			
                base->I2DR =  ((xfer->subaddress) >> (8 * xfer->subaddressSize)); //å‘I2DRå¯„å­˜å™¨å†™å…¥å­åœ°å€
      
    			while(!(base->I2SR & (1 << 1)));  	/* ç­‰å¾…ä¼ è¾“å®Œæˆ */
    
                /* æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿ */
                ret = i2c_check_and_clear_error(base, base->I2SR);
                if(ret)
                {
                 	i2c_master_stop(base); 				/* å‘é€åœæ­¢ä¿¡å· */
                 	return ret;
                }  
            } while ((xfer->subaddressSize > 0) && (ret == I2C_STATUS_OK));
    
            if(xfer->direction == kI2C_Read) 		/* è¯»å–æ•°æ® */
            {
                base->I2SR &= ~(1 << 1);			/* æ¸…é™¤ä¸­æ–­æŒ‚èµ·ä½ */
                i2c_master_repeated_start(base, xfer->slaveAddress, kI2C_Read); /* å‘é€é‡å¤å¼€å§‹ä¿¡å·å’Œä»æœºåœ°å€ */
        		while(!(base->I2SR & (1 << 1))){};/* ç­‰å¾…ä¼ è¾“å®Œæˆ */
    
                /* æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯å‘ç”Ÿ */
    			ret = i2c_check_and_clear_error(base, base->I2SR);
                if(ret)
                {
                 	ret = I2C_STATUS_ADDRNAK;
                    i2c_master_stop(base); 		/* å‘é€åœæ­¢ä¿¡å· */
                    return ret;  
                }
            }
        }
    
        /* å‘é€æ•°æ® */
        if ((xfer->direction == kI2C_Write) && (xfer->dataSize > 0))
        {
        	i2c_master_write(base, xfer->data, xfer->dataSize);
    	}
    
        /* è¯»å–æ•°æ® */
        if ((xfer->direction == kI2C_Read) && (xfer->dataSize > 0))
        {
           	i2c_master_read(base, xfer->data, xfer->dataSize);
    	}
    	return 0;	
    }
    ```

    

